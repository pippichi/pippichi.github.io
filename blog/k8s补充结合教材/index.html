<!DOCTYPE html>
<html>
  <head>
    
    
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-12345678-0', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

    
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>
      
  K8S 1.18版本 &ndash; Learning Records

    </title>
    
    <meta content="K8S" name="keywords">
    
    
    <meta name="description" property="og:description" content="k8s 1.18版本学习笔记，总结了尚硅古2020年k8s教程视频的内容
|Just for record">
    

    <meta name="apple-mobile-web-app-title" content="Learning Records">
    
    
    
    
    <meta name="twitter:card" content="summary">
    <meta name="twitter:site" content="@">
    <meta name="twitter:creator" content="@">
    <meta name="twitter:title" content="K8S 1.18版本 | Learning Records">
    <meta name="twitter:description" content="k8s 1.18版本学习笔记，总结了尚硅古2020年k8s教程视频的内容|Just for record">
    <meta name="twitter:image" content="https://pippichi.github.iotwitter-card.png">
    


    <link rel="stylesheet" href="/assets/syntax.css">
    <link rel="stylesheet" href="/assets/primer-build.css">
    <link rel="stylesheet" href="/assets/style.css">
    <link rel="stylesheet" href="/assets/custom_style.css">
  </head>


  <body class="bg-gray">
    <div id="holy" class="container-lg bg-white h-100">

      <div id="header" class="px-1 bg-white">
        <nav class="UnderlineNav UnderlineNav--right px-2">
  <a class="UnderlineNav-actions muted-link h2" href="https://pippichi.github.io">
    Learning Records
  </a>

  
  
  <div class="UnderlineNav-body">
    
    
    
    <a class="UnderlineNav-item" href="/blog/">
      
      <span>Home</span>
    </a>
    
    
    
    
    <a class="UnderlineNav-item" href="/">
      
      <span>PDF/CODE</span>
    </a>
    
    
    
    
    <a class="UnderlineNav-item" href="/about/">
      
      <span>About</span>
    </a>
    
    
  </div>
  
</nav>

      </div>

      <div role="main" id="main" class="holy-main markdown-body px-4 bg-white">
        

<div class="Subhead">
  <div class="Subhead-heading">
    <div class="h1 mt-3 mb-1">K8S 1.18版本</div>
  </div>
  <div class="Subhead-description">
    


<a href='/categories/senior' class="muted-link">
  <span class="Label Label--gray-darker">Senior</span>
</a>



<a href='/tags/k8s' class="muted-link">
  <span class="Label Label--gray">K8S</span>
</a>



    
    <div class="float-md-right">
      <span title="Lastmod: 2022-01-06. Published at: 2022-01-06.">
        
          Published: 2022-01-06
        
      </span>
    </div>
    
  </div>
</div>
<article>
  
  <section class="pb-6 mb-3 border-bottom">
    <p>k8s 1.18版本学习笔记，总结了尚硅古2020年k8s教程视频的内容</p>
<h2 id="课程介绍">课程介绍</h2>
<p><img src="/k8s%E8%A1%A5%E5%85%85%EF%BC%88%E7%BB%93%E5%90%88%E6%95%99%E6%9D%90%EF%BC%89.assets/image-20211019103810765.png" alt="image-20211019103810765"></p>
<h2 id="k8s基本概念">k8s基本概念</h2>
<p><img src="/k8s%E8%A1%A5%E5%85%85%EF%BC%88%E7%BB%93%E5%90%88%E6%95%99%E6%9D%90%EF%BC%89.assets/image-20211019103849125.png" alt="image-20211019103849125"></p>
<p>另外，k8s使用的负载均衡是IPVS，他非常强大，为国人开发</p>
<p>pod与pod之间的访问，包括svc的负载均衡都需要借助kube proxy，kube proxy默认操作防火墙，去进行pod映射</p>
<h2 id="k8s核心概念">k8s核心概念</h2>
<p><img src="/k8s%E8%A1%A5%E5%85%85%EF%BC%88%E7%BB%93%E5%90%88%E6%95%99%E6%9D%90%EF%BC%89.assets/image-20210519140226038.png" alt="image-20210519140226038"></p>
<p><strong>无状态应用部署</strong></p>
<p>可以随便使用</p>
<p><strong>有状态应用部署</strong></p>
<p>需要有特定条件才可以使用</p>
<h2 id="etcd">etcd</h2>
<p>参考<code>尚硅谷Kubenetes教程（k8s从入门到精通）第1-6_尚硅谷_组件说明 -2集</code></p>
<h2 id="搭建k8s集群">搭建k8s集群</h2>
<h3 id="使用kubeadm方式搭建">使用kubeadm方式搭建</h3>
<p><img src="/k8s%E8%A1%A5%E5%85%85%EF%BC%88%E7%BB%93%E5%90%88%E6%95%99%E6%9D%90%EF%BC%89.assets/image-20211019103920235.png" alt="image-20211019103920235"></p>
<p><img src="/k8s%E8%A1%A5%E5%85%85%EF%BC%88%E7%BB%93%E5%90%88%E6%95%99%E6%9D%90%EF%BC%89.assets/image-20211019103938594.png" alt="image-20211019103938594"></p>
<h3 id="使用二进制方式搭建">使用二进制方式搭建</h3>
<p><img src="/k8s%E8%A1%A5%E5%85%85%EF%BC%88%E7%BB%93%E5%90%88%E6%95%99%E6%9D%90%EF%BC%89.assets/image-20211019103947221.png" alt="image-20211019103947221"></p>
<h3 id="总结">总结</h3>
<p><img src="/k8s%E8%A1%A5%E5%85%85%EF%BC%88%E7%BB%93%E5%90%88%E6%95%99%E6%9D%90%EF%BC%89.assets/image-20211019103957921.png" alt="image-20211019103957921"></p>
<p>搭建完毕之后可以使用命令<code>kubectl get node</code>查看集群节点：</p>
<p><img src="/k8s%E8%A1%A5%E5%85%85%EF%BC%88%E7%BB%93%E5%90%88%E6%95%99%E6%9D%90%EF%BC%89.assets/image-20211227104233498.png" alt="image-20211227104233498"></p>
<h2 id="kubectl">kubectl</h2>
<p><img src="/k8s%E8%A1%A5%E5%85%85%EF%BC%88%E7%BB%93%E5%90%88%E6%95%99%E6%9D%90%EF%BC%89.assets/image-20211019104008109.png" alt="image-20211019104008109"></p>
<h2 id="资源编排yaml">资源编排（yaml）</h2>
<p><img src="/k8s%E8%A1%A5%E5%85%85%EF%BC%88%E7%BB%93%E5%90%88%E6%95%99%E6%9D%90%EF%BC%89.assets/image-20211019104016937.png" alt="image-20211019104016937"></p>
<p><img src="/k8s%E8%A1%A5%E5%85%85%EF%BC%88%E7%BB%93%E5%90%88%E6%95%99%E6%9D%90%EF%BC%89.assets/image-20211019104602579.png" alt="image-20211019104602579"></p>
<p><img src="/k8s%E8%A1%A5%E5%85%85%EF%BC%88%E7%BB%93%E5%90%88%E6%95%99%E6%9D%90%EF%BC%89.assets/image-20211019104609961.png" alt="image-20211019104609961"></p>
<h3 id="使用create或get命令自动生成yaml文件">使用create或get命令自动生成yaml文件</h3>
<p><img src="/k8s%E8%A1%A5%E5%85%85%EF%BC%88%E7%BB%93%E5%90%88%E6%95%99%E6%9D%90%EF%BC%89.assets/image-20211019104023202.png" alt="image-20211019104023202"></p>
<h2 id="pod">Pod</h2>
<p><img src="/k8s%E8%A1%A5%E5%85%85%EF%BC%88%E7%BB%93%E5%90%88%E6%95%99%E6%9D%90%EF%BC%89.assets/image-20211101152140158.png" alt="image-20211101152140158"></p>
<p><img src="/k8s%E8%A1%A5%E5%85%85%EF%BC%88%E7%BB%93%E5%90%88%E6%95%99%E6%9D%90%EF%BC%89.assets/image-20211101160921723.png" alt="image-20211101160921723"></p>
<p><img src="/k8s%E8%A1%A5%E5%85%85%EF%BC%88%E7%BB%93%E5%90%88%E6%95%99%E6%9D%90%EF%BC%89.assets/image-20211101161049946.png" alt="image-20211101161049946"></p>
<p><img src="/k8s%E8%A1%A5%E5%85%85%EF%BC%88%E7%BB%93%E5%90%88%E6%95%99%E6%9D%90%EF%BC%89.assets/image-20211101161529169.png" alt="image-20211101161529169"></p>
<h3 id="pod与docker的区别">Pod与docker的区别</h3>
<p><img src="/k8s%E8%A1%A5%E5%85%85%EF%BC%88%E7%BB%93%E5%90%88%E6%95%99%E6%9D%90%EF%BC%89.assets/image-20211101152126318.png" alt="image-20211101152126318"></p>
<p>docker里头一个容器里面有一个应用，对应一个进程，是单进程的；Pod里头有多个容器，每个容器对应一个应用，每个应用对应一个进程，是多进程的</p>
<h3 id="共享网络">共享网络</h3>
<p><img src="/k8s%E8%A1%A5%E5%85%85%EF%BC%88%E7%BB%93%E5%90%88%E6%95%99%E6%9D%90%EF%BC%89.assets/image-20211019104034033.png" alt="image-20211019104034033"></p>
<p>Pause容器（根容器）也可以叫做info容器，在创建业务容器之后，会先加入到info容器中，共享ip、mac地址、port，因此他们在同一个namespace中</p>
<h3 id="共享数据数据卷实现">共享数据（数据卷实现）</h3>
<p><img src="/k8s%E8%A1%A5%E5%85%85%EF%BC%88%E7%BB%93%E5%90%88%E6%95%99%E6%9D%90%EF%BC%89.assets/image-20211019104041320.png" alt="image-20211019104041320"></p>
<p><img src="/k8s%E8%A1%A5%E5%85%85%EF%BC%88%E7%BB%93%E5%90%88%E6%95%99%E6%9D%90%EF%BC%89.assets/image-20211101160856627.png" alt="image-20211101160856627"></p>
<h3 id="镜像拉取策略">镜像拉取策略</h3>
<p><img src="/k8s%E8%A1%A5%E5%85%85%EF%BC%88%E7%BB%93%E5%90%88%E6%95%99%E6%9D%90%EF%BC%89.assets/image-20211019104058928.png" alt="image-20211019104058928"></p>
<h3 id="pod资源限制">Pod资源限制</h3>
<p><img src="/k8s%E8%A1%A5%E5%85%85%EF%BC%88%E7%BB%93%E5%90%88%E6%95%99%E6%9D%90%EF%BC%89.assets/image-20211019104107289.png" alt="image-20211019104107289"></p>
<p>这里的<code>cpu: &quot;500m&quot;</code>的意思是：</p>
<pre><code>1c（1核） = 1000m（1000兆）
0.5c（0.5核） = 500m
0.25c（0.25核） = 250m
</code></pre><p>注意，这里的限制本身是由docker做到的，不是由pod做到的</p>
<h3 id="pod重启策略">Pod重启策略</h3>
<p><img src="/k8s%E8%A1%A5%E5%85%85%EF%BC%88%E7%BB%93%E5%90%88%E6%95%99%E6%9D%90%EF%BC%89.assets/image-20211019104115872.png" alt="image-20211019104115872"></p>
<p>这里OnFailure的“退出状态码非0”的意思是：</p>
<p><img src="/k8s%E8%A1%A5%E5%85%85%EF%BC%88%E7%BB%93%E5%90%88%E6%95%99%E6%9D%90%EF%BC%89.assets/image-20211101161010273.png" alt="image-20211101161010273"></p>
<p>这里的RESTARTS为非0</p>
<h3 id="pod健康检查">Pod健康检查</h3>
<p><img src="/k8s%E8%A1%A5%E5%85%85%EF%BC%88%E7%BB%93%E5%90%88%E6%95%99%E6%9D%90%EF%BC%89.assets/image-20211019104122312.png" alt="image-20211019104122312"></p>
<p>这里的检查方法“exec”的意思是：</p>
<p><img src="/k8s%E8%A1%A5%E5%85%85%EF%BC%88%E7%BB%93%E5%90%88%E6%95%99%E6%9D%90%EF%BC%89.assets/image-20211101161135157.png" alt="image-20211101161135157"></p>
<p>解释：首先执行了创建文件的命令<code>touch /tmp/a</code>，然后去访问文件<code>cat /tmp/a</code>，此时一定是可以访问到的，再执行<code>echo &amp;?</code>（猜测这个命令的意思是用于判断上一个命令是否能执行成功，如果成功，返回0，失败则返回1），此时一定是返回0的，然后再执行删除文件命令<code>rm /tmp/a</code>，此时再去访问文件<code>cat /tmp/a</code>是一定访问不了的，再执行<code>echo &amp;?</code>，此时一定是返回1</p>
<h3 id="创建pod流程">创建Pod流程</h3>
<p><img src="/k8s%E8%A1%A5%E5%85%85%EF%BC%88%E7%BB%93%E5%90%88%E6%95%99%E6%9D%90%EF%BC%89.assets/image-20211019104129115.png" alt="image-20211019104129115"></p>
<h4 id="pod调度影响调用的属性节点选择器nodeselector标签创建节点亲和性nodeaffinity">Pod调度（影响调用的属性、节点选择器nodeSelector、标签创建、节点亲和性nodeAffinity）</h4>
<p><img src="/k8s%E8%A1%A5%E5%85%85%EF%BC%88%E7%BB%93%E5%90%88%E6%95%99%E6%9D%90%EF%BC%89.assets/image-20211019104150624.png" alt="image-20211019104150624"></p>
<p><img src="/k8s%E8%A1%A5%E5%85%85%EF%BC%88%E7%BB%93%E5%90%88%E6%95%99%E6%9D%90%EF%BC%89.assets/image-20211019104136472.png" alt="image-20211019104136472"></p>
<h4 id="污点与污点容忍">污点与污点容忍</h4>
<p><img src="/k8s%E8%A1%A5%E5%85%85%EF%BC%88%E7%BB%93%E5%90%88%E6%95%99%E6%9D%90%EF%BC%89.assets/image-20211019104203961.png" alt="image-20211019104203961"></p>
<h2 id="controller">Controller</h2>
<p><img src="/k8s%E8%A1%A5%E5%85%85%EF%BC%88%E7%BB%93%E5%90%88%E6%95%99%E6%9D%90%EF%BC%89.assets/image-20211019104218740.png" alt="image-20211019104218740"></p>
<p>升级过程中服务不中断，例子：假设有一个nginx1.14的服务以及一个他的副本在运行，此时要升级成1.15版本，会先创建一个新的1.15的服务，期间1.14的两个服务不停，当1.15的服务准备完成之后，再替换掉所有1.14的服务</p>
<h3 id="无状态与有状态有状态应用中的无头serviceclusterip为none以及statefulset守护进程daemonset一次性任务job定时任务cronjob">无状态与有状态、有状态应用中的无头service（ClusterIP为none）以及StatefulSet、守护进程DaemonSet、一次性任务Job、定时任务CronJob</h3>
<p><img src="/k8s%E8%A1%A5%E5%85%85%EF%BC%88%E7%BB%93%E5%90%88%E6%95%99%E6%9D%90%EF%BC%89.assets/image-20211019104316235.png" alt="image-20211019104316235"></p>
<p>删除所有statefulset：<code>kubectl delete statefulset --all</code></p>
<p>删除指定名称的svc：<code>kubectl delete svc web01</code></p>
<p>使用<code>yaml</code>文件进行删除：<code>kubectl delete -f xxx.yaml</code></p>
<p>上面“部署一个守护进程DaemonSet”的yaml例子（该应用的具体作用我们不关心，只是想测试一下DaemonSet，这里他用于日志采集）：</p>
<p><img src="/k8s%E8%A1%A5%E5%85%85%EF%BC%88%E7%BB%93%E5%90%88%E6%95%99%E6%9D%90%EF%BC%89.assets/image-20211102104436539.png" alt="image-20211102104436539"></p>
<p>上面“job（一次性任务）”的yaml例子：</p>
<p><img src="/k8s%E8%A1%A5%E5%85%85%EF%BC%88%E7%BB%93%E5%90%88%E6%95%99%E6%9D%90%EF%BC%89.assets/image-20211102132354182.png" alt="image-20211102132354182"></p>
<p>这里的最后一行“backoffLimit”意思是启动失败之后再次尝试重启的次数，这里为4次</p>
<h2 id="service">Service</h2>
<p><img src="/k8s%E8%A1%A5%E5%85%85%EF%BC%88%E7%BB%93%E5%90%88%E6%95%99%E6%9D%90%EF%BC%89.assets/image-20211019104302289.png" alt="image-20211019104302289"></p>
<p>上面那个&quot;vip（虚拟ip）&ldquo;是指service对外的ip地址</p>
<p>service使用的负载均衡算法是roundrobin</p>
<p>实验常用Service类型（ClusterIP、NodePort、LoadBalancer）：</p>
<ul>
<li>
<p>create一个镜像为nginx的yaml，然后apply</p>
</li>
<li>
<p>expose一个该应用的yaml，修改yaml文件中的type属性：</p>
<p><img src="/k8s%E8%A1%A5%E5%85%85%EF%BC%88%E7%BB%93%E5%90%88%E6%95%99%E6%9D%90%EF%BC%89.assets/image-20211102101314766.png" alt="image-20211102101314766"></p>
<p>然后apply</p>
</li>
<li>
<p>执行<code>kubectl get svc</code>就可以看到该应用对内暴露的端口以及对外暴露的端口以及服务的type属性</p>
<p><img src="/k8s%E8%A1%A5%E5%85%85%EF%BC%88%E7%BB%93%E5%90%88%E6%95%99%E6%9D%90%EF%BC%89.assets/image-20211102101522060.png" alt="image-20211102101522060"></p>
</li>
</ul>
<p>LoadBalancer非常强大，一般是在公有云里使用的，不仅能做到NodePort的功能，还能做到nginx的负载均衡等，而且nginx负载均衡需要手动添加节点做反向代理，LoadBalancer就不需要手动添加，非常方便</p>
<h2 id="配置管理">配置管理</h2>
<h3 id="secret">Secret</h3>
<p><img src="/k8s%E8%A1%A5%E5%85%85%EF%BC%88%E7%BB%93%E5%90%88%E6%95%99%E6%9D%90%EF%BC%89.assets/image-20211019104327133.png" alt="image-20211019104327133"></p>
<p>创建secret加密数据并以变量形式挂载到pod的解释：</p>
<ul>
<li>首先创建Secret加密数据应用，里头的username为用base64加密后的用户名，password为用base64加密后的密码</li>
<li>创建另一个应用，以<code>-name</code>的形式定义变量（比方说上图，定义了两个变量：<code>SECRET_USERNAME</code>和<code>SECRET_PASSWORD</code>），然后指定从哪个Secret加密数据应用获取需要绑定到变量的数据（比方说上图，从mysecret中获取username绑定到<code>SECRET_USERNAME</code>，从mysecret中获取password绑定到<code>SECRET_PASSWORD</code>）</li>
<li>然后在该应用中打印变量（比方说执行<code>echo $SECRET_USERNAME</code>，那么输出即为mysecret中加密数据解密之后的数据）</li>
</ul>
<p>创建secret加密数据并以Volume形式挂载到pod的解释：</p>
<ul>
<li>首先创建Secret加密数据应用，里头的username为用base64加密后的用户名，password为用base64加密后的密码</li>
<li>创建另一个应用，以数据卷的形式（关注上图红方框圈起来的部分）将数据挂载到相应目录下</li>
<li>进入该应用，进入相应的目录即可找到解密之后的数据</li>
</ul>
<h3 id="configmap">ConfigMap</h3>
<p><img src="/k8s%E8%A1%A5%E5%85%85%EF%BC%88%E7%BB%93%E5%90%88%E6%95%99%E6%9D%90%EF%BC%89.assets/image-20211019104337625.png" alt="image-20211019104337625"></p>
<p>上面“以变量形式挂载到pod容器中”的<code>myconfig.yaml</code>文件：</p>
<p><img src="/k8s%E8%A1%A5%E5%85%85%EF%BC%88%E7%BB%93%E5%90%88%E6%95%99%E6%9D%90%EF%BC%89.assets/image-20211102153727598.png" alt="image-20211102153727598"></p>
<p>其中<code>special.level</code>和<code>special.type</code>为自定义变量</p>
<p><code>config-var.yaml</code>文件：</p>
<p><img src="/k8s%E8%A1%A5%E5%85%85%EF%BC%88%E7%BB%93%E5%90%88%E6%95%99%E6%9D%90%EF%BC%89.assets/image-20211102153851430.png" alt="image-20211102153851430"></p>
<p>其中变量的绑定与上面&quot;创建secret加密数据并以变量形式挂载到pod&quot;的绑定方法一模一样</p>
<h2 id="k8s集群安全机制">k8s集群安全机制</h2>
<p><img src="/k8s%E8%A1%A5%E5%85%85%EF%BC%88%E7%BB%93%E5%90%88%E6%95%99%E6%9D%90%EF%BC%89.assets/image-20211019104348734.png" alt="image-20211019104348734"></p>
<p><img src="/k8s%E8%A1%A5%E5%85%85%EF%BC%88%E7%BB%93%E5%90%88%E6%95%99%E6%9D%90%EF%BC%89.assets/image-20211019104357258.png" alt="image-20211019104357258"></p>
<p>k8s获取命名空间：<code>kubectl get ns</code></p>
<p>k8s创建命名空间：<code>kubectl create ns ns1</code></p>
<p>用于创建角色的yaml文件：</p>
<p><img src="/k8s%E8%A1%A5%E5%85%85%EF%BC%88%E7%BB%93%E5%90%88%E6%95%99%E6%9D%90%EF%BC%89.assets/image-20211102165820968.png" alt="image-20211102165820968"></p>
<p>用于创建角色绑定的yaml文件：</p>
<p><img src="/k8s%E8%A1%A5%E5%85%85%EF%BC%88%E7%BB%93%E5%90%88%E6%95%99%E6%9D%90%EF%BC%89.assets/image-20211104093925293.png" alt="image-20211104093925293"></p>
<p>上面第5步使用证书识别身份中的ca开头的文件在资料中的rbac文件夹下（只存在部分文件），需要手动复制到相应目录下，比方说这里我们要给mary用户创建证书用于识别身份，那么就应该创建mary文件夹，然后将ca开头的文件都复制到mary文件夹下（具体讲解内容查看教学视频第42集第7分30秒）</p>
<p>其中namespace需要我们自己指定</p>
<h2 id="ingress">Ingress</h2>
<p><img src="/k8s%E8%A1%A5%E5%85%85%EF%BC%88%E7%BB%93%E5%90%88%E6%95%99%E6%9D%90%EF%BC%89.assets/image-20211019104409976.png" alt="image-20211019104409976"></p>
<p>上面第六步<code>ingress-con.yaml</code>在资料的ingress文件夹中，需要注意的是<code>ingress-con.yaml</code>中有个地方的hostNetWork需要改成true，他表示对外暴露网络，如果不改成true，后面就会访问不到：</p>
<p><img src="/k8s%E8%A1%A5%E5%85%85%EF%BC%88%E7%BB%93%E5%90%88%E6%95%99%E6%9D%90%EF%BC%89.assets/image-20211104162957803.png" alt="image-20211104162957803"></p>
<p>上面创建ingress规则的时候，<code>ingress-h.yaml</code>文件：</p>
<p><img src="/k8s%E8%A1%A5%E5%85%85%EF%BC%88%E7%BB%93%E5%90%88%E6%95%99%E6%9D%90%EF%BC%89.assets/image-20211104164402997.png" alt="image-20211104164402997"></p>
<p>其中paths中可以配置多个path；host就是域名</p>
<h2 id="helm">helm</h2>
<p><img src="/k8s%E8%A1%A5%E5%85%85%EF%BC%88%E7%BB%93%E5%90%88%E6%95%99%E6%9D%90%EF%BC%89.assets/image-20211019104433120.png" alt="image-20211019104433120"></p>
<p><img src="/k8s%E8%A1%A5%E5%85%85%EF%BC%88%E7%BB%93%E5%90%88%E6%95%99%E6%9D%90%EF%BC%89.assets/image-20211019104443972.png" alt="image-20211019104443972"></p>
<p>使用helm之后，我们可以通过<code>helm list</code>查看部署的应用，还可以通过<code>kubectl</code>命令查看相关的pods和svc，那当我们想要修改端口的时候怎么办呢？</p>
<p><img src="/k8s%E8%A1%A5%E5%85%85%EF%BC%88%E7%BB%93%E5%90%88%E6%95%99%E6%9D%90%EF%BC%89.assets/image-20211105151537970.png" alt="image-20211105151537970"></p>
<p>可以使用<code>kubectl edit svc xxx</code>进入到yaml文件中，并修改type：</p>
<p><img src="/k8s%E8%A1%A5%E5%85%85%EF%BC%88%E7%BB%93%E5%90%88%E6%95%99%E6%9D%90%EF%BC%89.assets/image-20211105151616876.png" alt="image-20211105151616876"></p>
<h3 id="创建自己的chart">创建自己的Chart</h3>
<p><img src="/k8s%E8%A1%A5%E5%85%85%EF%BC%88%E7%BB%93%E5%90%88%E6%95%99%E6%9D%90%EF%BC%89.assets/image-20211019104452829.png" alt="image-20211019104452829"></p>
<h3 id="实现yaml文件的高效复用">实现yaml文件的高效复用</h3>
<p><img src="/k8s%E8%A1%A5%E5%85%85%EF%BC%88%E7%BB%93%E5%90%88%E6%95%99%E6%9D%90%EF%BC%89.assets/image-20211019104502201.png" alt="image-20211019104502201"></p>
<p>使用<code>values.yaml</code>定义变量，例子：</p>
<p><img src="/k8s%E8%A1%A5%E5%85%85%EF%BC%88%E7%BB%93%E5%90%88%E6%95%99%E6%9D%90%EF%BC%89.assets/image-20211105153852198.png" alt="image-20211105153852198"></p>
<p>修改完成之后，我们使用<code>--dry-run</code>来尝试执行（helm的尝试执行也是加<code>--dry-run</code>参数）：</p>
<p><img src="/k8s%E8%A1%A5%E5%85%85%EF%BC%88%E7%BB%93%E5%90%88%E6%95%99%E6%9D%90%EF%BC%89.assets/image-20211105154224912.png" alt="image-20211105154224912"></p>
<p>发现被变量占位的地方全部成功改成了变量值，说明成功了，然后我们来真正执行：</p>
<p><img src="/k8s%E8%A1%A5%E5%85%85%EF%BC%88%E7%BB%93%E5%90%88%E6%95%99%E6%9D%90%EF%BC%89.assets/image-20211105154440520.png" alt="image-20211105154440520"></p>
<h2 id="持久化存储">持久化存储</h2>
<p><img src="/k8s%E8%A1%A5%E5%85%85%EF%BC%88%E7%BB%93%E5%90%88%E6%95%99%E6%9D%90%EF%BC%89.assets/image-20211019104548736.png" alt="image-20211019104548736"></p>
<p>上面“设置挂载路径”中的<code>/data/nfs</code>表示挂载的路径，<code>*</code>表示所有内容，<code>rw</code>表示读写权限</p>
<p>第四步“在k8s集群部署应用使用nfs持久网络存储”中，如何创建nfs的deployment：</p>
<p>首先创建<code>nfs-nginx.yaml</code>：</p>
<p><img src="/k8s%E8%A1%A5%E5%85%85%EF%BC%88%E7%BB%93%E5%90%88%E6%95%99%E6%9D%90%EF%BC%89.assets/image-20211105155412874.png" alt="image-20211105155412874"></p>
<p>文件里面写的内容：</p>
<p><img src="/k8s%E8%A1%A5%E5%85%85%EF%BC%88%E7%BB%93%E5%90%88%E6%95%99%E6%9D%90%EF%BC%89.assets/image-20211105155615828.png" alt="image-20211105155615828"></p>
<p>之后执行<code>kubectl apply</code>命令创建该deployment，使用<code>kubectl get pods</code>查看创建状态，如果一直没有创建完成（一直没有到RUNNING状态），可以使用<code>kubectl describe pod xxx</code>命令来查看状态：</p>
<p><img src="/k8s%E8%A1%A5%E5%85%85%EF%BC%88%E7%BB%93%E5%90%88%E6%95%99%E6%9D%90%EF%BC%89.assets/image-20211105160051513.png" alt="image-20211105160051513"></p>
<p><img src="/k8s%E8%A1%A5%E5%85%85%EF%BC%88%E7%BB%93%E5%90%88%E6%95%99%E6%9D%90%EF%BC%89.assets/image-20211105160122723.png" alt="image-20211105160122723"></p>
<p>上面第四步“在k8s集群部署应用使用nfs持久网络存储”，在完成所有部署之后，我们在外部nfs服务器的挂载路径中放置一个文件，对应的应用的挂载路径中也会有这个文件。</p>
<h3 id="共享存储">共享存储</h3>
<p><img src="/k8s%E8%A1%A5%E5%85%85%EF%BC%88%E7%BB%93%E5%90%88%E6%95%99%E6%9D%90%EF%BC%89.assets/image-20211019104616167.png" alt="image-20211019104616167"></p>
<h3 id="pv与pvc">PV与PVC</h3>
<p><img src="/k8s%E8%A1%A5%E5%85%85%EF%BC%88%E7%BB%93%E5%90%88%E6%95%99%E6%9D%90%EF%BC%89.assets/image-20211019104555604.png" alt="image-20211019104555604"></p>
<p>pvc如何绑定pv呢？通过存储容量和匹配模式，比方说pvc要找pv中存储容量为50g的且匹配模式为读写的，这个过程就叫做绑定</p>
<p>操作过程：</p>
<p>首先建立<code>pvc.yaml</code>：</p>
<p><img src="/k8s%E8%A1%A5%E5%85%85%EF%BC%88%E7%BB%93%E5%90%88%E6%95%99%E6%9D%90%EF%BC%89.assets/image-20211105170056421.png" alt="image-20211105170056421"></p>
<p>写入内容：</p>
<p><img src="/k8s%E8%A1%A5%E5%85%85%EF%BC%88%E7%BB%93%E5%90%88%E6%95%99%E6%9D%90%EF%BC%89.assets/image-20211108093217453.png" alt="image-20211108093217453"></p>
<p>并执行apply命令进行创建</p>
<p>然后创建<code>pv.yaml</code>，并写入内容：</p>
<p><img src="/k8s%E8%A1%A5%E5%85%85%EF%BC%88%E7%BB%93%E5%90%88%E6%95%99%E6%9D%90%EF%BC%89.assets/image-20211108093447139.png" alt="image-20211108093447139"></p>
<p>并执行apply</p>
<p>随后我们使用<code>kubectl get pv,pvc</code>来查看：</p>
<p><img src="/k8s%E8%A1%A5%E5%85%85%EF%BC%88%E7%BB%93%E5%90%88%E6%95%99%E6%9D%90%EF%BC%89.assets/image-20211108093709531.png" alt="image-20211108093709531"></p>
<h3 id="sc">SC</h3>
<p>Storage Class(SC)：对接后端存储服务器(Storage)的驱动(插件)，配置 Storage Class 对象时，需要提供对接存储的相关信息，比如存储地址、认证用户名和密码等。</p>
<p>Storage：真实存储数据的服务器，包含服务器地址和认证等信息。</p>
<p>参考：https://www.cnblogs.com/panwenbin-logs/p/12196286.html（k8s学习笔记之StorageClass+NFS）、https://www.cnblogs.com/mybxy/p/13994931.html（k8s 持久卷使用记录 ( PV + PVC + SC + NFS )）</p>
<h2 id="集群资源监控">集群资源监控</h2>
<p><img src="/k8s%E8%A1%A5%E5%85%85%EF%BC%88%E7%BB%93%E5%90%88%E6%95%99%E6%9D%90%EF%BC%89.assets/image-20211019104422123.png" alt="image-20211019104422123"></p>
<p>由于在<code>yaml</code>文件中我们指定了命名空间为：<code>kube-system</code>，所以查看svc的时候需要带上命名空间：</p>
<p><img src="/k8s%E8%A1%A5%E5%85%85%EF%BC%88%E7%BB%93%E5%90%88%E6%95%99%E6%9D%90%EF%BC%89.assets/image-20211108101535718.png" alt="image-20211108101535718"></p>
<p>配置数据源具体操作：</p>
<p>首先进入grafana页面</p>
<p><img src="/k8s%E8%A1%A5%E5%85%85%EF%BC%88%E7%BB%93%E5%90%88%E6%95%99%E6%9D%90%EF%BC%89.assets/image-20211108101920036.png" alt="image-20211108101920036"></p>
<p>添加数据源进行配置：</p>
<p><img src="/k8s%E8%A1%A5%E5%85%85%EF%BC%88%E7%BB%93%E5%90%88%E6%95%99%E6%9D%90%EF%BC%89.assets/image-20211108101952157.png" alt="image-20211108101952157"></p>
<p>特别注意上图的url，需要指定Prometheus的集群ip：</p>
<p><img src="/k8s%E8%A1%A5%E5%85%85%EF%BC%88%E7%BB%93%E5%90%88%E6%95%99%E6%9D%90%EF%BC%89.assets/image-20211108102058742.png" alt="image-20211108102058742"></p>
<p>接下来需要设置grafana的数据模板：</p>
<p><img src="/k8s%E8%A1%A5%E5%85%85%EF%BC%88%E7%BB%93%E5%90%88%E6%95%99%E6%9D%90%EF%BC%89.assets/image-20211108102308084.png" alt="image-20211108102308084"></p>
<p><img src="/k8s%E8%A1%A5%E5%85%85%EF%BC%88%E7%BB%93%E5%90%88%E6%95%99%E6%9D%90%EF%BC%89.assets/image-20211108102441366.png" alt="image-20211108102441366"></p>
<p>这个315是我们选用的一个模板（类似于模板名或模板id）</p>
<p>当然也可以选择其他模板</p>
<p><img src="/k8s%E8%A1%A5%E5%85%85%EF%BC%88%E7%BB%93%E5%90%88%E6%95%99%E6%9D%90%EF%BC%89.assets/image-20211108102505316.png" alt="image-20211108102505316"></p>
<p>之后就能显示出图形化界面了：</p>
<p><img src="/k8s%E8%A1%A5%E5%85%85%EF%BC%88%E7%BB%93%E5%90%88%E6%95%99%E6%9D%90%EF%BC%89.assets/image-20211108102522284.png" alt="image-20211108102522284"></p>
<h2 id="部署多master节点">部署多master节点</h2>
<p><img src="/k8s%E8%A1%A5%E5%85%85%EF%BC%88%E7%BB%93%E5%90%88%E6%95%99%E6%9D%90%EF%BC%89.assets/image-20211019104534730.png" alt="image-20211019104534730"></p>
<p>keepalived的两个作用：</p>
<ul>
<li>配置虚拟ip（上图的VIP（虚拟ip））</li>
<li>检查当前节点的状态</li>
</ul>
<p>haproxy类似于nginx，换句话说这里的haproxy可以替换成nginx，那么为什么要加他呢？</p>
<p>首先node是去请求load balancer的，如果不加haproxy，load balancer通过keepalived检测到master1是正常的，那么所有的请求全部都会打到master1这里，这显然不合理，请求应该平均分配，因此要加上负载均衡，加了之后就可以避免这种情况</p>
<p><strong>开始部署</strong></p>
<p>可以参考教材：<code>使用kubeadm搭建高可用的K8s集群.md</code></p>
<p><img src="/k8s%E8%A1%A5%E5%85%85%EF%BC%88%E7%BB%93%E5%90%88%E6%95%99%E6%9D%90%EF%BC%89.assets/image-20211019104542106.png" alt="image-20211019104542106"></p>
<p>在部署haproxy时需要修改<code>haproxy.cfg</code>文件，主要修改这个地方：</p>
<p><img src="/k8s%E8%A1%A5%E5%85%85%EF%BC%88%E7%BB%93%E5%90%88%E6%95%99%E6%9D%90%EF%BC%89.assets/image-20211108134354396.png" alt="image-20211108134354396"></p>
<p>上图的&quot;mode tcp&quot;表示通讯模式是tcp；&ldquo;balance roundrobin&quot;表示负载均衡算法是roundrobin；&ldquo;server master01.k8s.io 192.168.44.155:6443&quot;中<code>master01.k8s.io</code>为名称，<code>192.168.44.155:6443</code>为master节点的ip和port。这些都是可以按需修改的。</p>
<p>haproxy默认监听端口是16443：</p>
<p><img src="/k8s%E8%A1%A5%E5%85%85%EF%BC%88%E7%BB%93%E5%90%88%E6%95%99%E6%9D%90%EF%BC%89.assets/image-20211108135614956.png" alt="image-20211108135614956"></p>
<p><img src="/k8s%E8%A1%A5%E5%85%85%EF%BC%88%E7%BB%93%E5%90%88%E6%95%99%E6%9D%90%EF%BC%89.assets/image-20211108135549960.png" alt="image-20211108135549960"></p>
<h2 id="在k8s集群中部署项目">在k8s集群中部署项目</h2>
<p><img src="/k8s%E8%A1%A5%E5%85%85%EF%BC%88%E7%BB%93%E5%90%88%E6%95%99%E6%9D%90%EF%BC%89.assets/image-20211019104512058.png" alt="image-20211019104512058"></p>
<p><img src="/k8s%E8%A1%A5%E5%85%85%EF%BC%88%E7%BB%93%E5%90%88%E6%95%99%E6%9D%90%EF%BC%89.assets/image-20211019104524845.png" alt="image-20211019104524845"></p>
  </section>

  <section>
    
      
    
  </section>
</article>

      </div>

      <div id="side" class="pr-1 bg-white">
        <aside class="pr-3">
          
  
    <div id="toc" class="Box Box--blue mb-3">
      <b>K8S 1.18版本</b><nav id="TableOfContents">
  <ul>
    <li><a href="#课程介绍">课程介绍</a></li>
    <li><a href="#k8s基本概念">k8s基本概念</a></li>
    <li><a href="#k8s核心概念">k8s核心概念</a></li>
    <li><a href="#etcd">etcd</a></li>
    <li><a href="#搭建k8s集群">搭建k8s集群</a>
      <ul>
        <li><a href="#使用kubeadm方式搭建">使用kubeadm方式搭建</a></li>
        <li><a href="#使用二进制方式搭建">使用二进制方式搭建</a></li>
        <li><a href="#总结">总结</a></li>
      </ul>
    </li>
    <li><a href="#kubectl">kubectl</a></li>
    <li><a href="#资源编排yaml">资源编排（yaml）</a>
      <ul>
        <li><a href="#使用create或get命令自动生成yaml文件">使用create或get命令自动生成yaml文件</a></li>
      </ul>
    </li>
    <li><a href="#pod">Pod</a>
      <ul>
        <li><a href="#pod与docker的区别">Pod与docker的区别</a></li>
        <li><a href="#共享网络">共享网络</a></li>
        <li><a href="#共享数据数据卷实现">共享数据（数据卷实现）</a></li>
        <li><a href="#镜像拉取策略">镜像拉取策略</a></li>
        <li><a href="#pod资源限制">Pod资源限制</a></li>
        <li><a href="#pod重启策略">Pod重启策略</a></li>
        <li><a href="#pod健康检查">Pod健康检查</a></li>
        <li><a href="#创建pod流程">创建Pod流程</a></li>
      </ul>
    </li>
    <li><a href="#controller">Controller</a>
      <ul>
        <li><a href="#无状态与有状态有状态应用中的无头serviceclusterip为none以及statefulset守护进程daemonset一次性任务job定时任务cronjob">无状态与有状态、有状态应用中的无头service（ClusterIP为none）以及StatefulSet、守护进程DaemonSet、一次性任务Job、定时任务CronJob</a></li>
      </ul>
    </li>
    <li><a href="#service">Service</a></li>
    <li><a href="#配置管理">配置管理</a>
      <ul>
        <li><a href="#secret">Secret</a></li>
        <li><a href="#configmap">ConfigMap</a></li>
      </ul>
    </li>
    <li><a href="#k8s集群安全机制">k8s集群安全机制</a></li>
    <li><a href="#ingress">Ingress</a></li>
    <li><a href="#helm">helm</a>
      <ul>
        <li><a href="#创建自己的chart">创建自己的Chart</a></li>
        <li><a href="#实现yaml文件的高效复用">实现yaml文件的高效复用</a></li>
      </ul>
    </li>
    <li><a href="#持久化存储">持久化存储</a>
      <ul>
        <li><a href="#共享存储">共享存储</a></li>
        <li><a href="#pv与pvc">PV与PVC</a></li>
        <li><a href="#sc">SC</a></li>
      </ul>
    </li>
    <li><a href="#集群资源监控">集群资源监控</a></li>
    <li><a href="#部署多master节点">部署多master节点</a></li>
    <li><a href="#在k8s集群中部署项目">在k8s集群中部署项目</a></li>
  </ul>
</nav></div>
  

  
    <div>
      
    </div>
  

        </aside>
      </div>

      <div id="footer" class="pt-2 pb-3 bg-white text-center">
        

  <span class="text-small text-gray">
    ©QYF Just for record 2018-2021 &middot; 

    Powered by the
    <a href="https://github.com/qqhann/hugo-primer" class="link-gray-dark">Hugo-Primer</a> theme for
    <a href="https://gohugo.io" class="link-gray-dark">Hugo</a>.
  </span>


      </div>
    </div>

    
    
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/x-mathjax-config">MathJax.Hub.Config({ tex2jax: { inlineMath: [['$','$'], ['\\(','\\)']] } });</script>
    
  </body>
</html>
