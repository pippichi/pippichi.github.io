<!DOCTYPE html>
<html>
  <head>
    
    
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-12345678-0', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

    
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>
      
  Shiro &ndash; Learning Records

    </title>
    
    <meta content="Shiro" name="keywords">
    
    
    <meta name="description" property="og:description" content="Shiro总结
|Just for record">
    

    <meta name="apple-mobile-web-app-title" content="Learning Records">
    
    
    
    
    <meta name="twitter:card" content="summary">
    <meta name="twitter:site" content="@">
    <meta name="twitter:creator" content="@">
    <meta name="twitter:title" content="Shiro | Learning Records">
    <meta name="twitter:description" content="Shiro总结|Just for record">
    <meta name="twitter:image" content="https://pippichi.github.iotwitter-card.png">
    


    <link rel="stylesheet" href="/assets/syntax.css">
    <link rel="stylesheet" href="/assets/primer-build.css">
    <link rel="stylesheet" href="/assets/style.css">
    <link rel="stylesheet" href="/assets/custom_style.css">
  </head>


  <body class="bg-gray">
    <div id="holy" class="container-lg bg-white h-100">

      <div id="header" class="px-1 bg-white">
        <nav class="UnderlineNav UnderlineNav--right px-2">
  <a class="UnderlineNav-actions muted-link h2" href="https://pippichi.github.io">
    Learning Records
  </a>

  
  
  <div class="UnderlineNav-body">
    
    
    
    <a class="UnderlineNav-item" href="/blog/">
      
      <span>Home</span>
    </a>
    
    
    
    
    <a class="UnderlineNav-item" href="/">
      
      <span>PDF/CODE</span>
    </a>
    
    
    
    
    <a class="UnderlineNav-item" href="/about/">
      
      <span>About</span>
    </a>
    
    
  </div>
  
</nav>

      </div>

      <div role="main" id="main" class="holy-main markdown-body px-4 bg-white">
        

<div class="Subhead">
  <div class="Subhead-heading">
    <div class="h1 mt-3 mb-1">Shiro</div>
  </div>
  <div class="Subhead-description">
    


<a href='/categories/basic' class="muted-link">
  <span class="Label Label--gray-darker">Basic</span>
</a>



<a href='/tags/shiro' class="muted-link">
  <span class="Label Label--gray">Shiro</span>
</a>



    
    <div class="float-md-right">
      <span title="Lastmod: 2021-06-07. Published at: 2021-06-07.">
        
          Published: 2021-06-07
        
      </span>
    </div>
    
  </div>
</div>
<article>
  
  <section class="pb-6 mb-3 border-bottom">
    <p>Shiro总结</p>
<h2 id="一权限的管理">一、权限的管理</h2>
<h3 id="11-什么是权限管理">1.1 什么是权限管理</h3>
<p>基本上涉及到用户参与的系统都要进行权限管理，权限管理属于系统安全的范畴，权限管理实现对用户访问系统的控制，按照安全规则或者安全策略控制用户可以访问而且只能访问自己被授权的资源。</p>
<p>权限管理包括用户身份认证和授权两部分，简称认证授权。对于需要访问控制的资源用户首先经过身份认证，认证通过后用户具有该资源的访问权限方可访问。</p>
<h3 id="12-什么是身份认证">1.2 什么是身份认证</h3>
<p>身份认证，就是判断一个用户是否为合法用户的处理过程。最常用的简单身份认证方式是系统通过核对用户输入的用户名和口令，看其是否与系统中存储的该用户的用户名和口令一致，来判断用户身份是否正确。对于采用指纹等系统，则出示指纹；对于硬件Key等刷卡系统，则需要刷卡。</p>
<h3 id="13-什么是授权">1.3 什么是授权</h3>
<p>授权，即访问控制，控制谁能访问哪些资源。主体进行身份认证后需要分配权限方可访问系统的资源，对于某些资源没有权限是无法访问的</p>
<h2 id="二什么是shiro">二、什么是shiro</h2>
<p>Shiro是apache旗下一个开源框架，它将软件系统的安全认证相关的功能抽取出来，实现用户身份认证，权限授权、加密、会话管理等功能，组成了一个通用的安全认证框架。</p>
<h2 id="三shiro的核心架构">三、shiro的核心架构</h2>
<p><img src="/shiro.assets/image-20210607152801538.png" alt="image-20210607152801538"></p>
<h3 id="31-subject">3.1 Subject</h3>
<p>Subject即主体，外部应用与subject进行交互，subject记录了当前操作用户，将用户的概念理解为当前操作的主体，可能是一个通过浏览器请求的用户，也可能是一个运行的程序。</p>
<p>Subject在shiro中是一个接口，接口中定义了很多认证授相关的方法，外部程序通过subject进行认证授，而subject是通过SecurityManager安全管理器进行认证授权</p>
<h3 id="32-securitymanager">3.2 SecurityManager</h3>
<p>SecurityManager即安全管理器，对全部的subject进行安全管理，它是shiro的核心，负责对所有的subject进行安全管理。通过SecurityManager可以完成subject的认证、授权等，实质上SecurityManager是通过Authenticator进行认证，通过Authorizer进行授权，通过SessionManager进行会话管理等。</p>
<p>SecurityManager是一个接口，继承了Authenticator, Authorizer, SessionManager这三个接口。</p>
<h3 id="33-authenticator">3.3 Authenticator</h3>
<p><code>Authenticator即认证器</code>，对用户身份进行认证，Authenticator是一个接口，shiro提供ModularRealmAuthenticator实现类，通过ModularRealmAuthenticator基本上可以满足大多数需求，也可以自定义认证器。</p>
<h3 id="34-authorizer">3.4 Authorizer</h3>
<p><code>Authorizer即授权器</code>，用户通过认证器认证通过，在访问功能时需要通过授权器判断用户是否有此功能的操作权限。</p>
<h3 id="35-realm">3.5 Realm</h3>
<p><code>Realm即领域</code>，相当于datasource数据源，securityManager进行安全认证需要通过Realm获取用户权限数据，比如：如果用户身份数据在数据库那么realm就需要从数据库获取用户身份信息。</p>
<p>注意：不要把realm理解成只是从数据源取数据，在realm中还有认证授权校验的相关的代码。</p>
<h3 id="36-sessionmanager">3.6 SessionManager</h3>
<p><code>sessionManager即会话管理</code>，shiro框架定义了一套会话管理，它不依赖web容器的session，所以shiro可以使用在非web应用上，也可以将分布式应用的会话集中在一点管理，此特性可使它实现单点登录。</p>
<h3 id="37-sessiondao">3.7 SessionDAO</h3>
<p><code>SessionDAO即会话dao</code>，是对session会话操作的一套接口，比如要将session存储到数据库，可以通过jdbc将会话存储到数据库。</p>
<h3 id="38-cachemanager">3.8 CacheManager</h3>
<p><code>CacheManager即缓存管理</code>，将用户权限数据存储在缓存，这样可以提高性能。</p>
<h3 id="39-cryptography">3.9 Cryptography</h3>
<p><code>Cryptography即密码管理</code>，shiro提供了一套加密/解密的组件，方便开发。比如提供常用的散列、加/解密等功能。</p>
<h2 id="四shiro中的认证">四、shiro中的认证</h2>
<h3 id="41-认证">4.1 认证</h3>
<p>身份认证，就是判断一个用户是否为合法用户的处理过程。最常用的简单身份认证方式是系统通过核对用户输入的用户名和口令，看其是否与系统中存储的该用户的用户名和口令一致，来判断用户身份是否正确。</p>
<h3 id="42-shiro中认证的关键对象">4.2 shiro中认证的关键对象</h3>
<ul>
<li>
<p><strong>Subject：主体</strong></p>
<p>访问系统的用户，主体可以是用户、程序等，进行认证的都称为主体；</p>
</li>
<li>
<p><strong>Principal：身份信息</strong></p>
<p>是主体（subject）进行身份认证的标识，标识必须具有<code>唯一性</code>，如用户名、手机号、邮箱地址等，一个主体可以有多个身份，但是必须有一个主身份（Primary Principal）。</p>
</li>
<li>
<p><strong>credential：凭证信息</strong></p>
<p>是只有主体自己知道的安全信息，如密码、证书等。</p>
</li>
</ul>
<h3 id="43-认证流程">4.3 认证流程</h3>
<p><img src="/shiro.assets/image-20210607153256170.png" alt="image-20210607153256170"></p>
<h3 id="44-认证的开发">4.4 认证的开发</h3>
<h4 id="1-创建项目并引入依赖">1. 创建项目并引入依赖</h4>
<div class="highlight"><pre class="chroma"><code class="language-xml" data-lang="xml"><span class="nt">&lt;dependency&gt;</span>
  <span class="nt">&lt;groupId&gt;</span>org.apache.shiro<span class="nt">&lt;/groupId&gt;</span>
  <span class="nt">&lt;artifactId&gt;</span>shiro-core<span class="nt">&lt;/artifactId&gt;</span>
  <span class="nt">&lt;version&gt;</span>1.5.3<span class="nt">&lt;/version&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</code></pre></div><h4 id="2-引入shiro配置文件">2. 引入shiro配置文件</h4>
<p>配置文件：名称随意，以<code>.ini</code> 结尾，放在 resources 目录下</p>
<p><strong>注意</strong>：在实际的项目开发中并不会使用这种方式，这种方法可以用来初学时练手</p>
<pre><code>[users]
zhangsan=123456
lisi=456789
</code></pre><p><img src="/shiro.assets/image-20210607153405100.png" alt="image-20210607153405100"></p>
<h4 id="3开发认证代码">3.开发认证代码</h4>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kn">package</span> <span class="nn">com.lut.test</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.apache.shiro.SecurityUtils</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.shiro.authc.IncorrectCredentialsException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.shiro.authc.UnknownAccountException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.shiro.authc.UsernamePasswordToken</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.shiro.mgt.DefaultSecurityManager</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.shiro.realm.text.IniRealm</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.shiro.subject.Subject</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">test01</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">//1.创建安全管理器对象
</span><span class="c1"></span>        <span class="n">DefaultSecurityManager</span> <span class="n">securityManager</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DefaultSecurityManager</span><span class="o">();</span>
        <span class="c1">//2.给安全管理器设置realm
</span><span class="c1"></span>        <span class="n">securityManager</span><span class="o">.</span><span class="na">setRealm</span><span class="o">(</span><span class="k">new</span> <span class="n">IniRealm</span><span class="o">(</span><span class="s">&#34;classpath:shiro.ini&#34;</span><span class="o">));</span>
        <span class="c1">//3.SecurityUtils给全局安全工具类设置安全管理器
</span><span class="c1"></span>        <span class="n">SecurityUtils</span><span class="o">.</span><span class="na">setSecurityManager</span><span class="o">(</span><span class="n">securityManager</span><span class="o">);</span>
        <span class="c1">//4.关键对象subject主体
</span><span class="c1"></span>        <span class="n">Subject</span> <span class="n">subject</span> <span class="o">=</span> <span class="n">SecurityUtils</span><span class="o">.</span><span class="na">getSubject</span><span class="o">();</span>
        <span class="c1">//5.创建令牌
</span><span class="c1"></span>        <span class="n">UsernamePasswordToken</span> <span class="n">token</span> <span class="o">=</span> <span class="k">new</span> <span class="n">UsernamePasswordToken</span><span class="o">(</span><span class="s">&#34;zhangsan&#34;</span><span class="o">,</span><span class="s">&#34;123789&#34;</span><span class="o">);</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;认证状态&#34;</span><span class="o">+</span><span class="n">subject</span><span class="o">.</span><span class="na">isAuthenticated</span><span class="o">());</span><span class="c1">//fasle
</span><span class="c1"></span>            <span class="c1">//用户认证
</span><span class="c1"></span>            <span class="n">subject</span><span class="o">.</span><span class="na">login</span><span class="o">(</span><span class="n">token</span><span class="o">);</span>
            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;认证状态&#34;</span><span class="o">+</span><span class="n">subject</span><span class="o">.</span><span class="na">isAuthenticated</span><span class="o">());</span>
        <span class="o">}</span><span class="k">catch</span> <span class="o">(</span><span class="n">UnknownAccountException</span> <span class="n">e</span><span class="o">){</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;认证失败，用户名不存在&#34;</span><span class="o">);</span>
        <span class="o">}</span><span class="k">catch</span> <span class="o">(</span><span class="n">IncorrectCredentialsException</span> <span class="n">e</span><span class="o">){</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;认证失败，密码错误&#34;</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div><h4 id="4常见的异常类型">4.常见的异常类型</h4>
<ul>
<li>DisabledAccountException（帐号被禁用）</li>
<li>LockedAccountException（帐号被锁定）</li>
<li>ExcessiveAttemptsException（登录失败次数过多）</li>
<li>ExpiredCredentialsException（凭证过期）等</li>
</ul>
<h3 id="45-自定义realm">4.5 自定义Realm</h3>
<p>通过分析源码可得：</p>
<blockquote>
<p>认证：</p>
<p>1.最终执行用户名比较是 在SimpleAccountRealm类 的 doGetAuthenticationInfo 方法中完成用户名校验</p>
<p>2.最终密码校验是在 AuthenticatingRealm类 的 assertCredentialsMatch方法 中</p>
<p>总结：</p>
<p>AuthenticatingRealm 认证realm doGetAuthenticationInf</p>
<p>AuthorizingRealm 授权realm doGetAuthorizationInfo</p>
</blockquote>
<p>自定义Realm的作用：放弃使用<code>.ini</code>文件，使用数据库查询</p>
<p>上边的程序使用的是Shiro自带的IniRealm，IniRealm从ini配置文件中读取用户的信息，大部分情况下需要从系统的数据库中读取用户信息，所以需要自定义realm。</p>
<h4 id="1shiro提供的realm">1.shiro提供的Realm</h4>
<p><img src="/shiro.assets/image-20210607153552019.png" alt="image-20210607153552019"></p>
<h4 id="2根据认证源码认证使用的是simpleaccountrealm">2.根据认证源码认证使用的是SimpleAccountRealm</h4>
<p><img src="/shiro.assets/image-20210607153610827.png" alt="image-20210607153610827"></p>
<p>SimpleAccountRealm的部分源码中有两个方法一个是 认证 一个是 授权,</p>
<p>源码部分：</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">SimpleAccountRealm</span> <span class="kd">extends</span> <span class="n">AuthorizingRealm</span> <span class="o">{</span>
		<span class="c1">//.......省略
</span><span class="c1"></span>    <span class="kd">protected</span> <span class="n">AuthenticationInfo</span> <span class="nf">doGetAuthenticationInfo</span><span class="o">(</span><span class="n">AuthenticationToken</span> <span class="n">token</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">AuthenticationException</span> <span class="o">{</span>
        <span class="n">UsernamePasswordToken</span> <span class="n">upToken</span> <span class="o">=</span> <span class="o">(</span><span class="n">UsernamePasswordToken</span><span class="o">)</span> <span class="n">token</span><span class="o">;</span>
        <span class="n">SimpleAccount</span> <span class="n">account</span> <span class="o">=</span> <span class="n">getUser</span><span class="o">(</span><span class="n">upToken</span><span class="o">.</span><span class="na">getUsername</span><span class="o">());</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">account</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>

            <span class="k">if</span> <span class="o">(</span><span class="n">account</span><span class="o">.</span><span class="na">isLocked</span><span class="o">())</span> <span class="o">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="n">LockedAccountException</span><span class="o">(</span><span class="s">&#34;Account [&#34;</span> <span class="o">+</span> <span class="n">account</span> <span class="o">+</span> <span class="s">&#34;] is locked.&#34;</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">account</span><span class="o">.</span><span class="na">isCredentialsExpired</span><span class="o">())</span> <span class="o">{</span>
                <span class="n">String</span> <span class="n">msg</span> <span class="o">=</span> <span class="s">&#34;The credentials for account [&#34;</span> <span class="o">+</span> <span class="n">account</span> <span class="o">+</span> <span class="s">&#34;] are expired&#34;</span><span class="o">;</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="n">ExpiredCredentialsException</span><span class="o">(</span><span class="n">msg</span><span class="o">);</span>
            <span class="o">}</span>

        <span class="o">}</span>

        <span class="k">return</span> <span class="n">account</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">protected</span> <span class="n">AuthorizationInfo</span> <span class="nf">doGetAuthorizationInfo</span><span class="o">(</span><span class="n">PrincipalCollection</span> <span class="n">principals</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">String</span> <span class="n">username</span> <span class="o">=</span> <span class="n">getUsername</span><span class="o">(</span><span class="n">principals</span><span class="o">);</span>
        <span class="n">USERS_LOCK</span><span class="o">.</span><span class="na">readLock</span><span class="o">().</span><span class="na">lock</span><span class="o">();</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">users</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">username</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
            <span class="n">USERS_LOCK</span><span class="o">.</span><span class="na">readLock</span><span class="o">().</span><span class="na">unlock</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div><h4 id="3自定义realm">3.自定义realm</h4>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kn">package</span> <span class="nn">com.lut.realm</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.apache.shiro.authc.AuthenticationException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.shiro.authc.AuthenticationInfo</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.shiro.authc.AuthenticationToken</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.shiro.authc.SimpleAuthenticationInfo</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.shiro.authz.AuthorizationInfo</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.shiro.realm.AuthorizingRealm</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.shiro.subject.PrincipalCollection</span><span class="o">;</span>

<span class="cm">/**
</span><span class="cm"> * 自定义Realm
</span><span class="cm"> */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">CustomerRealm</span> <span class="kd">extends</span> <span class="n">AuthorizingRealm</span> <span class="o">{</span>
    <span class="c1">//授权
</span><span class="c1"></span>    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="n">AuthorizationInfo</span> <span class="nf">doGetAuthorizationInfo</span><span class="o">(</span><span class="n">PrincipalCollection</span> <span class="n">principals</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;==================&#34;</span><span class="o">);</span>
        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="c1">//认证
</span><span class="c1"></span>    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="n">AuthenticationInfo</span> <span class="nf">doGetAuthenticationInfo</span><span class="o">(</span><span class="n">AuthenticationToken</span> <span class="n">token</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">AuthenticationException</span> <span class="o">{</span>
        <span class="c1">//在token中获取 用户名
</span><span class="c1"></span>        <span class="n">String</span> <span class="n">principal</span> <span class="o">=</span> <span class="o">(</span><span class="n">String</span><span class="o">)</span> <span class="n">token</span><span class="o">.</span><span class="na">getPrincipal</span><span class="o">();</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">principal</span><span class="o">);</span>

        <span class="c1">//实际开发中应当 根据身份信息使用jdbc mybatis查询相关数据库
</span><span class="c1"></span>        <span class="c1">//在这里只做简单的演示
</span><span class="c1"></span>        <span class="c1">//假设username,password是从数据库获得的信息
</span><span class="c1"></span>        <span class="n">String</span> <span class="n">username</span><span class="o">=</span><span class="s">&#34;zhangsan&#34;</span><span class="o">;</span>
        <span class="n">String</span> <span class="n">password</span><span class="o">=</span><span class="s">&#34;123456&#34;</span><span class="o">;</span>
        <span class="k">if</span><span class="o">(</span><span class="n">username</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">principal</span><span class="o">)){</span>
            <span class="c1">//参数1:返回数据库中正确的用户名
</span><span class="c1"></span>            <span class="c1">//参数2:返回数据库中正确密码
</span><span class="c1"></span>            <span class="c1">//参数3:提供当前realm的名字 this.getName();
</span><span class="c1"></span>            <span class="n">SimpleAuthenticationInfo</span> <span class="n">simpleAuthenticationInfo</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SimpleAuthenticationInfo</span><span class="o">(</span><span class="n">principal</span><span class="o">,</span><span class="n">password</span><span class="o">,</span><span class="k">this</span><span class="o">.</span><span class="na">getName</span><span class="o">());</span>
            <span class="k">return</span> <span class="n">simpleAuthenticationInfo</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div><h4 id="4使用自定义realm认证">4.使用自定义Realm认证</h4>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kn">package</span> <span class="nn">com.lut.test</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.lut.realm.CustomerRealm</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.shiro.SecurityUtils</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.shiro.authc.IncorrectCredentialsException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.shiro.authc.UnknownAccountException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.shiro.authc.UsernamePasswordToken</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.shiro.mgt.DefaultSecurityManager</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.shiro.subject.Subject</span><span class="o">;</span>

<span class="cm">/**
</span><span class="cm"> * 测试自定义的Realm
</span><span class="cm"> */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TestAuthenticatorCusttomerRealm</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">//1.创建安全管理对象 securityManager
</span><span class="c1"></span>        <span class="n">DefaultSecurityManager</span> <span class="n">defaultSecurityManager</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DefaultSecurityManager</span><span class="o">();</span>

        <span class="c1">//2.给安全管理器设置realm（设置为自定义realm获取认证数据）
</span><span class="c1"></span>        <span class="n">defaultSecurityManager</span><span class="o">.</span><span class="na">setRealm</span><span class="o">(</span><span class="k">new</span> <span class="n">CustomerRealm</span><span class="o">());</span>
        <span class="c1">//IniRealm realm = new IniRealm(&#34;classpath:shiro.ini&#34;);
</span><span class="c1"></span>
        <span class="c1">//3.给安装工具类中设置默认安全管理器
</span><span class="c1"></span>        <span class="n">SecurityUtils</span><span class="o">.</span><span class="na">setSecurityManager</span><span class="o">(</span><span class="n">defaultSecurityManager</span><span class="o">);</span>

        <span class="c1">//4.获取主体对象subject
</span><span class="c1"></span>        <span class="n">Subject</span> <span class="n">subject</span> <span class="o">=</span> <span class="n">SecurityUtils</span><span class="o">.</span><span class="na">getSubject</span><span class="o">();</span>

        <span class="c1">//5.创建token令牌
</span><span class="c1"></span>        <span class="n">UsernamePasswordToken</span> <span class="n">token</span> <span class="o">=</span> <span class="k">new</span> <span class="n">UsernamePasswordToken</span><span class="o">(</span><span class="s">&#34;zhangsan&#34;</span><span class="o">,</span> <span class="s">&#34;123&#34;</span><span class="o">);</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">subject</span><span class="o">.</span><span class="na">login</span><span class="o">(</span><span class="n">token</span><span class="o">);</span><span class="c1">//用户登录
</span><span class="c1"></span>            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;登录成功~~&#34;</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">UnknownAccountException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;用户名错误!!&#34;</span><span class="o">);</span>
        <span class="o">}</span><span class="k">catch</span> <span class="o">(</span><span class="n">IncorrectCredentialsException</span> <span class="n">e</span><span class="o">){</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;密码错误!!!&#34;</span><span class="o">);</span>
        <span class="o">}</span>

    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div><h3 id="46-使用md5salthash">4.6 使用MD5+Salt+Hash</h3>
<p><strong>补充：MD5算法</strong></p>
<p>作用：一般用来加密或者签名（校验和）</p>
<p>特点：MD5算法不可逆如何内容相同无论执行多少次md5生成结果始终是一致</p>
<p>网络上提供的MD5在线解密一般是用穷举的方法</p>
<p>生成结果：始终是一个16进制32位长度字符串</p>
<p><strong>MD5的基本使用：</strong></p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kn">package</span> <span class="nn">com.lut.test</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.apache.shiro.crypto.hash.Md5Hash</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TestShiroMD5</span> <span class="o">{</span>
    
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>

        <span class="c1">//使用md5
</span><span class="c1"></span>        <span class="n">Md5Hash</span> <span class="n">md5Hash</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Md5Hash</span><span class="o">(</span><span class="s">&#34;123&#34;</span><span class="o">);</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">md5Hash</span><span class="o">.</span><span class="na">toHex</span><span class="o">());</span>

        <span class="c1">//使用MD5 + salt处理
</span><span class="c1"></span>        <span class="n">Md5Hash</span> <span class="n">md5Hash1</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Md5Hash</span><span class="o">(</span><span class="s">&#34;123&#34;</span><span class="o">,</span> <span class="s">&#34;X0*7ps&#34;</span><span class="o">);</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">md5Hash1</span><span class="o">.</span><span class="na">toHex</span><span class="o">());</span>

        <span class="c1">//使用md5 + salt + hash散列（参数代表要散列多少次，一般是 1024或2048）
</span><span class="c1"></span>        <span class="n">Md5Hash</span> <span class="n">md5Hash2</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Md5Hash</span><span class="o">(</span><span class="s">&#34;123&#34;</span><span class="o">,</span> <span class="s">&#34;X0*7ps&#34;</span><span class="o">,</span> <span class="n">1024</span><span class="o">);</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">md5Hash2</span><span class="o">.</span><span class="na">toHex</span><span class="o">());</span>

    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div><p>输出结果：</p>
<pre><code>202cb962ac59075b964b07152d234b70
bad42e603db5b50a78d600917c2b9821
7268f6d32ec8d6f4c305ae92395b00e8
</code></pre><blockquote>
<p>实际应用：将 盐和散列 后的值存在数据库中，自动realm从数据库取出盐和加密后的值由shiro完成密码校验。</p>
</blockquote>
<h4 id="1自定义md5salt的realm">1.自定义md5+salt的realm</h4>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kn">package</span> <span class="nn">com.lut.realm</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.apache.shiro.authc.AuthenticationException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.shiro.authc.AuthenticationInfo</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.shiro.authc.AuthenticationToken</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.shiro.authc.SimpleAuthenticationInfo</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.shiro.authz.AuthorizationInfo</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.shiro.authz.SimpleAuthorizationInfo</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.shiro.realm.AuthorizingRealm</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.shiro.subject.PrincipalCollection</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.shiro.util.ByteSource</span><span class="o">;</span>

<span class="cm">/**
</span><span class="cm"> * 使用自定义realm 加入md5 + salt +hash
</span><span class="cm"> */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">CustomerMd5Realm</span> <span class="kd">extends</span> <span class="n">AuthorizingRealm</span> <span class="o">{</span>

    <span class="c1">//授权
</span><span class="c1"></span>    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="n">AuthorizationInfo</span> <span class="nf">doGetAuthorizationInfo</span><span class="o">(</span><span class="n">PrincipalCollection</span> <span class="n">principals</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="n">AuthenticationInfo</span> <span class="nf">doGetAuthenticationInfo</span><span class="o">(</span><span class="n">AuthenticationToken</span> <span class="n">token</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">AuthenticationException</span> <span class="o">{</span>
        <span class="c1">//获取 token中的 用户名
</span><span class="c1"></span>        <span class="n">String</span> <span class="n">principal</span> <span class="o">=</span> <span class="o">(</span><span class="n">String</span><span class="o">)</span> <span class="n">token</span><span class="o">.</span><span class="na">getPrincipal</span><span class="o">();</span>

        <span class="c1">//假设这是从数据库查询到的信息
</span><span class="c1"></span>        <span class="n">String</span> <span class="n">username</span><span class="o">=</span><span class="s">&#34;zhangsan&#34;</span><span class="o">;</span>
        <span class="n">String</span> <span class="n">password</span><span class="o">=</span><span class="s">&#34;7268f6d32ec8d6f4c305ae92395b00e8&#34;</span><span class="o">;</span><span class="c1">//加密后
</span><span class="c1"></span>
        <span class="c1">//根据用户名查询数据库
</span><span class="c1"></span>        <span class="k">if</span> <span class="o">(</span><span class="n">username</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">principal</span><span class="o">))</span> <span class="o">{</span>
            <span class="c1">//参数1:数据库用户名
</span><span class="c1"></span>            <span class="c1">//参数2:数据库md5+salt之后的密码
</span><span class="c1"></span>            <span class="c1">//参数3:注册时的随机盐
</span><span class="c1"></span>            <span class="c1">//参数4:realm的名字
</span><span class="c1"></span>            <span class="k">return</span> <span class="k">new</span> <span class="n">SimpleAuthenticationInfo</span><span class="o">(</span><span class="n">principal</span><span class="o">,</span>
                    <span class="n">password</span><span class="o">,</span>
                    <span class="n">ByteSource</span><span class="o">.</span><span class="na">Util</span><span class="o">.</span><span class="na">bytes</span><span class="o">(</span><span class="s">&#34;@#$*&amp;QU7O0!&#34;</span><span class="o">),</span>
                    <span class="k">this</span><span class="o">.</span><span class="na">getName</span><span class="o">());</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div><h4 id="2使用md5salt-认证">2.使用md5+salt 认证</h4>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kn">package</span> <span class="nn">com.lut.test</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.lut.realm.CustomerMd5Realm</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.shiro.SecurityUtils</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.shiro.authc.IncorrectCredentialsException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.shiro.authc.UnknownAccountException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.shiro.authc.UsernamePasswordToken</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.shiro.authc.credential.HashedCredentialsMatcher</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.shiro.mgt.DefaultSecurityManager</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.shiro.subject.Subject</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.Arrays</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TestCustomerMd5RealmAuthenicator</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>

        <span class="c1">//1.创建安全管理器
</span><span class="c1"></span>        <span class="n">DefaultSecurityManager</span> <span class="n">defaultSecurityManager</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DefaultSecurityManager</span><span class="o">();</span>

        <span class="c1">//2.注入realm
</span><span class="c1"></span>        <span class="n">CustomerMd5Realm</span> <span class="n">realm</span> <span class="o">=</span> <span class="k">new</span> <span class="n">CustomerMd5Realm</span><span class="o">();</span>

        <span class="c1">//3.设置realm使用hash凭证匹配器
</span><span class="c1"></span>        <span class="n">HashedCredentialsMatcher</span> <span class="n">credentialsMatcher</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashedCredentialsMatcher</span><span class="o">();</span>
        <span class="c1">//声明：使用的算法
</span><span class="c1"></span>        <span class="n">credentialsMatcher</span><span class="o">.</span><span class="na">setHashAlgorithmName</span><span class="o">(</span><span class="s">&#34;md5&#34;</span><span class="o">);</span>
        <span class="c1">//声明：散列次数
</span><span class="c1"></span>        <span class="n">credentialsMatcher</span><span class="o">.</span><span class="na">setHashIterations</span><span class="o">(</span><span class="n">1024</span><span class="o">);</span>
        <span class="n">realm</span><span class="o">.</span><span class="na">setCredentialsMatcher</span><span class="o">(</span><span class="n">credentialsMatcher</span><span class="o">);</span>
        <span class="n">defaultSecurityManager</span><span class="o">.</span><span class="na">setRealm</span><span class="o">(</span><span class="n">realm</span><span class="o">);</span>

        <span class="c1">//4.将安全管理器注入安全工具
</span><span class="c1"></span>        <span class="n">SecurityUtils</span><span class="o">.</span><span class="na">setSecurityManager</span><span class="o">(</span><span class="n">defaultSecurityManager</span><span class="o">);</span>

        <span class="c1">//5.通过安全工具类获取subject
</span><span class="c1"></span>        <span class="n">Subject</span> <span class="n">subject</span> <span class="o">=</span> <span class="n">SecurityUtils</span><span class="o">.</span><span class="na">getSubject</span><span class="o">();</span>

        <span class="c1">//6.认证
</span><span class="c1"></span>        <span class="n">UsernamePasswordToken</span> <span class="n">token</span> <span class="o">=</span> <span class="k">new</span> <span class="n">UsernamePasswordToken</span><span class="o">(</span><span class="s">&#34;zhangsan&#34;</span><span class="o">,</span> <span class="s">&#34;123&#34;</span><span class="o">);</span>

        <span class="k">try</span> <span class="o">{</span>
            <span class="n">subject</span><span class="o">.</span><span class="na">login</span><span class="o">(</span><span class="n">token</span><span class="o">);</span>
            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;登录成功&#34;</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">UnknownAccountException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;用户名错误&#34;</span><span class="o">);</span>
        <span class="o">}</span><span class="k">catch</span> <span class="o">(</span><span class="n">IncorrectCredentialsException</span> <span class="n">e</span><span class="o">){</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;密码错误&#34;</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div><h2 id="五shiro中的授权">五、shiro中的授权</h2>
<h3 id="51-授权">5.1 授权</h3>
<p>授权，即访问控制，控制谁能访问哪些资源。主体进行身份认证后需要分配权限方可访问系统的资源，对于某些资源没有权限是无法访问的。</p>
<h3 id="52-关键对象">5.2 关键对象</h3>
<p><strong>授权可简单理解为who对what(which)进行How操作：</strong></p>
<p><code>Who，即主体（Subject）</code>，主体需要访问系统中的资源。</p>
<p><code>What，即资源（Resource)</code>，如系统菜单、页面、按钮、类方法、系统商品信息等。资源包括<code>资源类型</code>和<code>资源实例</code>，比如<code>商品信息为资源类型</code>，类型为t01的商品为<code>资源实例</code>，编号为001的商品信息也属于资源实例。</p>
<p><code>How，权限/许可（Permission)</code>，规定了主体对资源的操作许可，权限离开资源没有意义，如用户查询权限、用户添加权限、某个类方法的调用权限、编号为001用户的修改权限等，通过权限可知主体对哪些资源都有哪些操作许可。</p>
<h3 id="53-授权流程">5.3 授权流程</h3>
<p><img src="/shiro.assets/image-20210607154046297.png" alt="image-20210607154046297"></p>
<h3 id="54-授权方式">5.4 授权方式</h3>
<ul>
<li>
<p><strong>基于角色的访问控制</strong></p>
<p>RBAC基于角色的访问控制（Role-Based Access Control）是以角色为中心进行访问控制</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="k">if</span><span class="o">(</span><span class="n">subject</span><span class="o">.</span><span class="na">hasRole</span><span class="o">(</span><span class="s">&#34;admin&#34;</span><span class="o">)){</span>
   <span class="c1">//操作什么资源
</span><span class="c1"></span><span class="o">}</span>
</code></pre></div></li>
<li>
<p><strong>基于资源的访问控制</strong></p>
<p>RBAC基于资源的访问控制（Resource-Based Access Control）是以资源为中心进行访问控制</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="k">if</span><span class="o">(</span><span class="n">subject</span><span class="o">.</span><span class="na">isPermission</span><span class="o">(</span><span class="s">&#34;user:update:01&#34;</span><span class="o">)){</span> <span class="c1">//资源实例
</span><span class="c1"></span>  <span class="c1">//对资源01用户具有修改的权限
</span><span class="c1"></span><span class="o">}</span>
<span class="k">if</span><span class="o">(</span><span class="n">subject</span><span class="o">.</span><span class="na">isPermission</span><span class="o">(</span><span class="s">&#34;user:update:*&#34;</span><span class="o">)){</span>  <span class="c1">//资源类型
</span><span class="c1"></span>  <span class="c1">//对 所有的资源 用户具有更新的权限
</span><span class="c1"></span><span class="o">}</span>
</code></pre></div></li>
</ul>
<p><strong>以下是千锋杨涛总结：</strong></p>
<blockquote>
<p>用户登录成功之后，要进行响应的操作就需要有对应的权限；在进行操作之前对权限进行检查—授权</p>
<p>权限控制通常有两类做法：</p>
<ul>
<li>不同身份的用户登录，我们现在不同的操作菜单（没有权限的菜单不现实）</li>
<li>对所有用户显示所有菜单，当用户点击菜单以后再验证当前用户是否有此权限，如果没有则提示权限不足</li>
</ul>
</blockquote>
<ul>
<li>
<p>HTML授权</p>
<ul>
<li>
<p>在菜单页面只显示当前用户拥有权限操作的菜单</p>
</li>
<li>
<p>shiro标签</p>
<pre><code class="language-jsp" data-lang="jsp">&lt;shiro:hasPermission name=&quot;sys:c:save&quot;&gt;
    &lt;dd&gt;&lt;a href=&quot;javascript:;&quot;&gt;入库&lt;/a&gt;&lt;/dd&gt;
&lt;/shiro:hasPermission&gt;
</code></pre></li>
</ul>
</li>
<li>
<p>4.2 过滤器授权</p>
<ul>
<li>
<p>在shiro过滤器中对请求的url进行权限设置</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="n">filterMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&#34;/c_add.html&#34;</span><span class="o">,</span><span class="s">&#34;perms[sys:c:save]&#34;</span><span class="o">);</span>
    
<span class="c1">//设置未授权访问的页面路径—当权限不足时显示此页面
</span><span class="c1"></span><span class="n">filter</span><span class="o">.</span><span class="na">setUnauthorizedUrl</span><span class="o">(</span><span class="s">&#34;/lesspermission.html&#34;</span><span class="o">);</span>
</code></pre></div></li>
</ul>
</li>
<li>
<p>4.3 注解授权</p>
<ul>
<li>
<p>配置Spring对Shiro注解的支持：ShiroConfig.java</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="nd">@Bean</span>
<span class="kd">public</span> <span class="n">DefaultAdvisorAutoProxyCreator</span> <span class="nf">getDefaultAdvisorAutoProxyCreator</span><span class="o">(){</span>
    <span class="n">DefaultAdvisorAutoProxyCreator</span> <span class="n">autoProxyCreator</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DefaultAdvisorAutoProxyCreator</span><span class="o">();</span>
    <span class="n">autoProxyCreator</span><span class="o">.</span><span class="na">setProxyTargetClass</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
    <span class="k">return</span> <span class="n">autoProxyCreator</span><span class="o">;</span>
<span class="o">}</span>
    
<span class="nd">@Bean</span>
<span class="kd">public</span> <span class="n">AuthorizationAttributeSourceAdvisor</span> <span class="nf">getAuthorizationAttributeSourceAdvisor</span><span class="o">(</span> <span class="n">DefaultWebSecurityManager</span> <span class="n">securityManager</span><span class="o">){</span>
    <span class="n">AuthorizationAttributeSourceAdvisor</span> <span class="n">advisor</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AuthorizationAttributeSourceAdvisor</span><span class="o">();</span>
    <span class="n">advisor</span><span class="o">.</span><span class="na">setSecurityManager</span><span class="o">(</span><span class="n">securityManager</span><span class="o">);</span>
    <span class="k">return</span> <span class="n">advisor</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></li>
<li>
<p>在请求的控制器添加权限注解</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="nd">@Controller</span>
<span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">&#34;customer&#34;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">CustomerController</span> <span class="o">{</span>
    
    <span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">&#34;list&#34;</span><span class="o">)</span>
    <span class="c1">//如果没有 sys:k:find 权限，则不允许执行此方法
</span><span class="c1"></span>    <span class="nd">@RequiresPermissions</span><span class="o">(</span><span class="s">&#34;sys:k:find&#34;</span><span class="o">)</span>
    <span class="c1">//    @RequiresRoles(&#34;&#34;)
</span><span class="c1"></span>    <span class="kd">public</span> <span class="n">String</span> <span class="nf">list</span><span class="o">(){</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;-----------&gt;查询客户信息&#34;</span><span class="o">);</span>
        <span class="k">return</span> <span class="s">&#34;customer_list&#34;</span><span class="o">;</span>
    <span class="o">}</span>
    
<span class="o">}</span>
</code></pre></div></li>
<li>
<p>通过全局异常处理，指定权限不足时的页面跳转</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="nd">@ControllerAdvice</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">GlobalExceptionHandler</span> <span class="o">{</span>
    
    <span class="nd">@ExceptionHandler</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">doException</span><span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">){</span>
        <span class="k">if</span><span class="o">(</span><span class="n">e</span> <span class="k">instanceof</span> <span class="n">AuthorizationException</span><span class="o">){</span>
            <span class="k">return</span>  <span class="s">&#34;lesspermission&#34;</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></li>
</ul>
</li>
<li>
<p>4.4 手动授权</p>
<ul>
<li>
<p>在代码中进行手动的权限校验</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="n">Subject</span> <span class="n">subject</span> <span class="o">=</span> <span class="n">SecurityUtils</span><span class="o">.</span><span class="na">getSubject</span><span class="o">();</span>
<span class="k">if</span><span class="o">(</span><span class="n">subject</span><span class="o">.</span><span class="na">isPermitted</span><span class="o">(</span><span class="s">&#34;sys:k:find&#34;</span><span class="o">)){</span>
    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;-----------&gt;查询客户信息&#34;</span><span class="o">);</span>
    <span class="k">return</span> <span class="s">&#34;customer_list&#34;</span><span class="o">;</span>
<span class="o">}</span><span class="k">else</span><span class="o">{</span>
    <span class="k">return</span> <span class="s">&#34;lesspermission&#34;</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></li>
</ul>
</li>
</ul>
<h3 id="55-权限字符串">5.5 权限字符串</h3>
<p>权限字符串的规则是：<strong>资源标识符：操作：资源实例标识符</strong>，意思是对哪个资源的哪个实例具有什么操作，“:”是资源/操作/实例的分割符，权限字符串也可以使用*通配符。</p>
<p>例子：</p>
<ul>
<li>用户创建权限：user:create，或user:create:*</li>
<li>用户修改实例001的权限：user:update:001</li>
<li>用户实例001的所有权限：user:*:001</li>
</ul>
<h3 id="56-shiro中授权编程实现方式">5.6 shiro中授权编程实现方式</h3>
<ul>
<li>
<p><strong>编程式</strong></p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="n">Subject</span> <span class="n">subject</span> <span class="o">=</span> <span class="n">SecurityUtils</span><span class="o">.</span><span class="na">getSubject</span><span class="o">();</span>
<span class="k">if</span><span class="o">(</span><span class="n">subject</span><span class="o">.</span><span class="na">hasRole</span><span class="o">(</span><span class="err">“</span><span class="n">admin</span><span class="err">”</span><span class="o">))</span> <span class="o">{</span>
  <span class="c1">//有权限
</span><span class="c1"></span><span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
  <span class="c1">//无权限
</span><span class="c1"></span><span class="o">}</span>
</code></pre></div></li>
<li>
<p><strong>注解式</strong></p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="nd">@RequiresRoles</span><span class="o">(</span><span class="s">&#34;admin&#34;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">hello</span><span class="o">()</span> <span class="o">{</span>
  <span class="c1">//有权限
</span><span class="c1"></span><span class="o">}</span>
</code></pre></div></li>
<li>
<p><strong>标签式</strong></p>
<pre><code class="language-jsp" data-lang="jsp">JSP/GSP 标签：在JSP/GSP 页面通过相应的标签完成：
&lt;shiro:hasRole name=&quot;admin&quot;&gt;
  &lt;!— 有权限—&gt;
&lt;/shiro:hasRole&gt;
注意: Thymeleaf 中使用shiro需要额外集成!
</code></pre></li>
</ul>
<h3 id="57-开发授权">5.7 开发授权</h3>
<h4 id="1realm的实现">1.realm的实现</h4>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kn">package</span> <span class="nn">com.lut.realm</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.apache.shiro.authc.AuthenticationException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.shiro.authc.AuthenticationInfo</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.shiro.authc.AuthenticationToken</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.shiro.authc.SimpleAuthenticationInfo</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.shiro.authz.AuthorizationInfo</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.shiro.authz.SimpleAuthorizationInfo</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.shiro.realm.AuthorizingRealm</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.shiro.subject.PrincipalCollection</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.shiro.util.ByteSource</span><span class="o">;</span>


<span class="cm">/**
</span><span class="cm"> * 使用自定义realm 加入md5 + salt +hash
</span><span class="cm"> * 实现授权操作
</span><span class="cm"> */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">CustomerMd5Realm</span> <span class="kd">extends</span> <span class="n">AuthorizingRealm</span> <span class="o">{</span>

    <span class="c1">//授权
</span><span class="c1"></span>    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="n">AuthorizationInfo</span> <span class="nf">doGetAuthorizationInfo</span><span class="o">(</span><span class="n">PrincipalCollection</span> <span class="n">principals</span><span class="o">)</span> <span class="o">{</span>

        <span class="n">String</span> <span class="n">primaryPrincipal</span> <span class="o">=</span> <span class="o">(</span><span class="n">String</span><span class="o">)</span><span class="n">principals</span><span class="o">.</span><span class="na">getPrimaryPrincipal</span><span class="o">();</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;身份信息: &#34;</span><span class="o">+</span><span class="n">primaryPrincipal</span><span class="o">);</span> <span class="c1">//用户名
</span><span class="c1"></span>
        <span class="c1">//根据身份信息 用户名 获取当前用户的角色信息，以及权限信息
</span><span class="c1"></span>        <span class="n">SimpleAuthorizationInfo</span> <span class="n">simpleAuthorizationInfo</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SimpleAuthorizationInfo</span><span class="o">();</span>
        <span class="c1">//假设 admin,user 是从数据库查到的 角色信息
</span><span class="c1"></span>        <span class="n">simpleAuthorizationInfo</span><span class="o">.</span><span class="na">addRole</span><span class="o">(</span><span class="s">&#34;admin&#34;</span><span class="o">);</span>
        <span class="n">simpleAuthorizationInfo</span><span class="o">.</span><span class="na">addRole</span><span class="o">(</span><span class="s">&#34;user&#34;</span><span class="o">);</span>
        <span class="c1">//假设 ... 是从数据库查到的 权限信息赋值给权限对象
</span><span class="c1"></span>        <span class="n">simpleAuthorizationInfo</span><span class="o">.</span><span class="na">addStringPermission</span><span class="o">(</span><span class="s">&#34;user:*:01&#34;</span><span class="o">);</span>
        <span class="n">simpleAuthorizationInfo</span><span class="o">.</span><span class="na">addStringPermission</span><span class="o">(</span><span class="s">&#34;prodect:*&#34;</span><span class="o">);</span><span class="c1">//第三个参数为*省略
</span><span class="c1"></span>
        <span class="k">return</span> <span class="n">simpleAuthorizationInfo</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="c1">//认证
</span><span class="c1"></span>    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="n">AuthenticationInfo</span> <span class="nf">doGetAuthenticationInfo</span><span class="o">(</span><span class="n">AuthenticationToken</span> <span class="n">token</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">AuthenticationException</span> <span class="o">{</span>
        <span class="c1">//获取 token中的 用户名
</span><span class="c1"></span>        <span class="n">String</span> <span class="n">principal</span> <span class="o">=</span> <span class="o">(</span><span class="n">String</span><span class="o">)</span> <span class="n">token</span><span class="o">.</span><span class="na">getPrincipal</span><span class="o">();</span>

        <span class="c1">//假设这是从数据库查询到的信息
</span><span class="c1"></span>        <span class="n">String</span> <span class="n">username</span><span class="o">=</span><span class="s">&#34;zhangsan&#34;</span><span class="o">;</span>
        <span class="n">String</span> <span class="n">password</span><span class="o">=</span><span class="s">&#34;7268f6d32ec8d6f4c305ae92395b00e8&#34;</span><span class="o">;</span><span class="c1">//加密后
</span><span class="c1"></span>
        <span class="c1">//根据用户名查询数据库
</span><span class="c1"></span>        <span class="k">if</span> <span class="o">(</span><span class="n">username</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">principal</span><span class="o">))</span> <span class="o">{</span>
            <span class="c1">//参数1:数据库用户名
</span><span class="c1"></span>            <span class="c1">//参数2:数据库md5+salt之后的密码
</span><span class="c1"></span>            <span class="c1">//参数3:注册时的随机盐
</span><span class="c1"></span>            <span class="c1">//参数4:realm的名字
</span><span class="c1"></span>            <span class="k">return</span> <span class="k">new</span> <span class="n">SimpleAuthenticationInfo</span><span class="o">(</span><span class="n">principal</span><span class="o">,</span>
                    <span class="n">password</span><span class="o">,</span>
                    <span class="n">ByteSource</span><span class="o">.</span><span class="na">Util</span><span class="o">.</span><span class="na">bytes</span><span class="o">(</span><span class="s">&#34;@#$*&amp;QU7O0!&#34;</span><span class="o">),</span>
                    <span class="k">this</span><span class="o">.</span><span class="na">getName</span><span class="o">());</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div><h4 id="2授权">2.授权</h4>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kn">package</span> <span class="nn">com.lut.test</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.lut.realm.CustomerMd5Realm</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.commons.collections.ArrayStack</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.shiro.SecurityUtils</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.shiro.authc.IncorrectCredentialsException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.shiro.authc.UnknownAccountException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.shiro.authc.UsernamePasswordToken</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.shiro.authc.credential.HashedCredentialsMatcher</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.shiro.mgt.DefaultSecurityManager</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.shiro.subject.Subject</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.Arrays</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TestCustomerMd5RealmAuthenicator</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>

        <span class="c1">//1.创建安全管理器
</span><span class="c1"></span>        <span class="n">DefaultSecurityManager</span> <span class="n">defaultSecurityManager</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DefaultSecurityManager</span><span class="o">();</span>

        <span class="c1">//2.注入realm
</span><span class="c1"></span>        <span class="n">CustomerMd5Realm</span> <span class="n">realm</span> <span class="o">=</span> <span class="k">new</span> <span class="n">CustomerMd5Realm</span><span class="o">();</span>

        <span class="c1">//3.设置realm使用hash凭证匹配器
</span><span class="c1"></span>        <span class="n">HashedCredentialsMatcher</span> <span class="n">credentialsMatcher</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashedCredentialsMatcher</span><span class="o">();</span>
        <span class="c1">//声明：使用的算法
</span><span class="c1"></span>        <span class="n">credentialsMatcher</span><span class="o">.</span><span class="na">setHashAlgorithmName</span><span class="o">(</span><span class="s">&#34;md5&#34;</span><span class="o">);</span>
        <span class="c1">//声明：散列次数
</span><span class="c1"></span>        <span class="n">credentialsMatcher</span><span class="o">.</span><span class="na">setHashIterations</span><span class="o">(</span><span class="n">1024</span><span class="o">);</span>
        <span class="n">realm</span><span class="o">.</span><span class="na">setCredentialsMatcher</span><span class="o">(</span><span class="n">credentialsMatcher</span><span class="o">);</span>
        <span class="n">defaultSecurityManager</span><span class="o">.</span><span class="na">setRealm</span><span class="o">(</span><span class="n">realm</span><span class="o">);</span>

        <span class="c1">//4.将安全管理器注入安全工具
</span><span class="c1"></span>        <span class="n">SecurityUtils</span><span class="o">.</span><span class="na">setSecurityManager</span><span class="o">(</span><span class="n">defaultSecurityManager</span><span class="o">);</span>

        <span class="c1">//5.通过安全工具类获取subject
</span><span class="c1"></span>        <span class="n">Subject</span> <span class="n">subject</span> <span class="o">=</span> <span class="n">SecurityUtils</span><span class="o">.</span><span class="na">getSubject</span><span class="o">();</span>

        <span class="c1">//6.认证
</span><span class="c1"></span>        <span class="n">UsernamePasswordToken</span> <span class="n">token</span> <span class="o">=</span> <span class="k">new</span> <span class="n">UsernamePasswordToken</span><span class="o">(</span><span class="s">&#34;zhangsan&#34;</span><span class="o">,</span> <span class="s">&#34;123&#34;</span><span class="o">);</span>

        <span class="k">try</span> <span class="o">{</span>
            <span class="n">subject</span><span class="o">.</span><span class="na">login</span><span class="o">(</span><span class="n">token</span><span class="o">);</span>
            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;登录成功&#34;</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">UnknownAccountException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;用户名错误&#34;</span><span class="o">);</span>
        <span class="o">}</span><span class="k">catch</span> <span class="o">(</span><span class="n">IncorrectCredentialsException</span> <span class="n">e</span><span class="o">){</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;密码错误&#34;</span><span class="o">);</span>
        <span class="o">}</span>


        <span class="c1">//授权
</span><span class="c1"></span>        <span class="k">if</span> <span class="o">(</span><span class="n">subject</span><span class="o">.</span><span class="na">isAuthenticated</span><span class="o">()){</span>

            <span class="c1">//基于角色权限控制
</span><span class="c1"></span>            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">subject</span><span class="o">.</span><span class="na">hasRole</span><span class="o">(</span><span class="s">&#34;admin&#34;</span><span class="o">));</span>
            <span class="c1">//基于多角色的权限控制
</span><span class="c1"></span>            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">subject</span><span class="o">.</span><span class="na">hasAllRoles</span><span class="o">(</span><span class="n">Arrays</span><span class="o">.</span><span class="na">asList</span><span class="o">(</span><span class="s">&#34;admin&#34;</span><span class="o">,</span> <span class="s">&#34;user&#34;</span><span class="o">)));</span><span class="c1">//true
</span><span class="c1"></span>            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">subject</span><span class="o">.</span><span class="na">hasAllRoles</span><span class="o">(</span><span class="n">Arrays</span><span class="o">.</span><span class="na">asList</span><span class="o">(</span><span class="s">&#34;admin&#34;</span><span class="o">,</span> <span class="s">&#34;manager&#34;</span><span class="o">)));</span><span class="c1">//false
</span><span class="c1"></span>            <span class="c1">//是否具有其中一个角色
</span><span class="c1"></span>            <span class="kt">boolean</span><span class="o">[]</span> <span class="n">booleans</span> <span class="o">=</span> <span class="n">subject</span><span class="o">.</span><span class="na">hasRoles</span><span class="o">(</span><span class="n">Arrays</span><span class="o">.</span><span class="na">asList</span><span class="o">(</span><span class="s">&#34;admin&#34;</span><span class="o">,</span> <span class="s">&#34;user&#34;</span><span class="o">,</span> <span class="s">&#34;manager&#34;</span><span class="o">));</span>
            <span class="k">for</span> <span class="o">(</span><span class="kt">boolean</span> <span class="n">aBoolean</span> <span class="o">:</span> <span class="n">booleans</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">aBoolean</span><span class="o">);</span>
            <span class="o">}</span>

            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;====这是一个分隔符====&#34;</span><span class="o">);</span>

            <span class="c1">//基于权限字符串的访问控制  资源标识符：操作：资源类型
</span><span class="c1"></span>            <span class="c1">//用户具有的权限 user:*:01  prodect:*
</span><span class="c1"></span>            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;权限:&#34;</span><span class="o">+</span><span class="n">subject</span><span class="o">.</span><span class="na">isPermitted</span><span class="o">(</span><span class="s">&#34;user:update:01&#34;</span><span class="o">));</span>
            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;权限:&#34;</span><span class="o">+</span><span class="n">subject</span><span class="o">.</span><span class="na">isPermitted</span><span class="o">(</span><span class="s">&#34;prodect:update:02&#34;</span><span class="o">));</span>

            <span class="c1">//分别具有哪些权限
</span><span class="c1"></span>            <span class="kt">boolean</span><span class="o">[]</span> <span class="n">permitted</span> <span class="o">=</span> <span class="n">subject</span><span class="o">.</span><span class="na">isPermitted</span><span class="o">(</span><span class="s">&#34;user:*:01&#34;</span><span class="o">,</span> <span class="s">&#34;user:update:02&#34;</span><span class="o">);</span>
            <span class="k">for</span> <span class="o">(</span><span class="kt">boolean</span> <span class="n">b</span> <span class="o">:</span> <span class="n">permitted</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">b</span><span class="o">);</span>
            <span class="o">}</span>

            <span class="c1">//同时具有哪些权限
</span><span class="c1"></span>            <span class="kt">boolean</span> <span class="n">permittedAll</span> <span class="o">=</span> <span class="n">subject</span><span class="o">.</span><span class="na">isPermittedAll</span><span class="o">(</span><span class="s">&#34;prodect:*:01&#34;</span><span class="o">,</span> <span class="s">&#34;prodect:update:03&#34;</span><span class="o">);</span>
            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">permittedAll</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div><h2 id="六整合springboot项目实战">六、整合SpringBoot项目实战</h2>
<h3 id="61-整合思路">6.1 整合思路</h3>
<p><img src="/shiro.assets/image-20210607154443368.png" alt="image-20210607154443368"></p>
<h3 id="62-配置环境">6.2 配置环境</h3>
<h4 id="1创建项目">1.创建项目</h4>
<p><img src="/shiro.assets/image-20210607154458694.png" alt="image-20210607154458694"></p>
<h4 id="2引入依赖">2.引入依赖</h4>
<div class="highlight"><pre class="chroma"><code class="language-xml" data-lang="xml"><span class="c">&lt;!--引入JSP解析依赖--&gt;</span>
<span class="nt">&lt;dependency&gt;</span>
     <span class="nt">&lt;groupId&gt;</span>org.apache.tomcat.embed<span class="nt">&lt;/groupId&gt;</span>
     <span class="nt">&lt;artifactId&gt;</span>tomcat-embed-jasper<span class="nt">&lt;/artifactId&gt;</span>
     <span class="nt">&lt;/dependency&gt;</span>
<span class="nt">&lt;dependency&gt;</span>
     <span class="nt">&lt;groupId&gt;</span>jstl<span class="nt">&lt;/groupId&gt;</span>
     <span class="nt">&lt;artifactId&gt;</span>jstl<span class="nt">&lt;/artifactId&gt;</span>
     <span class="nt">&lt;version&gt;</span>1.2<span class="nt">&lt;/version&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</code></pre></div><div class="highlight"><pre class="chroma"><code class="language-xml" data-lang="xml"><span class="c">&lt;!--引入shiro整合Springboot依赖--&gt;</span>
<span class="nt">&lt;dependency&gt;</span>
  <span class="nt">&lt;groupId&gt;</span>org.apache.shiro<span class="nt">&lt;/groupId&gt;</span>
  <span class="nt">&lt;artifactId&gt;</span>shiro-spring-boot-starter<span class="nt">&lt;/artifactId&gt;</span>
  <span class="nt">&lt;version&gt;</span>1.5.3<span class="nt">&lt;/version&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</code></pre></div><h4 id="3修改视图">3.修改视图</h4>
<p>application.properties 文件：</p>
<pre><code class="language-properties" data-lang="properties">server.port=8080
server.servlet.context-path=/shiro
spring.application.name=shiro

spring.mvc.view.prefix=/
spring.mvc.view.suffix=.jsp
</code></pre><h4 id="4修改配置">4.修改配置</h4>
<p>JSP 与IDEA 与SpringBoot存在一定的<strong>不兼容</strong>，修改此配置即可解决</p>
<p><img src="/shiro.assets/image-20210607154558348.png" alt="image-20210607154558348"></p>
<p><img src="/shiro.assets/image-20210607154605006.png" alt="image-20210607154605006"></p>
<h3 id="63-简单使用">6.3 简单使用</h3>
<h4 id="1创建配置类">1.创建配置类</h4>
<p>用来整合shiro框架相关的配置类</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kn">package</span> <span class="nn">com.lut.config</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.lut.shiro.realms.CustomerRealm</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.shiro.authc.credential.HashedCredentialsMatcher</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.shiro.realm.Realm</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.shiro.spring.web.ShiroFilterFactoryBean</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.shiro.web.mgt.DefaultWebSecurityManager</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.Bean</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.Configuration</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.HashMap</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Map</span><span class="o">;</span>

<span class="cm">/**
</span><span class="cm"> * 用来整合shiro框架相关的配置类
</span><span class="cm"> */</span>
<span class="nd">@Configuration</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ShiroConfig</span> <span class="o">{</span>

    <span class="c1">//1.创建shiroFilter  //负责拦截所有请求
</span><span class="c1"></span>    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="n">ShiroFilterFactoryBean</span> <span class="nf">getShiroFilterFactoryBean</span><span class="o">(</span><span class="n">DefaultWebSecurityManager</span> <span class="n">defaultWebSecurityManager</span><span class="o">){</span>

        <span class="n">ShiroFilterFactoryBean</span> <span class="n">shiroFilterFactoryBean</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ShiroFilterFactoryBean</span><span class="o">();</span>
        <span class="c1">//给filter设置安全管理器
</span><span class="c1"></span>        <span class="n">shiroFilterFactoryBean</span><span class="o">.</span><span class="na">setSecurityManager</span><span class="o">(</span><span class="n">defaultWebSecurityManager</span><span class="o">);</span>

        <span class="c1">//配置系统受限资源
</span><span class="c1"></span>        <span class="c1">//配置系统公共资源
</span><span class="c1"></span>        <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">map</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span><span class="n">String</span><span class="o">&gt;();</span>

        <span class="n">map</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&#34;/index.jsp&#34;</span><span class="o">,</span><span class="s">&#34;authc&#34;</span><span class="o">);</span><span class="c1">//authc 请求这个资源需要认证和授权
</span><span class="c1"></span>
        <span class="c1">//默认认证界面路径---当认证不通过时跳转
</span><span class="c1"></span>        <span class="n">shiroFilterFactoryBean</span><span class="o">.</span><span class="na">setLoginUrl</span><span class="o">(</span><span class="s">&#34;/login.jsp&#34;</span><span class="o">);</span>
        <span class="n">shiroFilterFactoryBean</span><span class="o">.</span><span class="na">setFilterChainDefinitionMap</span><span class="o">(</span><span class="n">map</span><span class="o">);</span>

        <span class="k">return</span> <span class="n">shiroFilterFactoryBean</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="c1">//2.创建安全管理器
</span><span class="c1"></span>    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="n">DefaultWebSecurityManager</span> <span class="nf">getDefaultWebSecurityManager</span><span class="o">(</span><span class="n">Realm</span> <span class="n">realm</span><span class="o">){</span>
        <span class="n">DefaultWebSecurityManager</span> <span class="n">defaultWebSecurityManager</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DefaultWebSecurityManager</span><span class="o">();</span>
        <span class="c1">//给安全管理器设置
</span><span class="c1"></span>        <span class="n">defaultWebSecurityManager</span><span class="o">.</span><span class="na">setRealm</span><span class="o">(</span><span class="n">realm</span><span class="o">);</span>

        <span class="k">return</span> <span class="n">defaultWebSecurityManager</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="c1">//3.创建自定义realm
</span><span class="c1"></span>    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="n">Realm</span> <span class="nf">getRealm</span><span class="o">(){</span>
        <span class="n">CustomerRealm</span> <span class="n">customerRealm</span> <span class="o">=</span> <span class="k">new</span> <span class="n">CustomerRealm</span><span class="o">();</span>

        <span class="k">return</span> <span class="n">customerRealm</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div><h4 id="2自定义realm">2.自定义realm</h4>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kn">package</span> <span class="nn">com.lut.shiro.realms</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.shiro.authc.AuthenticationException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.shiro.authc.AuthenticationInfo</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.shiro.authc.AuthenticationToken</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.shiro.authc.SimpleAuthenticationInfo</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.shiro.authz.AuthorizationInfo</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.shiro.authz.SimpleAuthorizationInfo</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.shiro.realm.AuthorizingRealm</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.shiro.subject.PrincipalCollection</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.util.CollectionUtils</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.util.ObjectUtils</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>


<span class="c1">//自定义realm
</span><span class="c1"></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">CustomerRealm</span> <span class="kd">extends</span> <span class="n">AuthorizingRealm</span> <span class="o">{</span>

    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="n">AuthorizationInfo</span> <span class="nf">doGetAuthorizationInfo</span><span class="o">(</span><span class="n">PrincipalCollection</span> <span class="n">principals</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="n">AuthenticationInfo</span> <span class="nf">doGetAuthenticationInfo</span><span class="o">(</span><span class="n">AuthenticationToken</span> <span class="n">token</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">AuthenticationException</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div><h4 id="3jsp文件">3.JSP文件</h4>
<p>index.jsp</p>
<pre><code class="language-jsp" data-lang="jsp">&lt;%@page contentType=&quot;text/html;utf-8&quot; pageEncoding=&quot;utf-8&quot; isELIgnored=&quot;false&quot; %&gt;
&lt;!doctype html&gt;
&lt;html lang=&quot;en&quot;&gt;
&lt;head&gt;
    &lt;meta charset=&quot;UTF-8&quot;&gt;
    &lt;meta name=&quot;viewport&quot;
          content=&quot;width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0&quot;&gt;
    &lt;meta http-equiv=&quot;X-UA-Compatible&quot; content=&quot;ie=edge&quot;&gt;
    &lt;title&gt;Document&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;%--    受限资源--%&gt;
    &lt;h1&gt;系统主页&lt;/h1&gt;
    &lt;ul&gt;
        &lt;li&gt;&lt;a href=&quot;#&quot;&gt;用户管理&lt;/a&gt;&lt;/li&gt;
        &lt;li&gt;&lt;a href=&quot;#&quot;&gt;商品管理&lt;/a&gt;&lt;/li&gt;
        &lt;li&gt;&lt;a href=&quot;#&quot;&gt;订单管理&lt;/a&gt;&lt;/li&gt;
        &lt;li&gt;&lt;a href=&quot;#&quot;&gt;物流管理&lt;/a&gt;&lt;/li&gt;
    &lt;/ul&gt;
&lt;/body&gt;
&lt;/html&gt;
</code></pre><p>login.jsp</p>
<pre><code class="language-jsp" data-lang="jsp">&lt;%@page contentType=&quot;text/html;utf-8&quot; pageEncoding=&quot;utf-8&quot; isELIgnored=&quot;false&quot; %&gt;
&lt;!doctype html&gt;
&lt;html lang=&quot;en&quot;&gt;
&lt;head&gt;
    &lt;meta charset=&quot;UTF-8&quot;&gt;
    &lt;meta name=&quot;viewport&quot;
          content=&quot;width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0&quot;&gt;
    &lt;meta http-equiv=&quot;X-UA-Compatible&quot; content=&quot;ie=edge&quot;&gt;
    &lt;title&gt;Document&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
    &lt;h1&gt;登录界面&lt;/h1&gt;
    &lt;form action=&quot;${pageContext.request.contextPath}/user/login&quot; method=&quot;post&quot;&gt;
        用户名:&lt;input type=&quot;text&quot; name=&quot;username&quot; &gt; &lt;br/&gt;
        密码  : &lt;input type=&quot;text&quot; name=&quot;password&quot;&gt; &lt;br&gt;
        &lt;input type=&quot;submit&quot; value=&quot;登录&quot;&gt;
    &lt;/form&gt;
&lt;/body&gt;
&lt;/html&gt;
</code></pre><h4 id="4简单测试">4.简单测试</h4>
<p>访问：http://localhost:8080/shiro/index.jsp</p>
<p>由于没有验证成功，会跳转到登录页面</p>
<p><img src="/shiro.assets/image-20210607154735647.png" alt="image-20210607154735647"></p>
<p>目前项目结构：</p>
<p><img src="/shiro.assets/image-20210607154746610.png" alt="image-20210607154746610"></p>
<h3 id="64-常见过滤器">6.4 常见过滤器</h3>
<p>注意: <strong>shiro提供和多个默认的过滤器，我们可以用这些过滤器来配置控制指定url的权限：</strong></p>
<table>
<thead>
<tr>
<th>配置缩写</th>
<th>对应的过滤器</th>
<th>功能</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>anon</strong></td>
<td>AnonymousFilter</td>
<td>指定url可以匿名访问（访问时不需要认证授权）</td>
</tr>
<tr>
<td><strong>authc</strong></td>
<td>FormAuthenticationFilter</td>
<td>指定url需要form表单登录，默认会从请求中获取username、password、rememberMe等参数并尝试登录，如果登录不了就会跳转到loginUrl配置的路径。我们也可以用这个过滤器做默认的登录逻辑，但是一般都是我们自己在控制器写登录逻辑的，自己写的话出错返回的信息都可以定制嘛。</td>
</tr>
<tr>
<td>authcBasic</td>
<td>BasicHttpAuthenticationFilter</td>
<td>指定url需要basic登录</td>
</tr>
<tr>
<td>logout</td>
<td>LogoutFilter</td>
<td>登出过滤器，配置指定url就可以实现退出功能，非常方便</td>
</tr>
<tr>
<td>noSessionCreation</td>
<td>NoSessionCreationFilter</td>
<td>禁止创建会话</td>
</tr>
<tr>
<td>perms</td>
<td>PermissionsAuthorizationFilter</td>
<td>需要指定权限才能访问</td>
</tr>
<tr>
<td>port</td>
<td>PortFilter</td>
<td>需要指定端口才能访问</td>
</tr>
<tr>
<td>rest</td>
<td>HttpMethodPermissionFilter</td>
<td>将http请求方法转化成相应的动词来构造一个权限字符串，这个感觉意义不大，有兴趣自己看源码的注释</td>
</tr>
<tr>
<td>roles</td>
<td>RolesAuthorizationFilter</td>
<td>需要指定角色才能访问</td>
</tr>
<tr>
<td>ssl</td>
<td>SslFilter</td>
<td>需要https请求才能访问</td>
</tr>
<tr>
<td>user</td>
<td>UserFilter</td>
<td>需要已登录或“记住我”的用户才能访问</td>
</tr>
</tbody>
</table>
<p>例子1：</p>
<p><strong>logout使用</strong></p>
<ul>
<li>
<p>在Shiro过滤器中进行配置，配置logut对应的路径</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="n">filterMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&#34;/exit&#34;</span><span class="o">,</span> <span class="s">&#34;logout&#34;</span><span class="o">);</span>
</code></pre></div></li>
<li>
<p>在页面的“退出”按钮上，跳转到logout对应的url</p>
<div class="highlight"><pre class="chroma"><code class="language-html" data-lang="html"><span class="p">&lt;</span><span class="nt">a</span> <span class="na">href</span><span class="o">=</span><span class="s">&#34;exit&#34;</span><span class="p">&gt;</span>退出<span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;</span>
</code></pre></div></li>
</ul>
<p>例子2：</p>
<p><strong>perms使用</strong></p>
<p>在shiro过滤器中对请求的url进行权限设置</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="n">filterMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&#34;/user/create&#34;</span><span class="o">,</span> <span class="s">&#34;perms[sys:c:save]&#34;</span><span class="o">);</span>
</code></pre></div><h3 id="65-认证和退出实现">6.5 认证和退出实现</h3>
<h4 id="651-登录实现">6.5.1 登录实现</h4>
<h5 id="1loginjsp">1.login.jsp</h5>
<pre><code class="language-jsp" data-lang="jsp">&lt;%@page contentType=&quot;text/html;utf-8&quot; pageEncoding=&quot;utf-8&quot; isELIgnored=&quot;false&quot; %&gt;
&lt;!doctype html&gt;
&lt;html lang=&quot;en&quot;&gt;
&lt;head&gt;
    &lt;meta charset=&quot;UTF-8&quot;&gt;
    &lt;meta name=&quot;viewport&quot;
          content=&quot;width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0&quot;&gt;
    &lt;meta http-equiv=&quot;X-UA-Compatible&quot; content=&quot;ie=edge&quot;&gt;
    &lt;title&gt;Document&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
    &lt;h1&gt;登录界面&lt;/h1&gt;
    &lt;form action=&quot;${pageContext.request.contextPath}/user/login&quot; method=&quot;post&quot;&gt;
        用户名:&lt;input type=&quot;text&quot; name=&quot;username&quot; &gt; &lt;br/&gt;
        密码  : &lt;input type=&quot;text&quot; name=&quot;password&quot;&gt; &lt;br&gt;
        &lt;input type=&quot;submit&quot; value=&quot;登录&quot;&gt;
    &lt;/form&gt;
&lt;/body&gt;
&lt;/html&gt;
</code></pre><p><img src="/shiro.assets/image-20210607155019442.png" alt="image-20210607155019442"></p>
<h5 id="2usercontroller">2.UserController</h5>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kn">package</span> <span class="nn">com.lut.controller</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.apache.shiro.SecurityUtils</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.shiro.authc.IncorrectCredentialsException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.shiro.authc.UnknownAccountException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.shiro.authc.UsernamePasswordToken</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.shiro.subject.Subject</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.beans.factory.annotation.Autowired</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.stereotype.Controller</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.RequestMapping</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">javax.servlet.ServletOutputStream</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.servlet.http.HttpServletResponse</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.servlet.http.HttpSession</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>

<span class="nd">@Controller</span>
<span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">&#34;user&#34;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">UserController</span> <span class="o">{</span>

    <span class="cm">/**
</span><span class="cm">     * 用来处理身份认证
</span><span class="cm">     * @param username
</span><span class="cm">     * @param password
</span><span class="cm">     * @return
</span><span class="cm">     */</span>
    <span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">&#34;login&#34;</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">login</span><span class="o">(</span><span class="n">String</span> <span class="n">username</span><span class="o">,</span> <span class="n">String</span> <span class="n">password</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="c1">//获取主体对象
</span><span class="c1"></span>            <span class="n">Subject</span> <span class="n">subject</span> <span class="o">=</span> <span class="n">SecurityUtils</span><span class="o">.</span><span class="na">getSubject</span><span class="o">();</span>
            <span class="n">subject</span><span class="o">.</span><span class="na">login</span><span class="o">(</span><span class="k">new</span> <span class="n">UsernamePasswordToken</span><span class="o">(</span><span class="n">username</span><span class="o">,</span> <span class="n">password</span><span class="o">));</span>
            <span class="k">return</span> <span class="s">&#34;redirect:/index.jsp&#34;</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">UnknownAccountException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;用户名错误!&#34;</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IncorrectCredentialsException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;密码错误!&#34;</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">getMessage</span><span class="o">());</span>
        <span class="o">}</span>

        <span class="k">return</span> <span class="s">&#34;redirect:/login.jsp&#34;</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div><p><strong>在认证过程中使用subject.login进行认证</strong></p>
<h5 id="3自定义realm-1">3.自定义Realm</h5>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kn">package</span> <span class="nn">com.lut.shiro.realms</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.shiro.authc.AuthenticationException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.shiro.authc.AuthenticationInfo</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.shiro.authc.AuthenticationToken</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.shiro.authc.SimpleAuthenticationInfo</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.shiro.authz.AuthorizationInfo</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.shiro.authz.SimpleAuthorizationInfo</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.shiro.realm.AuthorizingRealm</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.shiro.subject.PrincipalCollection</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.util.CollectionUtils</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.util.ObjectUtils</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>


<span class="c1">//自定义realm
</span><span class="c1"></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">CustomerRealm</span> <span class="kd">extends</span> <span class="n">AuthorizingRealm</span> <span class="o">{</span>

    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="n">AuthorizationInfo</span> <span class="nf">doGetAuthorizationInfo</span><span class="o">(</span><span class="n">PrincipalCollection</span> <span class="n">principals</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="n">AuthenticationInfo</span> <span class="nf">doGetAuthenticationInfo</span><span class="o">(</span><span class="n">AuthenticationToken</span> <span class="n">token</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">AuthenticationException</span> <span class="o">{</span>

        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;=============&#34;</span><span class="o">);</span>

        <span class="c1">//从传过来的token获取到的用户名
</span><span class="c1"></span>        <span class="n">String</span> <span class="n">principal</span> <span class="o">=</span> <span class="o">(</span><span class="n">String</span><span class="o">)</span> <span class="n">token</span><span class="o">.</span><span class="na">getPrincipal</span><span class="o">();</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;用户名&#34;</span><span class="o">+</span><span class="n">principal</span><span class="o">);</span>

        <span class="c1">//假设是从数据库获得的 用户名，密码
</span><span class="c1"></span>        <span class="n">String</span> <span class="n">password_db</span><span class="o">=</span><span class="s">&#34;123&#34;</span><span class="o">;</span>
        <span class="n">String</span> <span class="n">username_db</span><span class="o">=</span><span class="s">&#34;zhangsan&#34;</span><span class="o">;</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">username_db</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">principal</span><span class="o">)){</span>
<span class="c1">//            SimpleAuthenticationInfo simpleAuthenticationInfo =
</span><span class="c1"></span>            <span class="k">return</span> <span class="k">new</span> <span class="n">SimpleAuthenticationInfo</span><span class="o">(</span><span class="n">principal</span><span class="o">,</span><span class="s">&#34;123&#34;</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">getName</span><span class="o">());</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div><h5 id="4shiroconfig">4.ShiroConfig</h5>
<p>主要的Shiro配置类中声明：哪些是需要验证的资源，哪些是公开的资源</p>
<p>注意：先配置公共资源，后配置需要认证/授权的资源</p>
<p>此时认证功能没有md5和随机盐的认证</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kn">package</span> <span class="nn">com.lut.config</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.lut.shiro.realms.CustomerRealm</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.shiro.authc.credential.HashedCredentialsMatcher</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.shiro.realm.Realm</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.shiro.spring.web.ShiroFilterFactoryBean</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.shiro.web.mgt.DefaultWebSecurityManager</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.Bean</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.Configuration</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.HashMap</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Map</span><span class="o">;</span>

<span class="cm">/**
</span><span class="cm"> * 用来整合shiro框架相关的配置类
</span><span class="cm"> */</span>
<span class="nd">@Configuration</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ShiroConfig</span> <span class="o">{</span>

    <span class="c1">//1.创建shiroFilter  //负责拦截所有请求
</span><span class="c1"></span>    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="n">ShiroFilterFactoryBean</span> <span class="nf">getShiroFilterFactoryBean</span><span class="o">(</span><span class="n">DefaultWebSecurityManager</span> <span class="n">defaultWebSecurityManager</span><span class="o">){</span>

        <span class="n">ShiroFilterFactoryBean</span> <span class="n">shiroFilterFactoryBean</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ShiroFilterFactoryBean</span><span class="o">();</span>
        <span class="c1">//给filter设置安全管理器
</span><span class="c1"></span>        <span class="n">shiroFilterFactoryBean</span><span class="o">.</span><span class="na">setSecurityManager</span><span class="o">(</span><span class="n">defaultWebSecurityManager</span><span class="o">);</span>

        <span class="c1">//配置系统受限资源
</span><span class="c1"></span>        <span class="c1">//配置系统公共资源
</span><span class="c1"></span>        <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">map</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span><span class="n">String</span><span class="o">&gt;();</span>
        <span class="n">map</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&#34;/user/login&#34;</span><span class="o">,</span><span class="s">&#34;anon&#34;</span><span class="o">);</span><span class="c1">//anon 设置为公共资源  放行资源放在下面
</span><span class="c1"></span>        <span class="n">map</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&#34;/user/register&#34;</span><span class="o">,</span><span class="s">&#34;anon&#34;</span><span class="o">);</span><span class="c1">//anon 设置为公共资源  放行资源放在下面
</span><span class="c1"></span>        <span class="n">map</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&#34;/register.jsp&#34;</span><span class="o">,</span><span class="s">&#34;anon&#34;</span><span class="o">);</span><span class="c1">//anon 设置为公共资源  放行资源放在下面
</span><span class="c1"></span>        <span class="n">map</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&#34;/user/getImage&#34;</span><span class="o">,</span><span class="s">&#34;anon&#34;</span><span class="o">);</span>

        <span class="n">map</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&#34;/**&#34;</span><span class="o">,</span><span class="s">&#34;authc&#34;</span><span class="o">);</span><span class="c1">//authc 请求这个资源需要认证和授权
</span><span class="c1"></span>
        <span class="c1">//默认认证界面路径---当认证不通过时跳转
</span><span class="c1"></span>        <span class="n">shiroFilterFactoryBean</span><span class="o">.</span><span class="na">setLoginUrl</span><span class="o">(</span><span class="s">&#34;/login.jsp&#34;</span><span class="o">);</span>
        <span class="n">shiroFilterFactoryBean</span><span class="o">.</span><span class="na">setFilterChainDefinitionMap</span><span class="o">(</span><span class="n">map</span><span class="o">);</span>

        <span class="k">return</span> <span class="n">shiroFilterFactoryBean</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="c1">//2.创建安全管理器
</span><span class="c1"></span>    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="n">DefaultWebSecurityManager</span> <span class="nf">getDefaultWebSecurityManager</span><span class="o">(</span><span class="n">Realm</span> <span class="n">realm</span><span class="o">){</span>
        <span class="n">DefaultWebSecurityManager</span> <span class="n">defaultWebSecurityManager</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DefaultWebSecurityManager</span><span class="o">();</span>
        <span class="c1">//给安全管理器设置
</span><span class="c1"></span>        <span class="n">defaultWebSecurityManager</span><span class="o">.</span><span class="na">setRealm</span><span class="o">(</span><span class="n">realm</span><span class="o">);</span>

        <span class="k">return</span> <span class="n">defaultWebSecurityManager</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="c1">//3.创建自定义realm
</span><span class="c1"></span>    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="n">Realm</span> <span class="nf">getRealm</span><span class="o">(){</span>
        <span class="n">CustomerRealm</span> <span class="n">customerRealm</span> <span class="o">=</span> <span class="k">new</span> <span class="n">CustomerRealm</span><span class="o">();</span>
        <span class="k">return</span> <span class="n">customerRealm</span><span class="o">;</span>
    <span class="o">}</span>

<span class="o">}</span>
</code></pre></div><h4 id="652-退出认证">6.5.2 退出认证</h4>
<h5 id="1indexjsp">1.index.jsp</h5>
<p>添加登出链接</p>
<pre><code class="language-jsp" data-lang="jsp">&lt;%@page contentType=&quot;text/html;utf-8&quot; pageEncoding=&quot;utf-8&quot; isELIgnored=&quot;false&quot; %&gt;
&lt;!doctype html&gt;
&lt;html lang=&quot;en&quot;&gt;
&lt;head&gt;
    &lt;meta charset=&quot;UTF-8&quot;&gt;
    &lt;meta name=&quot;viewport&quot;
          content=&quot;width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0&quot;&gt;
    &lt;meta http-equiv=&quot;X-UA-Compatible&quot; content=&quot;ie=edge&quot;&gt;
    &lt;title&gt;Document&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;%--受限资源--%&gt;
&lt;h1&gt;系统主页&lt;/h1&gt;
&lt;a href=&quot;${pageContext.request.contextPath}/user/logout&quot;&gt;退出登录&lt;/a&gt;
&lt;ul&gt;
    &lt;li&gt;&lt;a href=&quot;#&quot;&gt;用户管理&lt;/a&gt;&lt;/li&gt;
    &lt;li&gt;&lt;a href=&quot;#&quot;&gt;商品管理&lt;/a&gt;&lt;/li&gt;
    &lt;li&gt;&lt;a href=&quot;#&quot;&gt;订单管理&lt;/a&gt;&lt;/li&gt;
    &lt;li&gt;&lt;a href=&quot;#&quot;&gt;物流管理&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/body&gt;
&lt;/html&gt;
</code></pre><h5 id="2usercontroller-1">2.UserController</h5>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kn">package</span> <span class="nn">com.lut.controller</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.apache.shiro.SecurityUtils</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.shiro.authc.IncorrectCredentialsException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.shiro.authc.UnknownAccountException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.shiro.authc.UsernamePasswordToken</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.shiro.subject.Subject</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.beans.factory.annotation.Autowired</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.stereotype.Controller</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.RequestMapping</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">javax.servlet.ServletOutputStream</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.servlet.http.HttpServletResponse</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.servlet.http.HttpSession</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>

<span class="nd">@Controller</span>
<span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">&#34;user&#34;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">UserController</span> <span class="o">{</span>


    <span class="cm">/**
</span><span class="cm">     * 退出登录
</span><span class="cm">     */</span>
    <span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">&#34;logout&#34;</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">logout</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">Subject</span> <span class="n">subject</span> <span class="o">=</span> <span class="n">SecurityUtils</span><span class="o">.</span><span class="na">getSubject</span><span class="o">();</span>
        <span class="n">subject</span><span class="o">.</span><span class="na">logout</span><span class="o">();</span><span class="c1">//退出用户
</span><span class="c1"></span>        <span class="k">return</span> <span class="s">&#34;redirect:/login.jsp&#34;</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="cm">/**
</span><span class="cm">     * 用来处理身份认证
</span><span class="cm">     * @param username
</span><span class="cm">     * @param password
</span><span class="cm">     * @return
</span><span class="cm">     */</span>
    <span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">&#34;login&#34;</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">login</span><span class="o">(</span><span class="n">String</span> <span class="n">username</span><span class="o">,</span> <span class="n">String</span> <span class="n">password</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="c1">//获取主体对象
</span><span class="c1"></span>            <span class="n">Subject</span> <span class="n">subject</span> <span class="o">=</span> <span class="n">SecurityUtils</span><span class="o">.</span><span class="na">getSubject</span><span class="o">();</span>
            <span class="n">subject</span><span class="o">.</span><span class="na">login</span><span class="o">(</span><span class="k">new</span> <span class="n">UsernamePasswordToken</span><span class="o">(</span><span class="n">username</span><span class="o">,</span> <span class="n">password</span><span class="o">));</span>
            <span class="k">return</span> <span class="s">&#34;redirect:/index.jsp&#34;</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">UnknownAccountException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;用户名错误!&#34;</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IncorrectCredentialsException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;密码错误!&#34;</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">getMessage</span><span class="o">());</span>
        <span class="o">}</span>

        <span class="k">return</span> <span class="s">&#34;redirect:/login.jsp&#34;</span><span class="o">;</span>
    <span class="o">}</span>


<span class="o">}</span>
</code></pre></div><h5 id="3测试">3.测试</h5>
<p>登录正常，登出正常，未登录和登出后不能访问index.jsp</p>
<p><img src="/shiro.assets/image-20210607155322004.png" alt="image-20210607155322004"></p>
<h3 id="67-md5salt的认证实现">6.7 MD5、Salt的认证实现</h3>
<h4 id="671-用户注册随机盐处理">6.7.1 用户注册+随机盐处理</h4>
<h5 id="1导入依赖">1.导入依赖</h5>
<div class="highlight"><pre class="chroma"><code class="language-xml" data-lang="xml"><span class="c">&lt;!--mybatis相关依赖--&gt;</span>
<span class="nt">&lt;dependency&gt;</span>
  <span class="nt">&lt;groupId&gt;</span>org.mybatis.spring.boot<span class="nt">&lt;/groupId&gt;</span>
  <span class="nt">&lt;artifactId&gt;</span>mybatis-spring-boot-starter<span class="nt">&lt;/artifactId&gt;</span>
  <span class="nt">&lt;version&gt;</span>2.1.2<span class="nt">&lt;/version&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>

<span class="c">&lt;!--mysql--&gt;</span>
<span class="nt">&lt;dependency&gt;</span>
  <span class="nt">&lt;groupId&gt;</span>mysql<span class="nt">&lt;/groupId&gt;</span>
  <span class="nt">&lt;artifactId&gt;</span>mysql-connector-java<span class="nt">&lt;/artifactId&gt;</span>
  <span class="nt">&lt;version&gt;</span>5.1.38<span class="nt">&lt;/version&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>


<span class="c">&lt;!--druid--&gt;</span>
<span class="nt">&lt;dependency&gt;</span>
  <span class="nt">&lt;groupId&gt;</span>com.alibaba<span class="nt">&lt;/groupId&gt;</span>
  <span class="nt">&lt;artifactId&gt;</span>druid<span class="nt">&lt;/artifactId&gt;</span>
  <span class="nt">&lt;version&gt;</span>1.1.19<span class="nt">&lt;/version&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</code></pre></div><h5 id="2applicationproperties">2.application.properties</h5>
<pre><code class="language-properties" data-lang="properties">spring.datasource.type=com.alibaba.druid.pool.DruidDataSource
spring.datasource.driver-class-name=com.mysql.jdbc.Driver
spring.datasource.url=jdbc:mysql://localhost:3306/shiro?characterEncoding=UTF-8
spring.datasource.username=root
spring.datasource.password=88888888

mybatis.type-aliases-package=com.lut.entity
mybatis.mapper-locations=classpath:mapper/*.xml
</code></pre><h5 id="3创建数据库">3.创建数据库</h5>
<div class="highlight"><pre class="chroma"><code class="language-mysql" data-lang="mysql"><span class="kt">SET</span> <span class="n">NAMES</span> <span class="n">utf8mb4</span><span class="p">;</span>
<span class="kt">SET</span> <span class="n">FOREIGN_KEY_CHECKS</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="c1">-- ----------------------------
</span><span class="c1">-- Table structure for t_user
</span><span class="c1">-- ----------------------------
</span><span class="c1"></span><span class="k">DROP</span> <span class="k">TABLE</span> <span class="k">IF</span> <span class="k">EXISTS</span> <span class="o">`</span><span class="n">t_user</span><span class="o">`</span><span class="p">;</span>
<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="o">`</span><span class="n">t_user</span><span class="o">`</span> <span class="p">(</span>
  <span class="o">`</span><span class="n">id</span><span class="o">`</span> <span class="kt">int</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="k">NOT</span> <span class="no">NULL</span> <span class="kp">AUTO_INCREMENT</span><span class="p">,</span>
  <span class="o">`</span><span class="n">username</span><span class="o">`</span> <span class="kt">varchar</span><span class="p">(</span><span class="mi">40</span><span class="p">)</span> <span class="k">DEFAULT</span> <span class="no">NULL</span><span class="p">,</span>
  <span class="o">`</span><span class="n">password</span><span class="o">`</span> <span class="kt">varchar</span><span class="p">(</span><span class="mi">40</span><span class="p">)</span> <span class="k">DEFAULT</span> <span class="no">NULL</span><span class="p">,</span>
  <span class="o">`</span><span class="n">salt</span><span class="o">`</span> <span class="kt">varchar</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span> <span class="k">DEFAULT</span> <span class="no">NULL</span><span class="p">,</span>
  <span class="k">PRIMARY</span> <span class="k">KEY</span> <span class="p">(</span><span class="o">`</span><span class="n">id</span><span class="o">`</span><span class="p">)</span>
<span class="p">)</span> <span class="kp">ENGINE</span><span class="o">=</span><span class="n">InnoDB</span> <span class="kp">AUTO_INCREMENT</span><span class="o">=</span><span class="mi">2</span> <span class="k">DEFAULT</span> <span class="kp">CHARSET</span><span class="o">=</span><span class="n">utf8</span><span class="p">;</span>

<span class="kt">SET</span> <span class="n">FOREIGN_KEY_CHECKS</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</code></pre></div><p><img src="/shiro.assets/image-20210607155451068.png" alt="image-20210607155451068"></p>
<h5 id="4创建entity">4.创建entity</h5>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kn">package</span> <span class="nn">com.lut.entity</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">lombok.AllArgsConstructor</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">lombok.Data</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">lombok.NoArgsConstructor</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">lombok.experimental.Accessors</span><span class="o">;</span>

<span class="nd">@Data</span>
<span class="nd">@Accessors</span><span class="o">(</span><span class="n">chain</span> <span class="o">=</span> <span class="kc">true</span><span class="o">)</span>
<span class="nd">@AllArgsConstructor</span>
<span class="nd">@NoArgsConstructor</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">User</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="n">String</span>  <span class="n">id</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">username</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">password</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">salt</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div><h5 id="5创建dao接口">5.创建DAO接口</h5>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kn">package</span> <span class="nn">com.lut.dao</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.lut.entity.User</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.ibatis.annotations.Mapper</span><span class="o">;</span>

<span class="nd">@Mapper</span>
<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">UserDao</span> <span class="o">{</span>

    <span class="kt">void</span> <span class="nf">save</span><span class="o">(</span><span class="n">User</span> <span class="n">user</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div><h5 id="6开发mapper配置文件">6.开发mapper配置文件</h5>
<p>注意：mapper文件的位置要在 application.properties配置的目录下面</p>
<p><strong>注意：mapper文件的命名 与 Dao接口保持一致</strong></p>
<div class="highlight"><pre class="chroma"><code class="language-xml" data-lang="xml"><span class="cp">&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34; ?&gt;</span>
<span class="cp">&lt;!DOCTYPE mapper
</span><span class="cp">        PUBLIC &#34;-//mybatis.org//DTD Config 3.0//EN&#34;
</span><span class="cp">        &#34;http://mybatis.org/dtd/mybatis-3-mapper.dtd&#34;&gt;</span>

<span class="nt">&lt;mapper</span> <span class="na">namespace=</span><span class="s">&#34;com.lut.dao.UserDao&#34;</span><span class="nt">&gt;</span>

    <span class="nt">&lt;insert</span> <span class="na">id=</span><span class="s">&#34;save&#34;</span> <span class="na">parameterType=</span><span class="s">&#34;User&#34;</span> <span class="na">useGeneratedKeys=</span><span class="s">&#34;true&#34;</span> <span class="na">keyProperty=</span><span class="s">&#34;id&#34;</span><span class="nt">&gt;</span>
        insert into t_user values(#{id},#{username},#{password},#{salt})
    <span class="nt">&lt;/insert&gt;</span>

<span class="nt">&lt;/mapper&gt;</span>
</code></pre></div><p><strong>在图中，标红的地方要保持命名一致，不然会有莫名其妙的BUG</strong></p>
<p><img src="/shiro.assets/image-20210607155549680.png" alt="image-20210607155549680"></p>
<h5 id="7开发service接口">7.开发service接口</h5>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kn">package</span> <span class="nn">com.lut.service</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.lut.entity.User</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">UserService</span> <span class="o">{</span>
    <span class="c1">//注册用户方法
</span><span class="c1"></span>    <span class="kt">void</span> <span class="nf">register</span><span class="o">(</span><span class="n">User</span> <span class="n">user</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div><h5 id="8创建salt工具类">8.创建salt工具类</h5>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kn">package</span> <span class="nn">com.lut.utils</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.Random</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SaltUtils</span> <span class="o">{</span>
    <span class="cm">/**
</span><span class="cm">     * 生成salt的静态方法
</span><span class="cm">     * @param n
</span><span class="cm">     * @return
</span><span class="cm">     */</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="n">String</span> <span class="nf">getSalt</span><span class="o">(</span><span class="kt">int</span> <span class="n">n</span><span class="o">){</span>
        <span class="kt">char</span><span class="o">[]</span> <span class="n">chars</span> <span class="o">=</span> <span class="s">&#34;ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz01234567890!@#$%^&amp;*()&#34;</span><span class="o">.</span><span class="na">toCharArray</span><span class="o">();</span>
        <span class="n">StringBuilder</span> <span class="n">sb</span> <span class="o">=</span> <span class="k">new</span> <span class="n">StringBuilder</span><span class="o">();</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="kt">char</span> <span class="n">aChar</span> <span class="o">=</span> <span class="n">chars</span><span class="o">[</span><span class="k">new</span> <span class="nf">Random</span><span class="o">().</span><span class="na">nextInt</span><span class="o">(</span><span class="n">chars</span><span class="o">.</span><span class="na">length</span><span class="o">)];</span>
            <span class="n">sb</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">aChar</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">sb</span><span class="o">.</span><span class="na">toString</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div><h5 id="9开发service实现类">9.开发service实现类</h5>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kn">package</span> <span class="nn">com.lut.service</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.lut.dao.UserDao</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.lut.entity.User</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.lut.utils.SaltUtils</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.shiro.crypto.hash.Md5Hash</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.beans.factory.annotation.Autowired</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.transaction.annotation.Transactional</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.stereotype.Service</span><span class="o">;</span>

<span class="nd">@Service</span>
<span class="nd">@Transactional</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">UserServiceImpl</span> <span class="kd">implements</span> <span class="n">UserService</span> <span class="o">{</span>

    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="n">UserDao</span> <span class="n">userDAO</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">register</span><span class="o">(</span><span class="n">User</span> <span class="n">user</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">//处理业务调用dao
</span><span class="c1"></span>        <span class="c1">//1.生成随机盐
</span><span class="c1"></span>        <span class="n">String</span> <span class="n">salt</span> <span class="o">=</span> <span class="n">SaltUtils</span><span class="o">.</span><span class="na">getSalt</span><span class="o">(</span><span class="n">8</span><span class="o">);</span>
        <span class="c1">//2.将随机盐保存到数据
</span><span class="c1"></span>        <span class="n">user</span><span class="o">.</span><span class="na">setSalt</span><span class="o">(</span><span class="n">salt</span><span class="o">);</span>
        <span class="c1">//3.明文密码进行md5 + salt + hash散列
</span><span class="c1"></span>        <span class="n">Md5Hash</span> <span class="n">md5Hash</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Md5Hash</span><span class="o">(</span><span class="n">user</span><span class="o">.</span><span class="na">getPassword</span><span class="o">(),</span><span class="n">salt</span><span class="o">,</span><span class="n">1024</span><span class="o">);</span>
        <span class="n">user</span><span class="o">.</span><span class="na">setPassword</span><span class="o">(</span><span class="n">md5Hash</span><span class="o">.</span><span class="na">toHex</span><span class="o">());</span>

        <span class="n">userDAO</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="n">user</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div><h5 id="10开发controller">10.开发Controller</h5>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="nd">@Controller</span>
<span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">&#34;user&#34;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">UserController</span> <span class="o">{</span>

    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="n">UserService</span> <span class="n">userService</span><span class="o">;</span>

    <span class="cm">/**
</span><span class="cm">     * 用户注册
</span><span class="cm">     */</span>
    <span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">&#34;register&#34;</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">register</span><span class="o">(</span><span class="n">User</span> <span class="n">user</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">userService</span><span class="o">.</span><span class="na">register</span><span class="o">(</span><span class="n">user</span><span class="o">);</span>
            <span class="k">return</span> <span class="s">&#34;redirect:/login.jsp&#34;</span><span class="o">;</span>
        <span class="o">}</span><span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">){</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
            <span class="k">return</span> <span class="s">&#34;redirect:/register.jsp&#34;</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div><h5 id="11设置公共资源">11.设置公共资源</h5>
<p>在ShiroConfig中添加</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="n">map</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&#34;/user/register&#34;</span><span class="o">,</span><span class="s">&#34;anon&#34;</span><span class="o">);</span><span class="c1">//anon 设置为公共资源 
</span><span class="c1"></span><span class="n">map</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&#34;/register.jsp&#34;</span><span class="o">,</span><span class="s">&#34;anon&#34;</span><span class="o">);</span><span class="c1">//anon 设置为公共资源  
</span></code></pre></div><h5 id="12测试">12.测试</h5>
<p>添加成功</p>
<p><img src="/shiro.assets/image-20210607155721427.png" alt="image-20210607155721427"></p>
<h4 id="672-开发数据库认证">6.7.2 开发数据库认证</h4>
<h5 id="1开发dao">1.开发DAO</h5>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="nd">@Mapper</span>
<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">UserDAO</span> <span class="o">{</span>
    
    <span class="kt">void</span> <span class="nf">save</span><span class="o">(</span><span class="n">User</span> <span class="n">user</span><span class="o">);</span>
	<span class="c1">//根据身份信息认证的方法
</span><span class="c1"></span>    <span class="n">User</span> <span class="nf">findByUserName</span><span class="o">(</span><span class="n">String</span> <span class="n">username</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div><h5 id="2开发mapper配置文件">2.开发mapper配置文件</h5>
<div class="highlight"><pre class="chroma"><code class="language-xml" data-lang="xml"><span class="nt">&lt;select</span> <span class="na">id=</span><span class="s">&#34;findByUserName&#34;</span> <span class="na">parameterType=</span><span class="s">&#34;String&#34;</span> <span class="na">resultType=</span><span class="s">&#34;User&#34;</span><span class="nt">&gt;</span>
  select id,username,password,salt from t_user
  where username = #{username}
<span class="nt">&lt;/select&gt;</span>
</code></pre></div><h5 id="3开发service接口">3.开发Service接口</h5>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">UserService</span> <span class="o">{</span>
    <span class="c1">//注册用户方法
</span><span class="c1"></span>    <span class="kt">void</span> <span class="nf">register</span><span class="o">(</span><span class="n">User</span> <span class="n">user</span><span class="o">);</span>
    <span class="c1">//根据用户名查询业务的方法
</span><span class="c1"></span>    <span class="n">User</span> <span class="nf">findByUserName</span><span class="o">(</span><span class="n">String</span> <span class="n">username</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div><h5 id="4开发service实现类">4.开发Service实现类</h5>
<p><strong>注意：一定别忘记添加注解：@Service(“userService”)</strong></p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="nd">@Service</span><span class="o">(</span><span class="s">&#34;userService&#34;</span><span class="o">)</span>
<span class="nd">@Transactional</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">UserServiceImpl</span> <span class="kd">implements</span> <span class="n">UserService</span> <span class="o">{</span>
    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="n">UserDAO</span> <span class="n">userDAO</span><span class="o">;</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">User</span> <span class="nf">findByUserName</span><span class="o">(</span><span class="n">String</span> <span class="n">username</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">userDAO</span><span class="o">.</span><span class="na">findByUserName</span><span class="o">(</span><span class="n">username</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div><h5 id="5开发工厂工具类">5.开发工厂工具类</h5>
<p><strong>在工厂中获取bean对象的工具类</strong></p>
<p>ApplicationContextUtils</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kn">package</span> <span class="nn">com.lut.utils</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.beans.BeansException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.ApplicationContext</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.ApplicationContextAware</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.stereotype.Component</span><span class="o">;</span>

<span class="nd">@Component</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ApplicationContextUtils</span> <span class="kd">implements</span> <span class="n">ApplicationContextAware</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="n">ApplicationContext</span> <span class="n">context</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setApplicationContext</span><span class="o">(</span><span class="n">ApplicationContext</span> <span class="n">applicationContext</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">BeansException</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">context</span> <span class="o">=</span> <span class="n">applicationContext</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="c1">//根据bean名字获取工厂中指定bean 对象
</span><span class="c1"></span>    <span class="kd">public</span> <span class="kd">static</span> <span class="n">Object</span> <span class="nf">getBean</span><span class="o">(</span><span class="n">String</span> <span class="n">beanName</span><span class="o">){</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;beanName&#34;</span><span class="o">+</span><span class="n">beanName</span><span class="o">);</span>
        <span class="n">Object</span> <span class="n">object</span><span class="o">=</span><span class="n">context</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="n">beanName</span><span class="o">);</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;object&#34;</span><span class="o">+</span><span class="n">object</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">context</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="n">beanName</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div><h5 id="6修改自定义realm">6.修改自定义realm</h5>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="c1">//自定义realm
</span><span class="c1"></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">CustomerRealm</span> <span class="kd">extends</span> <span class="n">AuthorizingRealm</span> <span class="o">{</span>

    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="n">AuthorizationInfo</span> <span class="nf">doGetAuthorizationInfo</span><span class="o">(</span><span class="n">PrincipalCollection</span> <span class="n">principals</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="n">AuthenticationInfo</span> <span class="nf">doGetAuthenticationInfo</span><span class="o">(</span><span class="n">AuthenticationToken</span> <span class="n">token</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">AuthenticationException</span> <span class="o">{</span>

        <span class="c1">//根据身份信息//从传过来的token获取到的用户名
</span><span class="c1"></span>        <span class="n">String</span> <span class="n">principal</span> <span class="o">=</span> <span class="o">(</span><span class="n">String</span><span class="o">)</span> <span class="n">token</span><span class="o">.</span><span class="na">getPrincipal</span><span class="o">();</span>

        <span class="c1">//在工厂中获取service对象
</span><span class="c1"></span>        <span class="n">UserService</span> <span class="n">userService</span> <span class="o">=</span> <span class="o">(</span><span class="n">UserService</span><span class="o">)</span> <span class="n">ApplicationContextUtils</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="s">&#34;userService&#34;</span><span class="o">);</span>

        <span class="c1">//根据身份信息查询
</span><span class="c1"></span>        <span class="n">User</span> <span class="n">user</span> <span class="o">=</span> <span class="n">userService</span><span class="o">.</span><span class="na">findByUserName</span><span class="o">(</span><span class="n">principal</span><span class="o">);</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;User:&#34;</span><span class="o">+</span><span class="n">user</span><span class="o">);</span>

        <span class="c1">//用户不为空
</span><span class="c1"></span>        <span class="k">if</span><span class="o">(!</span><span class="n">ObjectUtils</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">(</span><span class="n">user</span><span class="o">)){</span>
            <span class="c1">//返回数据库信息
</span><span class="c1"></span>            <span class="n">SimpleAuthenticationInfo</span> <span class="n">simpleAuthenticationInfo</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SimpleAuthenticationInfo</span><span class="o">(</span><span class="n">user</span><span class="o">.</span><span class="na">getUsername</span><span class="o">(),</span> <span class="n">user</span><span class="o">.</span><span class="na">getPassword</span><span class="o">(),</span>
                    <span class="n">ByteSource</span><span class="o">.</span><span class="na">Util</span><span class="o">.</span><span class="na">bytes</span><span class="o">(</span><span class="n">user</span><span class="o">.</span><span class="na">getSalt</span><span class="o">()),</span> <span class="k">this</span><span class="o">.</span><span class="na">getName</span><span class="o">());</span>
            <span class="k">return</span> <span class="n">simpleAuthenticationInfo</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>

<span class="o">}</span>
</code></pre></div><h5 id="7修改shiroconfig中realm">7.修改ShiroConfig中realm</h5>
<p>使用凭证匹配器以及hash散列</p>
<p>以及在 getShiroFilterFactoryBean 中添加公共资源</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kn">package</span> <span class="nn">com.lut.config</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.lut.shiro.realms.CustomerRealm</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.shiro.authc.credential.HashedCredentialsMatcher</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.shiro.realm.Realm</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.shiro.spring.web.ShiroFilterFactoryBean</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.shiro.web.mgt.DefaultWebSecurityManager</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.Bean</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.Configuration</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.HashMap</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Map</span><span class="o">;</span>

<span class="cm">/**
</span><span class="cm"> * 用来整合shiro框架相关的配置类
</span><span class="cm"> */</span>
<span class="nd">@Configuration</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ShiroConfig</span> <span class="o">{</span>

    <span class="c1">//1.创建shiroFilter  //负责拦截所有请求
</span><span class="c1"></span>    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="n">ShiroFilterFactoryBean</span> <span class="nf">getShiroFilterFactoryBean</span><span class="o">(</span><span class="n">DefaultWebSecurityManager</span> <span class="n">defaultWebSecurityManager</span><span class="o">){</span>

        <span class="n">ShiroFilterFactoryBean</span> <span class="n">shiroFilterFactoryBean</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ShiroFilterFactoryBean</span><span class="o">();</span>
        <span class="c1">//给filter设置安全管理器
</span><span class="c1"></span>        <span class="n">shiroFilterFactoryBean</span><span class="o">.</span><span class="na">setSecurityManager</span><span class="o">(</span><span class="n">defaultWebSecurityManager</span><span class="o">);</span>

        <span class="c1">//配置系统受限资源
</span><span class="c1"></span>        <span class="c1">//配置系统公共资源
</span><span class="c1"></span>        <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">map</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span><span class="n">String</span><span class="o">&gt;();</span>
        <span class="n">map</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&#34;/user/login&#34;</span><span class="o">,</span><span class="s">&#34;anon&#34;</span><span class="o">);</span><span class="c1">//anon 设置为公共资源  放行资源放在下面
</span><span class="c1"></span>        <span class="n">map</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&#34;/user/register&#34;</span><span class="o">,</span><span class="s">&#34;anon&#34;</span><span class="o">);</span><span class="c1">//anon 设置为公共资源  放行资源放在下面
</span><span class="c1"></span>        <span class="n">map</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&#34;/register.jsp&#34;</span><span class="o">,</span><span class="s">&#34;anon&#34;</span><span class="o">);</span><span class="c1">//anon 设置为公共资源  放行资源放在下面
</span><span class="c1"></span>        <span class="n">map</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&#34;/user/getImage&#34;</span><span class="o">,</span><span class="s">&#34;anon&#34;</span><span class="o">);</span>

        <span class="n">map</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&#34;/**&#34;</span><span class="o">,</span><span class="s">&#34;authc&#34;</span><span class="o">);</span><span class="c1">//authc 请求这个资源需要认证和授权
</span><span class="c1"></span>
        <span class="c1">//默认认证界面路径---当认证不通过时跳转
</span><span class="c1"></span>        <span class="n">shiroFilterFactoryBean</span><span class="o">.</span><span class="na">setLoginUrl</span><span class="o">(</span><span class="s">&#34;/login.jsp&#34;</span><span class="o">);</span>
        <span class="n">shiroFilterFactoryBean</span><span class="o">.</span><span class="na">setFilterChainDefinitionMap</span><span class="o">(</span><span class="n">map</span><span class="o">);</span>

        <span class="k">return</span> <span class="n">shiroFilterFactoryBean</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="c1">//2.创建安全管理器
</span><span class="c1"></span>    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="n">DefaultWebSecurityManager</span> <span class="nf">getDefaultWebSecurityManager</span><span class="o">(</span><span class="n">Realm</span> <span class="n">realm</span><span class="o">){</span>
        <span class="n">DefaultWebSecurityManager</span> <span class="n">defaultWebSecurityManager</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DefaultWebSecurityManager</span><span class="o">();</span>
        <span class="c1">//给安全管理器设置
</span><span class="c1"></span>        <span class="n">defaultWebSecurityManager</span><span class="o">.</span><span class="na">setRealm</span><span class="o">(</span><span class="n">realm</span><span class="o">);</span>

        <span class="k">return</span> <span class="n">defaultWebSecurityManager</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="n">Realm</span> <span class="nf">getRealm</span><span class="o">(){</span>
        <span class="n">CustomerRealm</span> <span class="n">customerRealm</span> <span class="o">=</span> <span class="k">new</span> <span class="n">CustomerRealm</span><span class="o">();</span>

        <span class="c1">//设置hashed凭证匹配器
</span><span class="c1"></span>        <span class="n">HashedCredentialsMatcher</span> <span class="n">credentialsMatcher</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashedCredentialsMatcher</span><span class="o">();</span>

        <span class="c1">//设置md5加密
</span><span class="c1"></span>        <span class="n">credentialsMatcher</span><span class="o">.</span><span class="na">setHashAlgorithmName</span><span class="o">(</span><span class="s">&#34;md5&#34;</span><span class="o">);</span>

        <span class="c1">//设置散列次数
</span><span class="c1"></span>        <span class="n">credentialsMatcher</span><span class="o">.</span><span class="na">setHashIterations</span><span class="o">(</span><span class="n">1024</span><span class="o">);</span>
        <span class="n">customerRealm</span><span class="o">.</span><span class="na">setCredentialsMatcher</span><span class="o">(</span><span class="n">credentialsMatcher</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">customerRealm</span><span class="o">;</span>
    <span class="o">}</span>

<span class="o">}</span>
</code></pre></div><h5 id="8启动测试">8.启动测试</h5>
<p><img src="/shiro.assets/image-20210607155907029.png" alt="image-20210607155907029"></p>
<h3 id="68-授权实现">6.8 授权实现</h3>
<h4 id="681-没有数据库">6.8.1 没有数据库</h4>
<h5 id="1页面资源授权">1.页面资源授权</h5>
<div class="highlight"><pre class="chroma"><code class="language-html" data-lang="html"><span class="err">&lt;</span>%@page contentType=&#34;text/html;utf-8&#34; pageEncoding=&#34;utf-8&#34; isELIgnored=&#34;false&#34; %&gt;
<span class="err">&lt;</span>%@taglib prefix=&#34;shiro&#34; uri=&#34;http://shiro.apache.org/tags&#34; %&gt;
<span class="cp">&lt;!doctype html&gt;</span>
<span class="p">&lt;</span><span class="nt">html</span> <span class="na">lang</span><span class="o">=</span><span class="s">&#34;en&#34;</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">head</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">meta</span> <span class="na">charset</span><span class="o">=</span><span class="s">&#34;UTF-8&#34;</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">meta</span> <span class="na">name</span><span class="o">=</span><span class="s">&#34;viewport&#34;</span>
          <span class="na">content</span><span class="o">=</span><span class="s">&#34;width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0&#34;</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">meta</span> <span class="na">http-equiv</span><span class="o">=</span><span class="s">&#34;X-UA-Compatible&#34;</span> <span class="na">content</span><span class="o">=</span><span class="s">&#34;ie=edge&#34;</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">title</span><span class="p">&gt;</span>Document<span class="p">&lt;/</span><span class="nt">title</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">head</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="err">&lt;</span>%--    受限资源--%&gt;
<span class="p">&lt;</span><span class="nt">h1</span><span class="p">&gt;</span>系统主页<span class="p">&lt;/</span><span class="nt">h1</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">a</span> <span class="na">href</span><span class="o">=</span><span class="s">&#34;${pageContext.request.contextPath}/user/logout&#34;</span><span class="p">&gt;</span>退出登录<span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">ul</span><span class="p">&gt;</span>


    <span class="p">&lt;</span><span class="nt">shiro:hasAnyRoles</span> <span class="na">name</span><span class="o">=</span><span class="s">&#34;user_manager,admin,addinfo_manager&#34;</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">li</span><span class="p">&gt;&lt;</span><span class="nt">a</span> <span class="na">href</span><span class="o">=</span><span class="s">&#34;&#34;</span><span class="p">&gt;</span>用户管理<span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">ul</span><span class="p">&gt;</span>
                <span class="p">&lt;</span><span class="nt">shiro:hasPermission</span> <span class="na">name</span><span class="o">=</span><span class="s">&#34;user:add:*&#34;</span><span class="p">&gt;</span>
                    <span class="p">&lt;</span><span class="nt">li</span><span class="p">&gt;&lt;</span><span class="nt">a</span> <span class="na">href</span><span class="o">=</span><span class="s">&#34;&#34;</span><span class="p">&gt;</span>添加<span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
                <span class="p">&lt;/</span><span class="nt">shiro:hasPermission</span><span class="p">&gt;</span>
                <span class="p">&lt;</span><span class="nt">shiro:hasPermission</span> <span class="na">name</span><span class="o">=</span><span class="s">&#34;user:delete:*&#34;</span><span class="p">&gt;</span>
                    <span class="p">&lt;</span><span class="nt">li</span><span class="p">&gt;&lt;</span><span class="nt">a</span> <span class="na">href</span><span class="o">=</span><span class="s">&#34;&#34;</span><span class="p">&gt;</span>删除<span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
                <span class="p">&lt;/</span><span class="nt">shiro:hasPermission</span><span class="p">&gt;</span>
                <span class="p">&lt;</span><span class="nt">shiro:hasPermission</span> <span class="na">name</span><span class="o">=</span><span class="s">&#34;user:update:*&#34;</span><span class="p">&gt;</span>
                    <span class="p">&lt;</span><span class="nt">li</span><span class="p">&gt;&lt;</span><span class="nt">a</span> <span class="na">href</span><span class="o">=</span><span class="s">&#34;&#34;</span><span class="p">&gt;</span>修改<span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
                <span class="p">&lt;/</span><span class="nt">shiro:hasPermission</span><span class="p">&gt;</span>
                <span class="p">&lt;</span><span class="nt">shiro:hasPermission</span> <span class="na">name</span><span class="o">=</span><span class="s">&#34;user:find:*&#34;</span><span class="p">&gt;</span>
                    <span class="p">&lt;</span><span class="nt">li</span><span class="p">&gt;&lt;</span><span class="nt">a</span> <span class="na">href</span><span class="o">=</span><span class="s">&#34;&#34;</span><span class="p">&gt;</span>查询<span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
                <span class="p">&lt;/</span><span class="nt">shiro:hasPermission</span><span class="p">&gt;</span>
            <span class="p">&lt;/</span><span class="nt">ul</span><span class="p">&gt;</span>
        <span class="p">&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">shiro:hasAnyRoles</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">shiro:hasAnyRoles</span> <span class="na">name</span><span class="o">=</span><span class="s">&#34;order_manager,admin,addinfo_manager&#34;</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">li</span><span class="p">&gt;&lt;</span><span class="nt">a</span> <span class="na">href</span><span class="o">=</span><span class="s">&#34;&#34;</span><span class="p">&gt;</span>订单管理<span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">ul</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">shiro:hasPermission</span> <span class="na">name</span><span class="o">=</span><span class="s">&#34;order:add:*&#34;</span><span class="p">&gt;</span>
                <span class="p">&lt;</span><span class="nt">li</span><span class="p">&gt;&lt;</span><span class="nt">a</span> <span class="na">href</span><span class="o">=</span><span class="s">&#34;&#34;</span><span class="p">&gt;</span>添加<span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
            <span class="p">&lt;/</span><span class="nt">shiro:hasPermission</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">shiro:hasPermission</span> <span class="na">name</span><span class="o">=</span><span class="s">&#34;order:delete:*&#34;</span><span class="p">&gt;</span>
                <span class="p">&lt;</span><span class="nt">li</span><span class="p">&gt;&lt;</span><span class="nt">a</span> <span class="na">href</span><span class="o">=</span><span class="s">&#34;&#34;</span><span class="p">&gt;</span>删除<span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
            <span class="p">&lt;/</span><span class="nt">shiro:hasPermission</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">shiro:hasPermission</span> <span class="na">name</span><span class="o">=</span><span class="s">&#34;order:update:*&#34;</span><span class="p">&gt;</span>
                <span class="p">&lt;</span><span class="nt">li</span><span class="p">&gt;&lt;</span><span class="nt">a</span> <span class="na">href</span><span class="o">=</span><span class="s">&#34;&#34;</span><span class="p">&gt;</span>修改<span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
            <span class="p">&lt;/</span><span class="nt">shiro:hasPermission</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">shiro:hasPermission</span> <span class="na">name</span><span class="o">=</span><span class="s">&#34;order:find:*&#34;</span><span class="p">&gt;</span>
                <span class="p">&lt;</span><span class="nt">li</span><span class="p">&gt;&lt;</span><span class="nt">a</span> <span class="na">href</span><span class="o">=</span><span class="s">&#34;&#34;</span><span class="p">&gt;</span>查询<span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
            <span class="p">&lt;/</span><span class="nt">shiro:hasPermission</span><span class="p">&gt;</span>
        <span class="p">&lt;/</span><span class="nt">ul</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">shiro:hasAnyRoles</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">shiro:hasRole</span> <span class="na">name</span><span class="o">=</span><span class="s">&#34;admin&#34;</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">li</span><span class="p">&gt;&lt;</span><span class="nt">a</span> <span class="na">href</span><span class="o">=</span><span class="s">&#34;&#34;</span><span class="p">&gt;</span>商品管理<span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">li</span><span class="p">&gt;&lt;</span><span class="nt">a</span> <span class="na">href</span><span class="o">=</span><span class="s">&#34;&#34;</span><span class="p">&gt;</span>物流管理<span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">shiro:hasRole</span><span class="p">&gt;</span>

    <span class="p">&lt;</span><span class="nt">shiro:hasRole</span> <span class="na">name</span><span class="o">=</span><span class="s">&#34;user&#34;</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">li</span><span class="p">&gt;&lt;</span><span class="nt">a</span> <span class="na">href</span><span class="o">=</span><span class="s">&#34;&#34;</span><span class="p">&gt;</span>仅普通用户可见<span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">li</span><span class="p">&gt;&lt;</span><span class="nt">a</span> <span class="na">href</span><span class="o">=</span><span class="s">&#34;&#34;</span><span class="p">&gt;</span>公共资源<span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">shiro:hasRole</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">ul</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</code></pre></div><h5 id="2代码方式授权">2.代码方式授权</h5>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">&#34;save&#34;</span><span class="o">)</span>
<span class="kd">public</span> <span class="n">String</span> <span class="nf">save</span><span class="o">(){</span>
  <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;进入方法&#34;</span><span class="o">);</span>
  
  <span class="c1">//基于角色
</span><span class="c1"></span>  <span class="c1">//获取主体对象
</span><span class="c1"></span>  <span class="n">Subject</span> <span class="n">subject</span> <span class="o">=</span> <span class="n">SecurityUtils</span><span class="o">.</span><span class="na">getSubject</span><span class="o">();</span>
  <span class="c1">//代码方式
</span><span class="c1"></span>  <span class="k">if</span> <span class="o">(</span><span class="n">subject</span><span class="o">.</span><span class="na">hasRole</span><span class="o">(</span><span class="s">&#34;admin&#34;</span><span class="o">))</span> <span class="o">{</span>
    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;保存订单!&#34;</span><span class="o">);</span>
  <span class="o">}</span><span class="k">else</span><span class="o">{</span>
    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;无权访问!&#34;</span><span class="o">);</span>
  <span class="o">}</span>
  <span class="c1">//基于权限字符串
</span><span class="c1"></span>  <span class="c1">//....
</span><span class="c1"></span>  <span class="k">return</span> <span class="s">&#34;redirect:/index.jsp&#34;</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div><h5 id="3方法调用授权">3.方法调用授权</h5>
<ul>
<li>@RequiresRoles 用来基于角色进行授权</li>
<li>@RequiresPermissions 用来基于权限进行授权</li>
</ul>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kn">import</span> <span class="nn">org.apache.shiro.authz.annotation.RequiresPermissions</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.shiro.authz.annotation.RequiresRoles</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.stereotype.Controller</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.RequestMapping</span><span class="o">;</span>

<span class="nd">@Controller</span>
<span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">&#34;order&#34;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">OrderController</span> <span class="o">{</span>

    <span class="nd">@RequiresRoles</span><span class="o">(</span><span class="n">value</span><span class="o">={</span><span class="s">&#34;admin&#34;</span><span class="o">,</span><span class="s">&#34;user&#34;</span><span class="o">})</span><span class="c1">//用来判断角色  同时具有 admin user
</span><span class="c1"></span>    <span class="nd">@RequiresPermissions</span><span class="o">(</span><span class="s">&#34;user:update:01&#34;</span><span class="o">)</span> <span class="c1">//用来判断权限字符串
</span><span class="c1"></span>    <span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">&#34;save&#34;</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">save</span><span class="o">(){</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;进入方法&#34;</span><span class="o">);</span>
        <span class="k">return</span> <span class="s">&#34;redirect:/index.jsp&#34;</span><span class="o">;</span>
    <span class="o">}</span>

<span class="o">}</span>
</code></pre></div><h4 id="682-连接数据库">6.8.2 连接数据库</h4>
<h5 id="4授权数据持久化">4.授权数据持久化</h5>
<p><img src="/shiro.assets/image-20210607160007546.png" alt="image-20210607160007546"></p>
<div class="highlight"><pre class="chroma"><code class="language-mysql" data-lang="mysql"><span class="kt">SET</span> <span class="n">NAMES</span> <span class="n">utf8mb4</span><span class="p">;</span>
<span class="kt">SET</span> <span class="n">FOREIGN_KEY_CHECKS</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="c1">-- ----------------------------
</span><span class="c1">-- Table structure for t_perms
</span><span class="c1">-- ----------------------------
</span><span class="c1"></span><span class="k">DROP</span> <span class="k">TABLE</span> <span class="k">IF</span> <span class="k">EXISTS</span> <span class="o">`</span><span class="n">t_perms</span><span class="o">`</span><span class="p">;</span>
<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="o">`</span><span class="n">t_pers</span><span class="o">`</span> <span class="p">(</span>
  <span class="o">`</span><span class="n">id</span><span class="o">`</span> <span class="kt">int</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="k">NOT</span> <span class="no">NULL</span> <span class="kp">AUTO_INCREMENT</span><span class="p">,</span>
  <span class="o">`</span><span class="n">name</span><span class="o">`</span> <span class="kt">varchar</span><span class="p">(</span><span class="mi">80</span><span class="p">)</span> <span class="k">DEFAULT</span> <span class="no">NULL</span><span class="p">,</span>
  <span class="o">`</span><span class="n">url</span><span class="o">`</span> <span class="kt">varchar</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span> <span class="k">DEFAULT</span> <span class="no">NULL</span><span class="p">,</span>
  <span class="k">PRIMARY</span> <span class="k">KEY</span> <span class="p">(</span><span class="o">`</span><span class="n">id</span><span class="o">`</span><span class="p">)</span>
<span class="p">)</span> <span class="kp">ENGINE</span><span class="o">=</span><span class="n">InnoDB</span> <span class="k">DEFAULT</span> <span class="kp">CHARSET</span><span class="o">=</span><span class="n">utf8</span><span class="p">;</span>

<span class="c1">-- ----------------------------
</span><span class="c1">-- Table structure for t_role
</span><span class="c1">-- ----------------------------
</span><span class="c1"></span><span class="k">DROP</span> <span class="k">TABLE</span> <span class="k">IF</span> <span class="k">EXISTS</span> <span class="o">`</span><span class="n">t_role</span><span class="o">`</span><span class="p">;</span>
<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="o">`</span><span class="n">t_role</span><span class="o">`</span> <span class="p">(</span>
  <span class="o">`</span><span class="n">id</span><span class="o">`</span> <span class="kt">int</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="k">NOT</span> <span class="no">NULL</span> <span class="kp">AUTO_INCREMENT</span><span class="p">,</span>
  <span class="o">`</span><span class="n">name</span><span class="o">`</span> <span class="kt">varchar</span><span class="p">(</span><span class="mi">60</span><span class="p">)</span> <span class="k">DEFAULT</span> <span class="no">NULL</span><span class="p">,</span>
  <span class="k">PRIMARY</span> <span class="k">KEY</span> <span class="p">(</span><span class="o">`</span><span class="n">id</span><span class="o">`</span><span class="p">)</span>
<span class="p">)</span> <span class="kp">ENGINE</span><span class="o">=</span><span class="n">InnoDB</span> <span class="k">DEFAULT</span> <span class="kp">CHARSET</span><span class="o">=</span><span class="n">utf8</span><span class="p">;</span>

<span class="c1">-- ----------------------------
</span><span class="c1">-- Table structure for t_role_perms
</span><span class="c1">-- ----------------------------
</span><span class="c1"></span><span class="k">DROP</span> <span class="k">TABLE</span> <span class="k">IF</span> <span class="k">EXISTS</span> <span class="o">`</span><span class="n">t_role_perms</span><span class="o">`</span><span class="p">;</span>
<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="o">`</span><span class="n">t_role_perms</span><span class="o">`</span> <span class="p">(</span>
  <span class="o">`</span><span class="n">id</span><span class="o">`</span> <span class="kt">int</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="k">NOT</span> <span class="no">NULL</span><span class="p">,</span>
  <span class="o">`</span><span class="n">roleid</span><span class="o">`</span> <span class="kt">int</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="k">DEFAULT</span> <span class="no">NULL</span><span class="p">,</span>
  <span class="o">`</span><span class="n">permsid</span><span class="o">`</span> <span class="kt">int</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="k">DEFAULT</span> <span class="no">NULL</span><span class="p">,</span>
  <span class="k">PRIMARY</span> <span class="k">KEY</span> <span class="p">(</span><span class="o">`</span><span class="n">id</span><span class="o">`</span><span class="p">)</span>
<span class="p">)</span> <span class="kp">ENGINE</span><span class="o">=</span><span class="n">InnoDB</span> <span class="k">DEFAULT</span> <span class="kp">CHARSET</span><span class="o">=</span><span class="n">utf8</span><span class="p">;</span>

<span class="c1">-- ----------------------------
</span><span class="c1">-- Table structure for t_user
</span><span class="c1">-- ----------------------------
</span><span class="c1"></span><span class="k">DROP</span> <span class="k">TABLE</span> <span class="k">IF</span> <span class="k">EXISTS</span> <span class="o">`</span><span class="n">t_user</span><span class="o">`</span><span class="p">;</span>
<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="o">`</span><span class="n">t_user</span><span class="o">`</span> <span class="p">(</span>
  <span class="o">`</span><span class="n">id</span><span class="o">`</span> <span class="kt">int</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="k">NOT</span> <span class="no">NULL</span> <span class="kp">AUTO_INCREMENT</span><span class="p">,</span>
  <span class="o">`</span><span class="n">username</span><span class="o">`</span> <span class="kt">varchar</span><span class="p">(</span><span class="mi">40</span><span class="p">)</span> <span class="k">DEFAULT</span> <span class="no">NULL</span><span class="p">,</span>
  <span class="o">`</span><span class="n">password</span><span class="o">`</span> <span class="kt">varchar</span><span class="p">(</span><span class="mi">40</span><span class="p">)</span> <span class="k">DEFAULT</span> <span class="no">NULL</span><span class="p">,</span>
  <span class="o">`</span><span class="n">salt</span><span class="o">`</span> <span class="kt">varchar</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span> <span class="k">DEFAULT</span> <span class="no">NULL</span><span class="p">,</span>
  <span class="k">PRIMARY</span> <span class="k">KEY</span> <span class="p">(</span><span class="o">`</span><span class="n">id</span><span class="o">`</span><span class="p">)</span>
<span class="p">)</span> <span class="kp">ENGINE</span><span class="o">=</span><span class="n">InnoDB</span> <span class="kp">AUTO_INCREMENT</span><span class="o">=</span><span class="mi">2</span> <span class="k">DEFAULT</span> <span class="kp">CHARSET</span><span class="o">=</span><span class="n">utf8</span><span class="p">;</span>

<span class="c1">-- ----------------------------
</span><span class="c1">-- Table structure for t_user_role
</span><span class="c1">-- ----------------------------
</span><span class="c1"></span><span class="k">DROP</span> <span class="k">TABLE</span> <span class="k">IF</span> <span class="k">EXISTS</span> <span class="o">`</span><span class="n">t_user_role</span><span class="o">`</span><span class="p">;</span>
<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="o">`</span><span class="n">t_user_role</span><span class="o">`</span> <span class="p">(</span>
  <span class="o">`</span><span class="n">id</span><span class="o">`</span> <span class="kt">int</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="k">NOT</span> <span class="no">NULL</span><span class="p">,</span>
  <span class="o">`</span><span class="n">userid</span><span class="o">`</span> <span class="kt">int</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="k">DEFAULT</span> <span class="no">NULL</span><span class="p">,</span>
  <span class="o">`</span><span class="n">roleid</span><span class="o">`</span> <span class="kt">int</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="k">DEFAULT</span> <span class="no">NULL</span><span class="p">,</span>
  <span class="k">PRIMARY</span> <span class="k">KEY</span> <span class="p">(</span><span class="o">`</span><span class="n">id</span><span class="o">`</span><span class="p">)</span>
<span class="p">)</span> <span class="kp">ENGINE</span><span class="o">=</span><span class="n">InnoDB</span> <span class="k">DEFAULT</span> <span class="kp">CHARSET</span><span class="o">=</span><span class="n">utf8</span><span class="p">;</span>

<span class="kt">SET</span> <span class="n">FOREIGN_KEY_CHECKS</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</code></pre></div><p><img src="/shiro.assets/image-20210607160025308.png" alt="image-20210607160025308"></p>
<h5 id="5创建实体类">5.创建实体类</h5>
<p>User</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="nd">@Data</span>
<span class="nd">@Accessors</span><span class="o">(</span><span class="n">chain</span> <span class="o">=</span> <span class="kc">true</span><span class="o">)</span>
<span class="nd">@AllArgsConstructor</span>
<span class="nd">@NoArgsConstructor</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">User</span> <span class="kd">implements</span> <span class="n">Serializable</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">id</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">username</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">password</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">salt</span><span class="o">;</span>

    <span class="c1">//定义角色集合
</span><span class="c1"></span>    <span class="kd">private</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Role</span><span class="o">&gt;</span> <span class="n">roles</span><span class="o">;</span>

<span class="o">}</span>
</code></pre></div><p>Role</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="nd">@Data</span>
<span class="nd">@Accessors</span><span class="o">(</span><span class="n">chain</span> <span class="o">=</span> <span class="kc">true</span><span class="o">)</span>
<span class="nd">@AllArgsConstructor</span>
<span class="nd">@NoArgsConstructor</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Role</span> <span class="kd">implements</span> <span class="n">Serializable</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">id</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">name</span><span class="o">;</span>

    <span class="c1">//定义权限的集合
</span><span class="c1"></span>    <span class="kd">private</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Perms</span><span class="o">&gt;</span> <span class="n">perms</span><span class="o">;</span>

<span class="o">}</span>
</code></pre></div><p>Perms</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="nd">@Data</span>
<span class="nd">@Accessors</span><span class="o">(</span><span class="n">chain</span> <span class="o">=</span> <span class="kc">true</span><span class="o">)</span>
<span class="nd">@AllArgsConstructor</span>
<span class="nd">@NoArgsConstructor</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Perms</span> <span class="kd">implements</span> <span class="n">Serializable</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">id</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">name</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">url</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div><h5 id="6创建dao方法">6.创建dao方法</h5>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="c1">//根据用户名查询所有角色
</span><span class="c1"></span><span class="n">User</span> <span class="nf">findRolesByUserName</span><span class="o">(</span><span class="n">String</span> <span class="n">username</span><span class="o">);</span>
<span class="c1">//根据角色id查询权限集合
</span><span class="c1"></span><span class="n">List</span><span class="o">&lt;</span><span class="n">Perms</span><span class="o">&gt;</span> <span class="nf">findPermsByRoleId</span><span class="o">(</span><span class="n">String</span> <span class="n">id</span><span class="o">);</span>
</code></pre></div><h5 id="7mapper实现">7.mapper实现</h5>
<div class="highlight"><pre class="chroma"><code class="language-xml" data-lang="xml"><span class="nt">&lt;resultMap</span> <span class="na">id=</span><span class="s">&#34;userMap&#34;</span> <span class="na">type=</span><span class="s">&#34;User&#34;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;id</span> <span class="na">column=</span><span class="s">&#34;uid&#34;</span> <span class="na">property=</span><span class="s">&#34;id&#34;</span><span class="nt">/&gt;</span>
  <span class="nt">&lt;result</span> <span class="na">column=</span><span class="s">&#34;username&#34;</span> <span class="na">property=</span><span class="s">&#34;username&#34;</span><span class="nt">/&gt;</span>
  <span class="c">&lt;!--角色信息--&gt;</span>
  <span class="nt">&lt;collection</span> <span class="na">property=</span><span class="s">&#34;roles&#34;</span> <span class="na">javaType=</span><span class="s">&#34;list&#34;</span> <span class="na">ofType=</span><span class="s">&#34;Role&#34;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;id</span> <span class="na">column=</span><span class="s">&#34;id&#34;</span> <span class="na">property=</span><span class="s">&#34;id&#34;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;result</span> <span class="na">column=</span><span class="s">&#34;rname&#34;</span> <span class="na">property=</span><span class="s">&#34;name&#34;</span><span class="nt">/&gt;</span>
  <span class="nt">&lt;/collection&gt;</span>
<span class="nt">&lt;/resultMap&gt;</span>

<span class="nt">&lt;select</span> <span class="na">id=</span><span class="s">&#34;findRolesByUserName&#34;</span> <span class="na">parameterType=</span><span class="s">&#34;String&#34;</span> <span class="na">resultMap=</span><span class="s">&#34;userMap&#34;</span><span class="nt">&gt;</span>
  SELECT u.id uid,u.username,r.id,r.NAME rname
  FROM t_user u
  LEFT JOIN t_user_role ur
  ON u.id=ur.userid
  LEFT JOIN t_role r
  ON ur.roleid=r.id
  WHERE u.username=#{username}
<span class="nt">&lt;/select&gt;</span>

<span class="nt">&lt;select</span> <span class="na">id=</span><span class="s">&#34;findPermsByRoleId&#34;</span> <span class="na">parameterType=</span><span class="s">&#34;String&#34;</span> <span class="na">resultType=</span><span class="s">&#34;Perms&#34;</span><span class="nt">&gt;</span>
  SELECT p.id,p.NAME,p.url,r.NAME
  FROM t_role r
  LEFT JOIN t_role_perms rp
  ON r.id=rp.roleid
  LEFT JOIN t_perms p ON rp.permsid=p.id
  WHERE r.id=#{id}
<span class="nt">&lt;/select&gt;</span>
</code></pre></div><h5 id="8service接口">8.Service接口</h5>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="c1">//根据用户名查询所有角色
</span><span class="c1"></span><span class="n">User</span> <span class="nf">findRolesByUserName</span><span class="o">(</span><span class="n">String</span> <span class="n">username</span><span class="o">);</span>
<span class="c1">//根据角色id查询权限集合
</span><span class="c1"></span><span class="n">List</span><span class="o">&lt;</span><span class="n">Perms</span><span class="o">&gt;</span> <span class="nf">findPermsByRoleId</span><span class="o">(</span><span class="n">String</span> <span class="n">id</span><span class="o">);</span>
</code></pre></div><h5 id="9service实现">9.Service实现</h5>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="nd">@Override</span>
<span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Perms</span><span class="o">&gt;</span> <span class="nf">findPermsByRoleId</span><span class="o">(</span><span class="n">String</span> <span class="n">id</span><span class="o">)</span> <span class="o">{</span>
  <span class="k">return</span> <span class="n">userDAO</span><span class="o">.</span><span class="na">findPermsByRoleId</span><span class="o">(</span><span class="n">id</span><span class="o">);</span>
<span class="o">}</span>

<span class="nd">@Override</span>
<span class="kd">public</span> <span class="n">User</span> <span class="nf">findRolesByUserName</span><span class="o">(</span><span class="n">String</span> <span class="n">username</span><span class="o">)</span> <span class="o">{</span>
  <span class="k">return</span> <span class="n">userDAO</span><span class="o">.</span><span class="na">findRolesByUserName</span><span class="o">(</span><span class="n">username</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div><h5 id="10修改自定义realm">10.修改自定义realm</h5>
<p>**注意：**如果你创建了一个用户，并为这个用户授予了一个角色，但这个角色并未关联任何的 授权字符串，那么调用数据库获得的结果是 List&lt;Perms&gt; perms=[null]，此时 perms已经被初始化，里面只有一个属性null，使用判空的方法无法判别，此时继续遍历会报出空指针异常，此时应当添加判断条件 perms.get(0)!=null</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kn">package</span> <span class="nn">com.lut.shiro.realms</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.lut.entity.Perms</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.lut.entity.User</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.lut.service.UserService</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.lut.utils.ApplicationContextUtils</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.shiro.authc.AuthenticationException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.shiro.authc.AuthenticationInfo</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.shiro.authc.AuthenticationToken</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.shiro.authc.SimpleAuthenticationInfo</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.shiro.authz.AuthorizationInfo</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.shiro.authz.SimpleAuthorizationInfo</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.shiro.realm.AuthorizingRealm</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.shiro.subject.PrincipalCollection</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.shiro.util.ByteSource</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.util.CollectionUtils</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.util.ObjectUtils</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>


<span class="c1">//自定义realm
</span><span class="c1"></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">CustomerRealm</span> <span class="kd">extends</span> <span class="n">AuthorizingRealm</span> <span class="o">{</span>

    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="n">AuthorizationInfo</span> <span class="nf">doGetAuthorizationInfo</span><span class="o">(</span><span class="n">PrincipalCollection</span> <span class="n">principals</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">//获取身份信息
</span><span class="c1"></span>        <span class="n">String</span> <span class="n">primaryPrincipal</span> <span class="o">=</span> <span class="o">(</span><span class="n">String</span><span class="o">)</span> <span class="n">principals</span><span class="o">.</span><span class="na">getPrimaryPrincipal</span><span class="o">();</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;调用授权验证: &#34;</span><span class="o">+</span><span class="n">primaryPrincipal</span><span class="o">);</span>
        <span class="c1">//根据主身份信息获取角色 和 权限信息
</span><span class="c1"></span>        <span class="n">UserService</span> <span class="n">userService</span> <span class="o">=</span> <span class="o">(</span><span class="n">UserService</span><span class="o">)</span> <span class="n">ApplicationContextUtils</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="s">&#34;userService&#34;</span><span class="o">);</span>
        <span class="n">User</span> <span class="n">user</span> <span class="o">=</span> <span class="n">userService</span><span class="o">.</span><span class="na">findRolesByUserName</span><span class="o">(</span><span class="n">primaryPrincipal</span><span class="o">);</span>

        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;user:&#34;</span><span class="o">+</span><span class="n">user</span><span class="o">);</span>

        <span class="c1">//授权角色信息
</span><span class="c1"></span>        <span class="k">if</span><span class="o">(!</span><span class="n">CollectionUtils</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">(</span><span class="n">user</span><span class="o">.</span><span class="na">getRoles</span><span class="o">())){</span>

            <span class="n">SimpleAuthorizationInfo</span> <span class="n">simpleAuthorizationInfo</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SimpleAuthorizationInfo</span><span class="o">();</span>

            <span class="n">user</span><span class="o">.</span><span class="na">getRoles</span><span class="o">().</span><span class="na">forEach</span><span class="o">(</span><span class="n">role</span><span class="o">-&gt;{</span>
                <span class="n">simpleAuthorizationInfo</span><span class="o">.</span><span class="na">addRole</span><span class="o">(</span><span class="n">role</span><span class="o">.</span><span class="na">getName</span><span class="o">());</span> <span class="c1">//添加角色信息
</span><span class="c1"></span>
                <span class="c1">//权限信息
</span><span class="c1"></span>                <span class="n">List</span><span class="o">&lt;</span><span class="n">Perms</span><span class="o">&gt;</span> <span class="n">perms</span> <span class="o">=</span> <span class="n">userService</span><span class="o">.</span><span class="na">findPermsByRoleId</span><span class="o">(</span><span class="n">role</span><span class="o">.</span><span class="na">getId</span><span class="o">());</span>
                <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;perms:&#34;</span><span class="o">+</span><span class="n">perms</span><span class="o">);</span>

                <span class="k">if</span><span class="o">(!</span><span class="n">CollectionUtils</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">(</span><span class="n">perms</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="n">perms</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">0</span><span class="o">)!=</span><span class="kc">null</span> <span class="o">){</span>
                    <span class="n">perms</span><span class="o">.</span><span class="na">forEach</span><span class="o">(</span><span class="n">perm</span><span class="o">-&gt;{</span>
                        <span class="n">simpleAuthorizationInfo</span><span class="o">.</span><span class="na">addStringPermission</span><span class="o">(</span><span class="n">perm</span><span class="o">.</span><span class="na">getName</span><span class="o">());</span>
                    <span class="o">});</span>
                <span class="o">}</span>
            <span class="o">});</span>
            <span class="k">return</span> <span class="n">simpleAuthorizationInfo</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="n">AuthenticationInfo</span> <span class="nf">doGetAuthenticationInfo</span><span class="o">(</span><span class="n">AuthenticationToken</span> <span class="n">token</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">AuthenticationException</span> <span class="o">{</span>

        <span class="c1">//根据身份信息//从传过来的token获取到的用户名
</span><span class="c1"></span>        <span class="n">String</span> <span class="n">principal</span> <span class="o">=</span> <span class="o">(</span><span class="n">String</span><span class="o">)</span> <span class="n">token</span><span class="o">.</span><span class="na">getPrincipal</span><span class="o">();</span>

        <span class="c1">//在工厂中获取service对象
</span><span class="c1"></span>        <span class="n">UserService</span> <span class="n">userService</span> <span class="o">=</span> <span class="o">(</span><span class="n">UserService</span><span class="o">)</span> <span class="n">ApplicationContextUtils</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="s">&#34;userService&#34;</span><span class="o">);</span>

        <span class="c1">//根据身份信息查询
</span><span class="c1"></span>        <span class="n">User</span> <span class="n">user</span> <span class="o">=</span> <span class="n">userService</span><span class="o">.</span><span class="na">findByUserName</span><span class="o">(</span><span class="n">principal</span><span class="o">);</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;User:&#34;</span><span class="o">+</span><span class="n">user</span><span class="o">);</span>

        <span class="c1">//用户不为空
</span><span class="c1"></span>        <span class="k">if</span><span class="o">(!</span><span class="n">ObjectUtils</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">(</span><span class="n">user</span><span class="o">)){</span>
            <span class="c1">//返回数据库信息
</span><span class="c1"></span>            <span class="n">SimpleAuthenticationInfo</span> <span class="n">simpleAuthenticationInfo</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SimpleAuthenticationInfo</span><span class="o">(</span><span class="n">user</span><span class="o">.</span><span class="na">getUsername</span><span class="o">(),</span> <span class="n">user</span><span class="o">.</span><span class="na">getPassword</span><span class="o">(),</span>
                    <span class="n">ByteSource</span><span class="o">.</span><span class="na">Util</span><span class="o">.</span><span class="na">bytes</span><span class="o">(</span><span class="n">user</span><span class="o">.</span><span class="na">getSalt</span><span class="o">()),</span> <span class="k">this</span><span class="o">.</span><span class="na">getName</span><span class="o">());</span>
            <span class="k">return</span> <span class="n">simpleAuthenticationInfo</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div><h5 id="11向数据库添加信息">11.向数据库添加信息</h5>
<p><img src="/shiro.assets/image-20210607160335274.png" alt="image-20210607160335274"></p>
<p>简单来说：</p>
<p>用户 admin 具有 admin的角色，具有 对于 user，order的所有权限</p>
<p>用户 zhangsan 具有 user的角色，没有权限，只能访问公共资源</p>
<p>用户 usermanager 具有 user_manager的角色，具有 对于 user的所有权限</p>
<p>用户 ordermanager 具有 order_manager的角色，具有 对于 order的所有权限</p>
<p>用户 addinfomanager 具有 addinfo_manager的角色，具有 对于 user,order 的添加权限</p>
<h5 id="12启动测试">12.启动测试</h5>
<p><img src="/shiro.assets/image-20210607160421045.png" alt="image-20210607160421045"></p>
<h3 id="69-使用cachemanager">6.9 使用CacheManager</h3>
<h4 id="691-cache-作用">6.9.1 Cache 作用</h4>
<ul>
<li>
<p>Cache 缓存: <strong>计算机内存中一段数据</strong></p>
</li>
<li>
<p>作用: <strong>用来减轻DB的访问压力,从而提高系统的查询效率</strong></p>
</li>
<li>
<p>流程:</p>
<p><img src="/shiro.assets/image-20210607160443452.png" alt="image-20210607160443452"></p>
</li>
</ul>
<h4 id="692-使用shiro中默认ehcache实现缓存">6.9.2 使用shiro中默认EhCache实现缓存</h4>
<h5 id="1引入依赖">1.引入依赖</h5>
<div class="highlight"><pre class="chroma"><code class="language-xml" data-lang="xml"><span class="c">&lt;!--引入shiro和ehcache--&gt;</span>
<span class="nt">&lt;dependency&gt;</span>
  <span class="nt">&lt;groupId&gt;</span>org.apache.shiro<span class="nt">&lt;/groupId&gt;</span>
  <span class="nt">&lt;artifactId&gt;</span>shiro-ehcache<span class="nt">&lt;/artifactId&gt;</span>
  <span class="nt">&lt;version&gt;</span>1.5.3<span class="nt">&lt;/version&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</code></pre></div><h5 id="2开启缓存">2.开启缓存</h5>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="c1">//3.创建自定义realm
</span><span class="c1"></span><span class="nd">@Bean</span>
<span class="kd">public</span> <span class="n">Realm</span> <span class="nf">getRealm</span><span class="o">(){</span>
    <span class="n">CustomerRealm</span> <span class="n">customerRealm</span> <span class="o">=</span> <span class="k">new</span> <span class="n">CustomerRealm</span><span class="o">();</span>
    <span class="c1">//修改凭证校验匹配器
</span><span class="c1"></span>    <span class="n">HashedCredentialsMatcher</span> <span class="n">credentialsMatcher</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashedCredentialsMatcher</span><span class="o">();</span>
    <span class="c1">//设置加密算法为md5
</span><span class="c1"></span>    <span class="n">credentialsMatcher</span><span class="o">.</span><span class="na">setHashAlgorithmName</span><span class="o">(</span><span class="s">&#34;MD5&#34;</span><span class="o">);</span>
    <span class="c1">//设置散列次数
</span><span class="c1"></span>    <span class="n">credentialsMatcher</span><span class="o">.</span><span class="na">setHashIterations</span><span class="o">(</span><span class="n">1024</span><span class="o">);</span>
    <span class="n">customerRealm</span><span class="o">.</span><span class="na">setCredentialsMatcher</span><span class="o">(</span><span class="n">credentialsMatcher</span><span class="o">);</span>

    <span class="c1">//开启缓存管理器
</span><span class="c1"></span>    <span class="n">customerRealm</span><span class="o">.</span><span class="na">setCachingEnabled</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span> <span class="c1">// 开启全局缓存
</span><span class="c1"></span>    <span class="n">customerRealm</span><span class="o">.</span><span class="na">setAuthenticationCachingEnabled</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span> <span class="c1">// 开启认证缓存
</span><span class="c1"></span>    <span class="n">customerRealm</span><span class="o">.</span><span class="na">setAuthenticationCacheName</span><span class="o">(</span><span class="s">&#34;authenticationCache&#34;</span><span class="o">);</span> <span class="c1">// 设置认证缓存名（默认是： 当前的Realm 加上 .Authentication ）
</span><span class="c1"></span>    <span class="n">customerRealm</span><span class="o">.</span><span class="na">setAuthorizationCachingEnabled</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span> <span class="c1">// 开启授权缓存
</span><span class="c1"></span>    <span class="n">customerRealm</span><span class="o">.</span><span class="na">setAuthorizationCacheName</span><span class="o">(</span><span class="s">&#34;authorizationCache&#34;</span><span class="o">);</span> <span class="c1">// 设置授权缓存名
</span><span class="c1"></span>    <span class="n">customerRealm</span><span class="o">.</span><span class="na">setCacheManager</span><span class="o">(</span><span class="k">new</span> <span class="n">EhCacheManager</span><span class="o">());</span>
    <span class="k">return</span> <span class="n">customerRealm</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div><h5 id="3启动刷新页面进行测试">3.启动刷新页面进行测试</h5>
<p>注意:如果控制台没有任何sql展示说明缓存已经开启</p>
<h4 id="693-shiro中使用redis作为缓存实现">6.9.3 shiro中使用Redis作为缓存实现</h4>
<h5 id="1引入redis依赖">1.引入redis依赖</h5>
<div class="highlight"><pre class="chroma"><code class="language-xml" data-lang="xml"><span class="c">&lt;!--redis整合springboot--&gt;</span>
<span class="nt">&lt;dependency&gt;</span>
  <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
  <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-data-redis<span class="nt">&lt;/artifactId&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</code></pre></div><h5 id="2配置redis连接">2.配置redis连接</h5>
<pre><code class="language-properties" data-lang="properties">spring.redis.port=6379
spring.redis.host=localhost
spring.redis.database=0
</code></pre><h5 id="3启动redis服务">3.启动redis服务</h5>
<p><img src="/shiro.assets/image-20210607160619591.png" alt="image-20210607160619591"></p>
<h5 id="4开发rediscachemanager">4.开发RedisCacheManager</h5>
<p><strong>自定义shiro缓存管理器</strong></p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kn">package</span> <span class="nn">com.lut.shiro.cache</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.apache.shiro.cache.Cache</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.shiro.cache.CacheException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.shiro.cache.CacheManager</span><span class="o">;</span>

<span class="c1">//自定义shiro缓存管理器
</span><span class="c1"></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">RedisCacheManager</span> <span class="kd">implements</span> <span class="n">CacheManager</span> <span class="o">{</span>

    <span class="c1">//参数1:认证或者是授权缓存的统一名称
</span><span class="c1"></span>    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="o">&lt;</span><span class="n">K</span><span class="o">,</span> <span class="n">V</span><span class="o">&gt;</span> <span class="n">Cache</span><span class="o">&lt;</span><span class="n">K</span><span class="o">,</span> <span class="n">V</span><span class="o">&gt;</span> <span class="nf">getCache</span><span class="o">(</span><span class="n">String</span> <span class="n">cacheName</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">CacheException</span> <span class="o">{</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">cacheName</span><span class="o">);</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">RedisCache</span><span class="o">&lt;</span><span class="n">K</span><span class="o">,</span><span class="n">V</span><span class="o">&gt;(</span><span class="n">cacheName</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div><h5 id="5开rediscache实现">5.开RedisCache实现</h5>
<p><strong>自定义redis缓存的实现</strong></p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kn">package</span> <span class="nn">com.lut.shiro.cache</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.lut.utils.ApplicationContextUtils</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.shiro.cache.Cache</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.shiro.cache.CacheException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.data.redis.core.RedisTemplate</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.data.redis.serializer.StringRedisSerializer</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.Collection</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Set</span><span class="o">;</span>

<span class="c1">//自定义redis缓存的实现
</span><span class="c1"></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">RedisCache</span><span class="o">&lt;</span><span class="n">k</span><span class="o">,</span><span class="n">v</span><span class="o">&gt;</span> <span class="kd">implements</span> <span class="n">Cache</span><span class="o">&lt;</span><span class="n">k</span><span class="o">,</span><span class="n">v</span><span class="o">&gt;</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="n">String</span> <span class="n">cacheName</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">RedisCache</span><span class="o">()</span> <span class="o">{</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="nf">RedisCache</span><span class="o">(</span><span class="n">String</span> <span class="n">cacheName</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">cacheName</span> <span class="o">=</span> <span class="n">cacheName</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">v</span> <span class="nf">get</span><span class="o">(</span><span class="n">k</span> <span class="n">k</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">CacheException</span> <span class="o">{</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;get key:&#34;</span><span class="o">+</span><span class="n">k</span><span class="o">);</span>
        <span class="k">return</span> <span class="o">(</span><span class="n">v</span><span class="o">)</span> <span class="n">getRedisTemplate</span><span class="o">().</span><span class="na">opsForHash</span><span class="o">().</span><span class="na">get</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">cacheName</span><span class="o">,</span><span class="n">k</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">v</span> <span class="nf">put</span><span class="o">(</span><span class="n">k</span> <span class="n">k</span><span class="o">,</span> <span class="n">v</span> <span class="n">v</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">CacheException</span> <span class="o">{</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;put key: &#34;</span><span class="o">+</span><span class="n">k</span><span class="o">);</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;put value:&#34;</span><span class="o">+</span><span class="n">v</span><span class="o">);</span>
        <span class="n">getRedisTemplate</span><span class="o">().</span><span class="na">opsForHash</span><span class="o">().</span><span class="na">put</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">cacheName</span><span class="o">,</span><span class="n">k</span><span class="o">.</span><span class="na">toString</span><span class="o">(),</span><span class="n">v</span><span class="o">);</span>
        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">v</span> <span class="nf">remove</span><span class="o">(</span><span class="n">k</span> <span class="n">k</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">CacheException</span> <span class="o">{</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;=============remove=============&#34;</span><span class="o">);</span>
        <span class="k">return</span> <span class="o">(</span><span class="n">v</span><span class="o">)</span> <span class="n">getRedisTemplate</span><span class="o">().</span><span class="na">opsForHash</span><span class="o">().</span><span class="na">delete</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">cacheName</span><span class="o">,</span><span class="n">k</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">clear</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">CacheException</span> <span class="o">{</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;=============clear==============&#34;</span><span class="o">);</span>
        <span class="n">getRedisTemplate</span><span class="o">().</span><span class="na">delete</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">cacheName</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">size</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">getRedisTemplate</span><span class="o">().</span><span class="na">opsForHash</span><span class="o">().</span><span class="na">size</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">cacheName</span><span class="o">).</span><span class="na">intValue</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">Set</span><span class="o">&lt;</span><span class="n">k</span><span class="o">&gt;</span> <span class="nf">keys</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">getRedisTemplate</span><span class="o">().</span><span class="na">opsForHash</span><span class="o">().</span><span class="na">keys</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">cacheName</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">Collection</span><span class="o">&lt;</span><span class="n">v</span><span class="o">&gt;</span> <span class="nf">values</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">getRedisTemplate</span><span class="o">().</span><span class="na">opsForHash</span><span class="o">().</span><span class="na">values</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">cacheName</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="n">RedisTemplate</span> <span class="nf">getRedisTemplate</span><span class="o">(){</span>
        <span class="n">RedisTemplate</span> <span class="n">redisTemplate</span> <span class="o">=</span> <span class="o">(</span><span class="n">RedisTemplate</span><span class="o">)</span> <span class="n">ApplicationContextUtils</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="s">&#34;redisTemplate&#34;</span><span class="o">);</span>
        <span class="n">redisTemplate</span><span class="o">.</span><span class="na">setKeySerializer</span><span class="o">(</span><span class="k">new</span> <span class="n">StringRedisSerializer</span><span class="o">());</span>
        <span class="n">redisTemplate</span><span class="o">.</span><span class="na">setHashKeySerializer</span><span class="o">(</span><span class="k">new</span> <span class="n">StringRedisSerializer</span><span class="o">());</span>
        <span class="k">return</span> <span class="n">redisTemplate</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div><h5 id="6启动项目测试发现报错">6.启动项目测试发现报错</h5>
<p><img src="/shiro.assets/image-20210607160717985.png" alt="image-20210607160717985"></p>
<p><img src="/shiro.assets/image-20210607160728019.png" alt="image-20210607160728019"></p>
<ul>
<li>
<p>错误解释: <strong>由于shiro中提供的simpleByteSource实现没有实现序列化,所有在认证时出现错误信息</strong></p>
</li>
<li>
<p>解决方案: <strong>需要自动salt实现序列化</strong></p>
<ul>
<li>
<p>实现 实体类 序列化</p>
</li>
<li>
<p><strong>自定义salt实现 实现序列化接口</strong></p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kn">package</span> <span class="nn">com.lut.shiro.salt</span><span class="o">;</span>
    
<span class="kn">import</span> <span class="nn">org.apache.shiro.codec.Base64</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.shiro.codec.CodecSupport</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.shiro.codec.Hex</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.shiro.util.ByteSource</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.File</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.InputStream</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.Serializable</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Arrays</span><span class="o">;</span>
<span class="c1">//自定义salt实现 实现序列化接口
</span><span class="c1"></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MyByteSource</span> <span class="kd">implements</span> <span class="n">ByteSource</span><span class="o">,</span> <span class="n">Serializable</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kt">byte</span><span class="o">[]</span> <span class="n">bytes</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">cachedHex</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">cachedBase64</span><span class="o">;</span>
    
    <span class="kd">public</span> <span class="nf">MyByteSource</span><span class="o">(){</span>
    
    <span class="o">}</span>
    
    <span class="kd">public</span> <span class="nf">MyByteSource</span><span class="o">(</span><span class="kt">byte</span><span class="o">[]</span> <span class="n">bytes</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">bytes</span> <span class="o">=</span> <span class="n">bytes</span><span class="o">;</span>
    <span class="o">}</span>
    
    <span class="kd">public</span> <span class="nf">MyByteSource</span><span class="o">(</span><span class="kt">char</span><span class="o">[]</span> <span class="n">chars</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">bytes</span> <span class="o">=</span> <span class="n">CodecSupport</span><span class="o">.</span><span class="na">toBytes</span><span class="o">(</span><span class="n">chars</span><span class="o">);</span>
    <span class="o">}</span>
    
    <span class="kd">public</span> <span class="nf">MyByteSource</span><span class="o">(</span><span class="n">String</span> <span class="n">string</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">bytes</span> <span class="o">=</span> <span class="n">CodecSupport</span><span class="o">.</span><span class="na">toBytes</span><span class="o">(</span><span class="n">string</span><span class="o">);</span>
    <span class="o">}</span>
    
    <span class="kd">public</span> <span class="nf">MyByteSource</span><span class="o">(</span><span class="n">ByteSource</span> <span class="n">source</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">bytes</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="na">getBytes</span><span class="o">();</span>
    <span class="o">}</span>
    
    <span class="kd">public</span> <span class="nf">MyByteSource</span><span class="o">(</span><span class="n">File</span> <span class="n">file</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">bytes</span> <span class="o">=</span> <span class="o">(</span><span class="k">new</span> <span class="n">com</span><span class="o">.</span><span class="na">lut</span><span class="o">.</span><span class="na">shiro</span><span class="o">.</span><span class="na">salt</span><span class="o">.</span><span class="na">MyByteSource</span><span class="o">.</span><span class="na">BytesHelper</span><span class="o">()).</span><span class="na">getBytes</span><span class="o">(</span><span class="n">file</span><span class="o">);</span>
    <span class="o">}</span>
    
    <span class="kd">public</span> <span class="nf">MyByteSource</span><span class="o">(</span><span class="n">InputStream</span> <span class="n">stream</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">bytes</span> <span class="o">=</span> <span class="o">(</span><span class="k">new</span> <span class="n">com</span><span class="o">.</span><span class="na">lut</span><span class="o">.</span><span class="na">shiro</span><span class="o">.</span><span class="na">salt</span><span class="o">.</span><span class="na">MyByteSource</span><span class="o">.</span><span class="na">BytesHelper</span><span class="o">()).</span><span class="na">getBytes</span><span class="o">(</span><span class="n">stream</span><span class="o">);</span>
    <span class="o">}</span>
    
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">boolean</span> <span class="nf">isCompatible</span><span class="o">(</span><span class="n">Object</span> <span class="n">o</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">o</span> <span class="k">instanceof</span> <span class="kt">byte</span><span class="o">[]</span> <span class="o">||</span> <span class="n">o</span> <span class="k">instanceof</span> <span class="kt">char</span><span class="o">[]</span> <span class="o">||</span> <span class="n">o</span> <span class="k">instanceof</span> <span class="n">String</span> <span class="o">||</span> <span class="n">o</span> <span class="k">instanceof</span> <span class="n">ByteSource</span> <span class="o">||</span> <span class="n">o</span> <span class="k">instanceof</span> <span class="n">File</span> <span class="o">||</span> <span class="n">o</span> <span class="k">instanceof</span> <span class="n">InputStream</span><span class="o">;</span>
    <span class="o">}</span>
    
    <span class="kd">public</span> <span class="kt">byte</span><span class="o">[]</span> <span class="nf">getBytes</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">bytes</span><span class="o">;</span>
    <span class="o">}</span>
    
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isEmpty</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">bytes</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="k">this</span><span class="o">.</span><span class="na">bytes</span><span class="o">.</span><span class="na">length</span> <span class="o">==</span> <span class="n">0</span><span class="o">;</span>
    <span class="o">}</span>
    
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">toHex</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">cachedHex</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">cachedHex</span> <span class="o">=</span> <span class="n">Hex</span><span class="o">.</span><span class="na">encodeToString</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">getBytes</span><span class="o">());</span>
        <span class="o">}</span>
    
        <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">cachedHex</span><span class="o">;</span>
    <span class="o">}</span>
    
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">toBase64</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">cachedBase64</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">cachedBase64</span> <span class="o">=</span> <span class="n">Base64</span><span class="o">.</span><span class="na">encodeToString</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">getBytes</span><span class="o">());</span>
        <span class="o">}</span>
    
        <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">cachedBase64</span><span class="o">;</span>
    <span class="o">}</span>
    
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">toString</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">toBase64</span><span class="o">();</span>
    <span class="o">}</span>
    
    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">hashCode</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">bytes</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="o">.</span><span class="na">bytes</span><span class="o">.</span><span class="na">length</span> <span class="o">!=</span> <span class="n">0</span> <span class="o">?</span> <span class="n">Arrays</span><span class="o">.</span><span class="na">hashCode</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">bytes</span><span class="o">)</span> <span class="o">:</span> <span class="n">0</span><span class="o">;</span>
    <span class="o">}</span>
    
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">equals</span><span class="o">(</span><span class="n">Object</span> <span class="n">o</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">o</span> <span class="o">==</span> <span class="k">this</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">o</span> <span class="k">instanceof</span> <span class="n">ByteSource</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">ByteSource</span> <span class="n">bs</span> <span class="o">=</span> <span class="o">(</span><span class="n">ByteSource</span><span class="o">)</span><span class="n">o</span><span class="o">;</span>
            <span class="k">return</span> <span class="n">Arrays</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">getBytes</span><span class="o">(),</span> <span class="n">bs</span><span class="o">.</span><span class="na">getBytes</span><span class="o">());</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>
    
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">BytesHelper</span> <span class="kd">extends</span> <span class="n">CodecSupport</span> <span class="o">{</span>
        <span class="kd">private</span> <span class="nf">BytesHelper</span><span class="o">()</span> <span class="o">{</span>
        <span class="o">}</span>
    
        <span class="kd">public</span> <span class="kt">byte</span><span class="o">[]</span> <span class="nf">getBytes</span><span class="o">(</span><span class="n">File</span> <span class="n">file</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">toBytes</span><span class="o">(</span><span class="n">file</span><span class="o">);</span>
        <span class="o">}</span>
    
        <span class="kd">public</span> <span class="kt">byte</span><span class="o">[]</span> <span class="nf">getBytes</span><span class="o">(</span><span class="n">InputStream</span> <span class="n">stream</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">toBytes</span><span class="o">(</span><span class="n">stream</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></li>
<li>
<p>在realm中使用自定义salt</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="nd">@Override</span>
<span class="kd">protected</span> <span class="n">AuthenticationInfo</span> <span class="nf">doGetAuthenticationInfo</span><span class="o">(</span><span class="n">AuthenticationToken</span> <span class="n">token</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">AuthenticationException</span> <span class="o">{</span>
  <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;==========================&#34;</span><span class="o">);</span>
  <span class="c1">//根据身份信息
</span><span class="c1"></span>  <span class="n">String</span> <span class="n">principal</span> <span class="o">=</span> <span class="o">(</span><span class="n">String</span><span class="o">)</span> <span class="n">token</span><span class="o">.</span><span class="na">getPrincipal</span><span class="o">();</span>
  <span class="c1">//在工厂中获取service对象
</span><span class="c1"></span>  <span class="n">UserService</span> <span class="n">userService</span> <span class="o">=</span> <span class="o">(</span><span class="n">UserService</span><span class="o">)</span> <span class="n">ApplicationContextUtils</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="s">&#34;userService&#34;</span><span class="o">);</span>
  <span class="n">User</span> <span class="n">user</span> <span class="o">=</span> <span class="n">userService</span><span class="o">.</span><span class="na">findByUserName</span><span class="o">(</span><span class="n">principal</span><span class="o">);</span>
  <span class="k">if</span><span class="o">(!</span><span class="n">ObjectUtils</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">(</span><span class="n">user</span><span class="o">)){</span>
    <span class="k">return</span> <span class="k">new</span> <span class="n">SimpleAuthenticationInfo</span><span class="o">(</span><span class="n">user</span><span class="o">.</span><span class="na">getUsername</span><span class="o">(),</span><span class="n">user</span><span class="o">.</span><span class="na">getPassword</span><span class="o">(),</span> 
                                      <span class="k">new</span> <span class="n">MyByteSource</span><span class="o">(</span><span class="n">user</span><span class="o">.</span><span class="na">getSalt</span><span class="o">()),</span><span class="k">this</span><span class="o">.</span><span class="na">getName</span><span class="o">());</span>
  <span class="o">}</span>
  <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div><p><img src="/shiro.assets/image-20210607161028627.png" alt="image-20210607161028627"></p>
</li>
</ul>
</li>
</ul>
<h5 id="7再次启动测试发现可以成功放入redis缓存">7.再次启动测试,发现可以成功放入redis缓存</h5>
<p><img src="/shiro.assets/image-20210607161041285.png" alt="image-20210607161041285"></p>
<p><img src="/shiro.assets/image-20210607161049114.png" alt="image-20210607161049114"></p>
<h4 id="694-加入验证码验证">6.9.4 加入验证码验证</h4>
<h5 id="1验证码工具类">1.验证码工具类</h5>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kn">package</span> <span class="nn">com.lut.utils</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">javax.imageio.ImageIO</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.awt.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.awt.geom.AffineTransform</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.awt.image.BufferedImage</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.File</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.FileOutputStream</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.OutputStream</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Arrays</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Random</span><span class="o">;</span>

<span class="cm">/**
</span><span class="cm"> *@创建人  cx
</span><span class="cm"> *@创建时间  2018/11/27 17:36
</span><span class="cm"> *@描述   验证码生成
</span><span class="cm"> */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">VerifyCodeUtils</span><span class="o">{</span>

    <span class="c1">//使用到Algerian字体，系统里没有的话需要安装字体，字体只显示大写，去掉了1,0,i,o几个容易混淆的字符
</span><span class="c1"></span>    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">VERIFY_CODES</span> <span class="o">=</span> <span class="s">&#34;23456789ABCDEFGHJKLMNPQRSTUVWXYZ&#34;</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="n">Random</span> <span class="n">random</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Random</span><span class="o">();</span>


    <span class="cm">/**
</span><span class="cm">     * 使用系统默认字符源生成验证码
</span><span class="cm">     * @param verifySize    验证码长度
</span><span class="cm">     * @return
</span><span class="cm">     */</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="n">String</span> <span class="nf">generateVerifyCode</span><span class="o">(</span><span class="kt">int</span> <span class="n">verifySize</span><span class="o">){</span>
        <span class="k">return</span> <span class="n">generateVerifyCode</span><span class="o">(</span><span class="n">verifySize</span><span class="o">,</span> <span class="n">VERIFY_CODES</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="cm">/**
</span><span class="cm">     * 使用指定源生成验证码
</span><span class="cm">     * @param verifySize    验证码长度
</span><span class="cm">     * @param sources   验证码字符源
</span><span class="cm">     * @return
</span><span class="cm">     */</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="n">String</span> <span class="nf">generateVerifyCode</span><span class="o">(</span><span class="kt">int</span> <span class="n">verifySize</span><span class="o">,</span> <span class="n">String</span> <span class="n">sources</span><span class="o">){</span>
        <span class="k">if</span><span class="o">(</span><span class="n">sources</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">sources</span><span class="o">.</span><span class="na">length</span><span class="o">()</span> <span class="o">==</span> <span class="n">0</span><span class="o">){</span>
            <span class="n">sources</span> <span class="o">=</span> <span class="n">VERIFY_CODES</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="kt">int</span> <span class="n">codesLen</span> <span class="o">=</span> <span class="n">sources</span><span class="o">.</span><span class="na">length</span><span class="o">();</span>
        <span class="n">Random</span> <span class="n">rand</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Random</span><span class="o">(</span><span class="n">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">());</span>
        <span class="n">StringBuilder</span> <span class="n">verifyCode</span> <span class="o">=</span> <span class="k">new</span> <span class="n">StringBuilder</span><span class="o">(</span><span class="n">verifySize</span><span class="o">);</span>
        <span class="k">for</span><span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">verifySize</span><span class="o">;</span> <span class="n">i</span><span class="o">++){</span>
            <span class="n">verifyCode</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">sources</span><span class="o">.</span><span class="na">charAt</span><span class="o">(</span><span class="n">rand</span><span class="o">.</span><span class="na">nextInt</span><span class="o">(</span><span class="n">codesLen</span><span class="o">-</span><span class="n">1</span><span class="o">)));</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">verifyCode</span><span class="o">.</span><span class="na">toString</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="cm">/**
</span><span class="cm">     * 生成随机验证码文件,并返回验证码值
</span><span class="cm">     * @param w
</span><span class="cm">     * @param h
</span><span class="cm">     * @param outputFile
</span><span class="cm">     * @param verifySize
</span><span class="cm">     * @return
</span><span class="cm">     * @throws IOException
</span><span class="cm">     */</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="n">String</span> <span class="nf">outputVerifyImage</span><span class="o">(</span><span class="kt">int</span> <span class="n">w</span><span class="o">,</span> <span class="kt">int</span> <span class="n">h</span><span class="o">,</span> <span class="n">File</span> <span class="n">outputFile</span><span class="o">,</span> <span class="kt">int</span> <span class="n">verifySize</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span><span class="o">{</span>
        <span class="n">String</span> <span class="n">verifyCode</span> <span class="o">=</span> <span class="n">generateVerifyCode</span><span class="o">(</span><span class="n">verifySize</span><span class="o">);</span>
        <span class="n">outputImage</span><span class="o">(</span><span class="n">w</span><span class="o">,</span> <span class="n">h</span><span class="o">,</span> <span class="n">outputFile</span><span class="o">,</span> <span class="n">verifyCode</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">verifyCode</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="cm">/**
</span><span class="cm">     * 输出随机验证码图片流,并返回验证码值
</span><span class="cm">     * @param w
</span><span class="cm">     * @param h
</span><span class="cm">     * @param os
</span><span class="cm">     * @param verifySize
</span><span class="cm">     * @return
</span><span class="cm">     * @throws IOException
</span><span class="cm">     */</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="n">String</span> <span class="nf">outputVerifyImage</span><span class="o">(</span><span class="kt">int</span> <span class="n">w</span><span class="o">,</span> <span class="kt">int</span> <span class="n">h</span><span class="o">,</span> <span class="n">OutputStream</span> <span class="n">os</span><span class="o">,</span> <span class="kt">int</span> <span class="n">verifySize</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span><span class="o">{</span>
        <span class="n">String</span> <span class="n">verifyCode</span> <span class="o">=</span> <span class="n">generateVerifyCode</span><span class="o">(</span><span class="n">verifySize</span><span class="o">);</span>
        <span class="n">outputImage</span><span class="o">(</span><span class="n">w</span><span class="o">,</span> <span class="n">h</span><span class="o">,</span> <span class="n">os</span><span class="o">,</span> <span class="n">verifyCode</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">verifyCode</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="cm">/**
</span><span class="cm">     * 生成指定验证码图像文件
</span><span class="cm">     * @param w
</span><span class="cm">     * @param h
</span><span class="cm">     * @param outputFile
</span><span class="cm">     * @param code
</span><span class="cm">     * @throws IOException
</span><span class="cm">     */</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">outputImage</span><span class="o">(</span><span class="kt">int</span> <span class="n">w</span><span class="o">,</span> <span class="kt">int</span> <span class="n">h</span><span class="o">,</span> <span class="n">File</span> <span class="n">outputFile</span><span class="o">,</span> <span class="n">String</span> <span class="n">code</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span><span class="o">{</span>
        <span class="k">if</span><span class="o">(</span><span class="n">outputFile</span> <span class="o">==</span> <span class="kc">null</span><span class="o">){</span>
            <span class="k">return</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="n">File</span> <span class="n">dir</span> <span class="o">=</span> <span class="n">outputFile</span><span class="o">.</span><span class="na">getParentFile</span><span class="o">();</span>
        <span class="k">if</span><span class="o">(!</span><span class="n">dir</span><span class="o">.</span><span class="na">exists</span><span class="o">()){</span>
            <span class="n">dir</span><span class="o">.</span><span class="na">mkdirs</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="k">try</span><span class="o">{</span>
            <span class="n">outputFile</span><span class="o">.</span><span class="na">createNewFile</span><span class="o">();</span>
            <span class="n">FileOutputStream</span> <span class="n">fos</span> <span class="o">=</span> <span class="k">new</span> <span class="n">FileOutputStream</span><span class="o">(</span><span class="n">outputFile</span><span class="o">);</span>
            <span class="n">outputImage</span><span class="o">(</span><span class="n">w</span><span class="o">,</span> <span class="n">h</span><span class="o">,</span> <span class="n">fos</span><span class="o">,</span> <span class="n">code</span><span class="o">);</span>
            <span class="n">fos</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">catch</span><span class="o">(</span><span class="n">IOException</span> <span class="n">e</span><span class="o">){</span>
            <span class="k">throw</span> <span class="n">e</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="cm">/**
</span><span class="cm">     * 输出指定验证码图片流
</span><span class="cm">     * @param w
</span><span class="cm">     * @param h
</span><span class="cm">     * @param os
</span><span class="cm">     * @param code
</span><span class="cm">     * @throws IOException
</span><span class="cm">     */</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">outputImage</span><span class="o">(</span><span class="kt">int</span> <span class="n">w</span><span class="o">,</span> <span class="kt">int</span> <span class="n">h</span><span class="o">,</span> <span class="n">OutputStream</span> <span class="n">os</span><span class="o">,</span> <span class="n">String</span> <span class="n">code</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span><span class="o">{</span>
        <span class="kt">int</span> <span class="n">verifySize</span> <span class="o">=</span> <span class="n">code</span><span class="o">.</span><span class="na">length</span><span class="o">();</span>
        <span class="n">BufferedImage</span> <span class="n">image</span> <span class="o">=</span> <span class="k">new</span> <span class="n">BufferedImage</span><span class="o">(</span><span class="n">w</span><span class="o">,</span> <span class="n">h</span><span class="o">,</span> <span class="n">BufferedImage</span><span class="o">.</span><span class="na">TYPE_INT_RGB</span><span class="o">);</span>
        <span class="n">Random</span> <span class="n">rand</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Random</span><span class="o">();</span>
        <span class="n">Graphics2D</span> <span class="n">g2</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="na">createGraphics</span><span class="o">();</span>
        <span class="n">g2</span><span class="o">.</span><span class="na">setRenderingHint</span><span class="o">(</span><span class="n">RenderingHints</span><span class="o">.</span><span class="na">KEY_ANTIALIASING</span><span class="o">,</span><span class="n">RenderingHints</span><span class="o">.</span><span class="na">VALUE_ANTIALIAS_ON</span><span class="o">);</span>
        <span class="n">Color</span><span class="o">[]</span> <span class="n">colors</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Color</span><span class="o">[</span><span class="n">5</span><span class="o">];</span>
        <span class="n">Color</span><span class="o">[]</span> <span class="n">colorSpaces</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Color</span><span class="o">[]</span> <span class="o">{</span> <span class="n">Color</span><span class="o">.</span><span class="na">WHITE</span><span class="o">,</span> <span class="n">Color</span><span class="o">.</span><span class="na">CYAN</span><span class="o">,</span>
                <span class="n">Color</span><span class="o">.</span><span class="na">GRAY</span><span class="o">,</span> <span class="n">Color</span><span class="o">.</span><span class="na">LIGHT_GRAY</span><span class="o">,</span> <span class="n">Color</span><span class="o">.</span><span class="na">MAGENTA</span><span class="o">,</span> <span class="n">Color</span><span class="o">.</span><span class="na">ORANGE</span><span class="o">,</span>
                <span class="n">Color</span><span class="o">.</span><span class="na">PINK</span><span class="o">,</span> <span class="n">Color</span><span class="o">.</span><span class="na">YELLOW</span> <span class="o">};</span>
        <span class="kt">float</span><span class="o">[]</span> <span class="n">fractions</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">float</span><span class="o">[</span><span class="n">colors</span><span class="o">.</span><span class="na">length</span><span class="o">];</span>
        <span class="k">for</span><span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">colors</span><span class="o">.</span><span class="na">length</span><span class="o">;</span> <span class="n">i</span><span class="o">++){</span>
            <span class="n">colors</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="n">colorSpaces</span><span class="o">[</span><span class="n">rand</span><span class="o">.</span><span class="na">nextInt</span><span class="o">(</span><span class="n">colorSpaces</span><span class="o">.</span><span class="na">length</span><span class="o">)];</span>
            <span class="n">fractions</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="n">rand</span><span class="o">.</span><span class="na">nextFloat</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="n">Arrays</span><span class="o">.</span><span class="na">sort</span><span class="o">(</span><span class="n">fractions</span><span class="o">);</span>

        <span class="n">g2</span><span class="o">.</span><span class="na">setColor</span><span class="o">(</span><span class="n">Color</span><span class="o">.</span><span class="na">GRAY</span><span class="o">);</span><span class="c1">// 设置边框色
</span><span class="c1"></span>        <span class="n">g2</span><span class="o">.</span><span class="na">fillRect</span><span class="o">(</span><span class="n">0</span><span class="o">,</span> <span class="n">0</span><span class="o">,</span> <span class="n">w</span><span class="o">,</span> <span class="n">h</span><span class="o">);</span>

        <span class="n">Color</span> <span class="n">c</span> <span class="o">=</span> <span class="n">getRandColor</span><span class="o">(</span><span class="n">200</span><span class="o">,</span> <span class="n">250</span><span class="o">);</span>
        <span class="n">g2</span><span class="o">.</span><span class="na">setColor</span><span class="o">(</span><span class="n">c</span><span class="o">);</span><span class="c1">// 设置背景色
</span><span class="c1"></span>        <span class="n">g2</span><span class="o">.</span><span class="na">fillRect</span><span class="o">(</span><span class="n">0</span><span class="o">,</span> <span class="n">2</span><span class="o">,</span> <span class="n">w</span><span class="o">,</span> <span class="n">h</span><span class="o">-</span><span class="n">4</span><span class="o">);</span>

        <span class="c1">//绘制干扰线
</span><span class="c1"></span>        <span class="n">Random</span> <span class="n">random</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Random</span><span class="o">();</span>
        <span class="n">g2</span><span class="o">.</span><span class="na">setColor</span><span class="o">(</span><span class="n">getRandColor</span><span class="o">(</span><span class="n">160</span><span class="o">,</span> <span class="n">200</span><span class="o">));</span><span class="c1">// 设置线条的颜色
</span><span class="c1"></span>        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">20</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="kt">int</span> <span class="n">x</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="na">nextInt</span><span class="o">(</span><span class="n">w</span> <span class="o">-</span> <span class="n">1</span><span class="o">);</span>
            <span class="kt">int</span> <span class="n">y</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="na">nextInt</span><span class="o">(</span><span class="n">h</span> <span class="o">-</span> <span class="n">1</span><span class="o">);</span>
            <span class="kt">int</span> <span class="n">xl</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="na">nextInt</span><span class="o">(</span><span class="n">6</span><span class="o">)</span> <span class="o">+</span> <span class="n">1</span><span class="o">;</span>
            <span class="kt">int</span> <span class="n">yl</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="na">nextInt</span><span class="o">(</span><span class="n">12</span><span class="o">)</span> <span class="o">+</span> <span class="n">1</span><span class="o">;</span>
            <span class="n">g2</span><span class="o">.</span><span class="na">drawLine</span><span class="o">(</span><span class="n">x</span><span class="o">,</span> <span class="n">y</span><span class="o">,</span> <span class="n">x</span> <span class="o">+</span> <span class="n">xl</span> <span class="o">+</span> <span class="n">40</span><span class="o">,</span> <span class="n">y</span> <span class="o">+</span> <span class="n">yl</span> <span class="o">+</span> <span class="n">20</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="c1">// 添加噪点
</span><span class="c1"></span>        <span class="kt">float</span> <span class="n">yawpRate</span> <span class="o">=</span> <span class="n">0</span><span class="o">.</span><span class="na">05f</span><span class="o">;</span><span class="c1">// 噪声率
</span><span class="c1"></span>        <span class="kt">int</span> <span class="n">area</span> <span class="o">=</span> <span class="o">(</span><span class="kt">int</span><span class="o">)</span> <span class="o">(</span><span class="n">yawpRate</span> <span class="o">*</span> <span class="n">w</span> <span class="o">*</span> <span class="n">h</span><span class="o">);</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">area</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="kt">int</span> <span class="n">x</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="na">nextInt</span><span class="o">(</span><span class="n">w</span><span class="o">);</span>
            <span class="kt">int</span> <span class="n">y</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="na">nextInt</span><span class="o">(</span><span class="n">h</span><span class="o">);</span>
            <span class="kt">int</span> <span class="n">rgb</span> <span class="o">=</span> <span class="n">getRandomIntColor</span><span class="o">();</span>
            <span class="n">image</span><span class="o">.</span><span class="na">setRGB</span><span class="o">(</span><span class="n">x</span><span class="o">,</span> <span class="n">y</span><span class="o">,</span> <span class="n">rgb</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="n">shear</span><span class="o">(</span><span class="n">g2</span><span class="o">,</span> <span class="n">w</span><span class="o">,</span> <span class="n">h</span><span class="o">,</span> <span class="n">c</span><span class="o">);</span><span class="c1">// 使图片扭曲
</span><span class="c1"></span>
        <span class="n">g2</span><span class="o">.</span><span class="na">setColor</span><span class="o">(</span><span class="n">getRandColor</span><span class="o">(</span><span class="n">100</span><span class="o">,</span> <span class="n">160</span><span class="o">));</span>
        <span class="kt">int</span> <span class="n">fontSize</span> <span class="o">=</span> <span class="n">h</span><span class="o">-</span><span class="n">4</span><span class="o">;</span>
        <span class="n">Font</span> <span class="n">font</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Font</span><span class="o">(</span><span class="s">&#34;Algerian&#34;</span><span class="o">,</span> <span class="n">Font</span><span class="o">.</span><span class="na">ITALIC</span><span class="o">,</span> <span class="n">fontSize</span><span class="o">);</span>
        <span class="n">g2</span><span class="o">.</span><span class="na">setFont</span><span class="o">(</span><span class="n">font</span><span class="o">);</span>
        <span class="kt">char</span><span class="o">[]</span> <span class="n">chars</span> <span class="o">=</span> <span class="n">code</span><span class="o">.</span><span class="na">toCharArray</span><span class="o">();</span>
        <span class="k">for</span><span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">verifySize</span><span class="o">;</span> <span class="n">i</span><span class="o">++){</span>
            <span class="n">AffineTransform</span> <span class="n">affine</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AffineTransform</span><span class="o">();</span>
            <span class="n">affine</span><span class="o">.</span><span class="na">setToRotation</span><span class="o">(</span><span class="n">Math</span><span class="o">.</span><span class="na">PI</span> <span class="o">/</span> <span class="n">4</span> <span class="o">*</span> <span class="n">rand</span><span class="o">.</span><span class="na">nextDouble</span><span class="o">()</span> <span class="o">*</span> <span class="o">(</span><span class="n">rand</span><span class="o">.</span><span class="na">nextBoolean</span><span class="o">()</span> <span class="o">?</span> <span class="n">1</span> <span class="o">:</span> <span class="o">-</span><span class="n">1</span><span class="o">),</span> <span class="o">(</span><span class="n">w</span> <span class="o">/</span> <span class="n">verifySize</span><span class="o">)</span> <span class="o">*</span> <span class="n">i</span> <span class="o">+</span> <span class="n">fontSize</span><span class="o">/</span><span class="n">2</span><span class="o">,</span> <span class="n">h</span><span class="o">/</span><span class="n">2</span><span class="o">);</span>
            <span class="n">g2</span><span class="o">.</span><span class="na">setTransform</span><span class="o">(</span><span class="n">affine</span><span class="o">);</span>
            <span class="n">g2</span><span class="o">.</span><span class="na">drawChars</span><span class="o">(</span><span class="n">chars</span><span class="o">,</span> <span class="n">i</span><span class="o">,</span> <span class="n">1</span><span class="o">,</span> <span class="o">((</span><span class="n">w</span><span class="o">-</span><span class="n">10</span><span class="o">)</span> <span class="o">/</span> <span class="n">verifySize</span><span class="o">)</span> <span class="o">*</span> <span class="n">i</span> <span class="o">+</span> <span class="n">5</span><span class="o">,</span> <span class="n">h</span><span class="o">/</span><span class="n">2</span> <span class="o">+</span> <span class="n">fontSize</span><span class="o">/</span><span class="n">2</span> <span class="o">-</span> <span class="n">10</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="n">g2</span><span class="o">.</span><span class="na">dispose</span><span class="o">();</span>
        <span class="n">ImageIO</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">image</span><span class="o">,</span> <span class="s">&#34;jpg&#34;</span><span class="o">,</span> <span class="n">os</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="n">Color</span> <span class="nf">getRandColor</span><span class="o">(</span><span class="kt">int</span> <span class="n">fc</span><span class="o">,</span> <span class="kt">int</span> <span class="n">bc</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">fc</span> <span class="o">&gt;</span> <span class="n">255</span><span class="o">)</span>
            <span class="n">fc</span> <span class="o">=</span> <span class="n">255</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">bc</span> <span class="o">&gt;</span> <span class="n">255</span><span class="o">)</span>
            <span class="n">bc</span> <span class="o">=</span> <span class="n">255</span><span class="o">;</span>
        <span class="kt">int</span> <span class="n">r</span> <span class="o">=</span> <span class="n">fc</span> <span class="o">+</span> <span class="n">random</span><span class="o">.</span><span class="na">nextInt</span><span class="o">(</span><span class="n">bc</span> <span class="o">-</span> <span class="n">fc</span><span class="o">);</span>
        <span class="kt">int</span> <span class="n">g</span> <span class="o">=</span> <span class="n">fc</span> <span class="o">+</span> <span class="n">random</span><span class="o">.</span><span class="na">nextInt</span><span class="o">(</span><span class="n">bc</span> <span class="o">-</span> <span class="n">fc</span><span class="o">);</span>
        <span class="kt">int</span> <span class="n">b</span> <span class="o">=</span> <span class="n">fc</span> <span class="o">+</span> <span class="n">random</span><span class="o">.</span><span class="na">nextInt</span><span class="o">(</span><span class="n">bc</span> <span class="o">-</span> <span class="n">fc</span><span class="o">);</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">Color</span><span class="o">(</span><span class="n">r</span><span class="o">,</span> <span class="n">g</span><span class="o">,</span> <span class="n">b</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kt">int</span> <span class="nf">getRandomIntColor</span><span class="o">()</span> <span class="o">{</span>
        <span class="kt">int</span><span class="o">[]</span> <span class="n">rgb</span> <span class="o">=</span> <span class="n">getRandomRgb</span><span class="o">();</span>
        <span class="kt">int</span> <span class="n">color</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">c</span> <span class="o">:</span> <span class="n">rgb</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">color</span> <span class="o">=</span> <span class="n">color</span> <span class="o">&lt;&lt;</span> <span class="n">8</span><span class="o">;</span>
            <span class="n">color</span> <span class="o">=</span> <span class="n">color</span> <span class="o">|</span> <span class="n">c</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">color</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kt">int</span><span class="o">[]</span> <span class="nf">getRandomRgb</span><span class="o">()</span> <span class="o">{</span>
        <span class="kt">int</span><span class="o">[]</span> <span class="n">rgb</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">int</span><span class="o">[</span><span class="n">3</span><span class="o">];</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">3</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="n">rgb</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="na">nextInt</span><span class="o">(</span><span class="n">255</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">rgb</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">shear</span><span class="o">(</span><span class="n">Graphics</span> <span class="n">g</span><span class="o">,</span> <span class="kt">int</span> <span class="n">w1</span><span class="o">,</span> <span class="kt">int</span> <span class="n">h1</span><span class="o">,</span> <span class="n">Color</span> <span class="n">color</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">shearX</span><span class="o">(</span><span class="n">g</span><span class="o">,</span> <span class="n">w1</span><span class="o">,</span> <span class="n">h1</span><span class="o">,</span> <span class="n">color</span><span class="o">);</span>
        <span class="n">shearY</span><span class="o">(</span><span class="n">g</span><span class="o">,</span> <span class="n">w1</span><span class="o">,</span> <span class="n">h1</span><span class="o">,</span> <span class="n">color</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">shearX</span><span class="o">(</span><span class="n">Graphics</span> <span class="n">g</span><span class="o">,</span> <span class="kt">int</span> <span class="n">w1</span><span class="o">,</span> <span class="kt">int</span> <span class="n">h1</span><span class="o">,</span> <span class="n">Color</span> <span class="n">color</span><span class="o">)</span> <span class="o">{</span>

        <span class="kt">int</span> <span class="n">period</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="na">nextInt</span><span class="o">(</span><span class="n">2</span><span class="o">);</span>

        <span class="kt">boolean</span> <span class="n">borderGap</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
        <span class="kt">int</span> <span class="n">frames</span> <span class="o">=</span> <span class="n">1</span><span class="o">;</span>
        <span class="kt">int</span> <span class="n">phase</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="na">nextInt</span><span class="o">(</span><span class="n">2</span><span class="o">);</span>

        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">h1</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="kt">double</span> <span class="n">d</span> <span class="o">=</span> <span class="o">(</span><span class="kt">double</span><span class="o">)</span> <span class="o">(</span><span class="n">period</span> <span class="o">&gt;&gt;</span> <span class="n">1</span><span class="o">)</span>
                    <span class="o">*</span> <span class="n">Math</span><span class="o">.</span><span class="na">sin</span><span class="o">((</span><span class="kt">double</span><span class="o">)</span> <span class="n">i</span> <span class="o">/</span> <span class="o">(</span><span class="kt">double</span><span class="o">)</span> <span class="n">period</span>
                    <span class="o">+</span> <span class="o">(</span><span class="n">6</span><span class="o">.</span><span class="na">2831853071795862D</span> <span class="o">*</span> <span class="o">(</span><span class="kt">double</span><span class="o">)</span> <span class="n">phase</span><span class="o">)</span>
                    <span class="o">/</span> <span class="o">(</span><span class="kt">double</span><span class="o">)</span> <span class="n">frames</span><span class="o">);</span>
            <span class="n">g</span><span class="o">.</span><span class="na">copyArea</span><span class="o">(</span><span class="n">0</span><span class="o">,</span> <span class="n">i</span><span class="o">,</span> <span class="n">w1</span><span class="o">,</span> <span class="n">1</span><span class="o">,</span> <span class="o">(</span><span class="kt">int</span><span class="o">)</span> <span class="n">d</span><span class="o">,</span> <span class="n">0</span><span class="o">);</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">borderGap</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">g</span><span class="o">.</span><span class="na">setColor</span><span class="o">(</span><span class="n">color</span><span class="o">);</span>
                <span class="n">g</span><span class="o">.</span><span class="na">drawLine</span><span class="o">((</span><span class="kt">int</span><span class="o">)</span> <span class="n">d</span><span class="o">,</span> <span class="n">i</span><span class="o">,</span> <span class="n">0</span><span class="o">,</span> <span class="n">i</span><span class="o">);</span>
                <span class="n">g</span><span class="o">.</span><span class="na">drawLine</span><span class="o">((</span><span class="kt">int</span><span class="o">)</span> <span class="n">d</span> <span class="o">+</span> <span class="n">w1</span><span class="o">,</span> <span class="n">i</span><span class="o">,</span> <span class="n">w1</span><span class="o">,</span> <span class="n">i</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>

    <span class="o">}</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">shearY</span><span class="o">(</span><span class="n">Graphics</span> <span class="n">g</span><span class="o">,</span> <span class="kt">int</span> <span class="n">w1</span><span class="o">,</span> <span class="kt">int</span> <span class="n">h1</span><span class="o">,</span> <span class="n">Color</span> <span class="n">color</span><span class="o">)</span> <span class="o">{</span>

        <span class="kt">int</span> <span class="n">period</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="na">nextInt</span><span class="o">(</span><span class="n">40</span><span class="o">)</span> <span class="o">+</span> <span class="n">10</span><span class="o">;</span> <span class="c1">// 50;
</span><span class="c1"></span>
        <span class="kt">boolean</span> <span class="n">borderGap</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
        <span class="kt">int</span> <span class="n">frames</span> <span class="o">=</span> <span class="n">20</span><span class="o">;</span>
        <span class="kt">int</span> <span class="n">phase</span> <span class="o">=</span> <span class="n">7</span><span class="o">;</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">w1</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="kt">double</span> <span class="n">d</span> <span class="o">=</span> <span class="o">(</span><span class="kt">double</span><span class="o">)</span> <span class="o">(</span><span class="n">period</span> <span class="o">&gt;&gt;</span> <span class="n">1</span><span class="o">)</span>
                    <span class="o">*</span> <span class="n">Math</span><span class="o">.</span><span class="na">sin</span><span class="o">((</span><span class="kt">double</span><span class="o">)</span> <span class="n">i</span> <span class="o">/</span> <span class="o">(</span><span class="kt">double</span><span class="o">)</span> <span class="n">period</span>
                    <span class="o">+</span> <span class="o">(</span><span class="n">6</span><span class="o">.</span><span class="na">2831853071795862D</span> <span class="o">*</span> <span class="o">(</span><span class="kt">double</span><span class="o">)</span> <span class="n">phase</span><span class="o">)</span>
                    <span class="o">/</span> <span class="o">(</span><span class="kt">double</span><span class="o">)</span> <span class="n">frames</span><span class="o">);</span>
            <span class="n">g</span><span class="o">.</span><span class="na">copyArea</span><span class="o">(</span><span class="n">i</span><span class="o">,</span> <span class="n">0</span><span class="o">,</span> <span class="n">1</span><span class="o">,</span> <span class="n">h1</span><span class="o">,</span> <span class="n">0</span><span class="o">,</span> <span class="o">(</span><span class="kt">int</span><span class="o">)</span> <span class="n">d</span><span class="o">);</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">borderGap</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">g</span><span class="o">.</span><span class="na">setColor</span><span class="o">(</span><span class="n">color</span><span class="o">);</span>
                <span class="n">g</span><span class="o">.</span><span class="na">drawLine</span><span class="o">(</span><span class="n">i</span><span class="o">,</span> <span class="o">(</span><span class="kt">int</span><span class="o">)</span> <span class="n">d</span><span class="o">,</span> <span class="n">i</span><span class="o">,</span> <span class="n">0</span><span class="o">);</span>
                <span class="n">g</span><span class="o">.</span><span class="na">drawLine</span><span class="o">(</span><span class="n">i</span><span class="o">,</span> <span class="o">(</span><span class="kt">int</span><span class="o">)</span> <span class="n">d</span> <span class="o">+</span> <span class="n">h1</span><span class="o">,</span> <span class="n">i</span><span class="o">,</span> <span class="n">h1</span><span class="o">);</span>
            <span class="o">}</span>

        <span class="o">}</span>

    <span class="o">}</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
        <span class="c1">//获取验证码
</span><span class="c1"></span>        <span class="n">String</span> <span class="n">s</span> <span class="o">=</span> <span class="n">generateVerifyCode</span><span class="o">(</span><span class="n">4</span><span class="o">);</span>
        <span class="c1">//将验证码放入图片中
</span><span class="c1"></span>        <span class="n">outputImage</span><span class="o">(</span><span class="n">260</span><span class="o">,</span><span class="n">60</span><span class="o">,</span><span class="k">new</span> <span class="n">File</span><span class="o">(</span><span class="s">&#34;/Users/chenyannan/Desktop/安工资料/aa.jpg&#34;</span><span class="o">),</span><span class="n">s</span><span class="o">);</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">s</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div><h5 id="2开发页面加入验证码">2.开发页面加入验证码</h5>
<pre><code class="language-jsp" data-lang="jsp">&lt;form action=&quot;${pageContext.request.contextPath}/user/login&quot; method=&quot;post&quot;&gt;
    用户名:&lt;input type=&quot;text&quot; name=&quot;username&quot; &gt; &lt;br/&gt;
    密码  : &lt;input type=&quot;text&quot; name=&quot;password&quot;&gt; &lt;br&gt;
    请输入验证码: &lt;input type=&quot;text&quot; name=&quot;code&quot;&gt;&lt;img src=&quot;${pageContext.request.contextPath}/user/getImage&quot; alt=&quot;&quot;&gt;&lt;br&gt;
    &lt;input type=&quot;submit&quot; value=&quot;登录&quot;&gt;
&lt;/form&gt;
</code></pre><h5 id="3开发控制器">3.开发控制器</h5>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">&#34;getImage&#34;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">getImage</span><span class="o">(</span><span class="n">HttpSession</span> <span class="n">session</span><span class="o">,</span> <span class="n">HttpServletResponse</span> <span class="n">response</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
  <span class="c1">//生成验证码
</span><span class="c1"></span>  <span class="n">String</span> <span class="n">code</span> <span class="o">=</span> <span class="n">VerifyCodeUtils</span><span class="o">.</span><span class="na">generateVerifyCode</span><span class="o">(</span><span class="n">4</span><span class="o">);</span>
  <span class="c1">//验证码放入session
</span><span class="c1"></span>  <span class="n">session</span><span class="o">.</span><span class="na">setAttribute</span><span class="o">(</span><span class="s">&#34;code&#34;</span><span class="o">,</span><span class="n">code</span><span class="o">);</span>
  <span class="c1">//验证码存入图片
</span><span class="c1"></span>  <span class="n">ServletOutputStream</span> <span class="n">os</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="na">getOutputStream</span><span class="o">();</span>
  <span class="n">response</span><span class="o">.</span><span class="na">setContentType</span><span class="o">(</span><span class="s">&#34;image/png&#34;</span><span class="o">);</span>
  <span class="n">VerifyCodeUtils</span><span class="o">.</span><span class="na">outputImage</span><span class="o">(</span><span class="n">220</span><span class="o">,</span><span class="n">60</span><span class="o">,</span><span class="n">os</span><span class="o">,</span><span class="n">code</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div><h5 id="4放行验证码">4.放行验证码</h5>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="n">map</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&#34;/user/getImage&#34;</span><span class="o">,</span><span class="s">&#34;anon&#34;</span><span class="o">);</span><span class="c1">//验证码
</span></code></pre></div><p><img src="/shiro.assets/image-20210607161210855.png" alt="image-20210607161210855"></p>
<h5 id="5修改认证流程">5.修改认证流程</h5>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">&#34;login&#34;</span><span class="o">)</span>
<span class="kd">public</span> <span class="n">String</span> <span class="nf">login</span><span class="o">(</span><span class="n">String</span> <span class="n">username</span><span class="o">,</span> <span class="n">String</span> <span class="n">password</span><span class="o">,</span><span class="n">String</span> <span class="n">code</span><span class="o">,</span><span class="n">HttpSession</span> <span class="n">session</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">//比较验证码
</span><span class="c1"></span>    <span class="n">String</span> <span class="n">codes</span> <span class="o">=</span> <span class="o">(</span><span class="n">String</span><span class="o">)</span> <span class="n">session</span><span class="o">.</span><span class="na">getAttribute</span><span class="o">(</span><span class="s">&#34;code&#34;</span><span class="o">);</span>
    <span class="k">try</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">codes</span><span class="o">.</span><span class="na">equalsIgnoreCase</span><span class="o">(</span><span class="n">code</span><span class="o">)){</span>
            <span class="c1">//获取主体对象
</span><span class="c1"></span>            <span class="n">Subject</span> <span class="n">subject</span> <span class="o">=</span> <span class="n">SecurityUtils</span><span class="o">.</span><span class="na">getSubject</span><span class="o">();</span>
            <span class="n">subject</span><span class="o">.</span><span class="na">login</span><span class="o">(</span><span class="k">new</span> <span class="n">UsernamePasswordToken</span><span class="o">(</span><span class="n">username</span><span class="o">,</span> <span class="n">password</span><span class="o">));</span>
            <span class="k">return</span> <span class="s">&#34;redirect:/index.jsp&#34;</span><span class="o">;</span>
        <span class="o">}</span><span class="k">else</span><span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">RuntimeException</span><span class="o">(</span><span class="s">&#34;验证码错误!&#34;</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">UnknownAccountException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;用户名错误!&#34;</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IncorrectCredentialsException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;密码错误!&#34;</span><span class="o">);</span>
    <span class="o">}</span><span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">){</span>
        <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">getMessage</span><span class="o">());</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="s">&#34;redirect:/login.jsp&#34;</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div><h5 id="6修改salt不能序列化的问题">6.修改salt不能序列化的问题</h5>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="c1">//自定义salt实现  实现序列化接口
</span><span class="c1"></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MyByteSource</span> <span class="kd">implements</span> <span class="n">ByteSource</span><span class="o">,</span><span class="n">Serializable</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kt">byte</span><span class="o">[]</span> <span class="n">bytes</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">cachedHex</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">cachedBase64</span><span class="o">;</span>

    <span class="c1">//加入无参数构造方法实现序列化和反序列化
</span><span class="c1"></span>    <span class="kd">public</span> <span class="nf">MyByteSource</span><span class="o">(){</span>

    <span class="o">}</span>

    <span class="kd">public</span> <span class="nf">MyByteSource</span><span class="o">(</span><span class="kt">byte</span><span class="o">[]</span> <span class="n">bytes</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">bytes</span> <span class="o">=</span> <span class="n">bytes</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="nf">MyByteSource</span><span class="o">(</span><span class="kt">char</span><span class="o">[]</span> <span class="n">chars</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">bytes</span> <span class="o">=</span> <span class="n">CodecSupport</span><span class="o">.</span><span class="na">toBytes</span><span class="o">(</span><span class="n">chars</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="nf">MyByteSource</span><span class="o">(</span><span class="n">String</span> <span class="n">string</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">bytes</span> <span class="o">=</span> <span class="n">CodecSupport</span><span class="o">.</span><span class="na">toBytes</span><span class="o">(</span><span class="n">string</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="nf">MyByteSource</span><span class="o">(</span><span class="n">ByteSource</span> <span class="n">source</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">bytes</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="na">getBytes</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="nf">MyByteSource</span><span class="o">(</span><span class="n">File</span> <span class="n">file</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">bytes</span> <span class="o">=</span> <span class="o">(</span><span class="k">new</span> <span class="n">MyByteSource</span><span class="o">.</span><span class="na">BytesHelper</span><span class="o">()).</span><span class="na">getBytes</span><span class="o">(</span><span class="n">file</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="nf">MyByteSource</span><span class="o">(</span><span class="n">InputStream</span> <span class="n">stream</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">bytes</span> <span class="o">=</span> <span class="o">(</span><span class="k">new</span> <span class="n">MyByteSource</span><span class="o">.</span><span class="na">BytesHelper</span><span class="o">()).</span><span class="na">getBytes</span><span class="o">(</span><span class="n">stream</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">boolean</span> <span class="nf">isCompatible</span><span class="o">(</span><span class="n">Object</span> <span class="n">o</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">o</span> <span class="k">instanceof</span> <span class="kt">byte</span><span class="o">[]</span> <span class="o">||</span> <span class="n">o</span> <span class="k">instanceof</span> <span class="kt">char</span><span class="o">[]</span> <span class="o">||</span> <span class="n">o</span> <span class="k">instanceof</span> <span class="n">String</span> <span class="o">||</span> <span class="n">o</span> <span class="k">instanceof</span> <span class="n">ByteSource</span> <span class="o">||</span> <span class="n">o</span> <span class="k">instanceof</span> <span class="n">File</span> <span class="o">||</span> <span class="n">o</span> <span class="k">instanceof</span> <span class="n">InputStream</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">byte</span><span class="o">[]</span> <span class="nf">getBytes</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">bytes</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isEmpty</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">bytes</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="k">this</span><span class="o">.</span><span class="na">bytes</span><span class="o">.</span><span class="na">length</span> <span class="o">==</span> <span class="n">0</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="n">String</span> <span class="nf">toHex</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">cachedHex</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">cachedHex</span> <span class="o">=</span> <span class="n">Hex</span><span class="o">.</span><span class="na">encodeToString</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">getBytes</span><span class="o">());</span>
        <span class="o">}</span>

        <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">cachedHex</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="n">String</span> <span class="nf">toBase64</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">cachedBase64</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">cachedBase64</span> <span class="o">=</span> <span class="n">Base64</span><span class="o">.</span><span class="na">encodeToString</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">getBytes</span><span class="o">());</span>
        <span class="o">}</span>

        <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">cachedBase64</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="n">String</span> <span class="nf">toString</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">toBase64</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">hashCode</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">bytes</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="o">.</span><span class="na">bytes</span><span class="o">.</span><span class="na">length</span> <span class="o">!=</span> <span class="n">0</span> <span class="o">?</span> <span class="n">Arrays</span><span class="o">.</span><span class="na">hashCode</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">bytes</span><span class="o">)</span> <span class="o">:</span> <span class="n">0</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">equals</span><span class="o">(</span><span class="n">Object</span> <span class="n">o</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">o</span> <span class="o">==</span> <span class="k">this</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">o</span> <span class="k">instanceof</span> <span class="n">ByteSource</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">ByteSource</span> <span class="n">bs</span> <span class="o">=</span> <span class="o">(</span><span class="n">ByteSource</span><span class="o">)</span><span class="n">o</span><span class="o">;</span>
            <span class="k">return</span> <span class="n">Arrays</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">getBytes</span><span class="o">(),</span> <span class="n">bs</span><span class="o">.</span><span class="na">getBytes</span><span class="o">());</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">BytesHelper</span> <span class="kd">extends</span> <span class="n">CodecSupport</span> <span class="o">{</span>
        <span class="kd">private</span> <span class="nf">BytesHelper</span><span class="o">()</span> <span class="o">{</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="kt">byte</span><span class="o">[]</span> <span class="nf">getBytes</span><span class="o">(</span><span class="n">File</span> <span class="n">file</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">toBytes</span><span class="o">(</span><span class="n">file</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="kt">byte</span><span class="o">[]</span> <span class="nf">getBytes</span><span class="o">(</span><span class="n">InputStream</span> <span class="n">stream</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">toBytes</span><span class="o">(</span><span class="n">stream</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div><h5 id="7启动测试">7.启动测试</h5>
<p><img src="/shiro.assets/image-20210607161304312.png" alt="image-20210607161304312"></p>
<h4 id="695-jsp中shiro常用标签">6.9.5 JSP中Shiro常用标签</h4>
<p>此模块参考：https://www.cnblogs.com/fancongcong/p/8093258.html</p>
<pre><code class="language-jsp" data-lang="jsp">&lt;shiro:guest&gt;
    游客访问 &lt;a href = &quot;login.jsp&quot;&gt;&lt;/a&gt;
&lt;/shiro:guest&gt;
 
user 标签：用户已经通过认证\记住我 登录后显示响应的内容
&lt;shiro:user&gt;
    欢迎[&lt;shiro:principal/&gt;]登录 &lt;a href = &quot;logout&quot;&gt;退出&lt;/a&gt;
&lt;/shiro:user&gt;
 
authenticated标签：用户身份验证通过，即 Subjec.login 登录成功 不是记住我登录的
&lt;shiro:authenticted&gt;
    用户[&lt;shiro:principal/&gt;] 已身份验证通过
&lt;/shiro:authenticted&gt;
 
notAuthenticated标签：用户未进行身份验证，即没有调用Subject.login进行登录,包括&quot;记住我&quot;也属于未进行身份验证
&lt;shiro:notAuthenticated&gt;
    未身份验证(包括&quot;记住我&quot;)
&lt;/shiro:notAuthenticated&gt;
 
 
principal 标签：显示用户身份信息，默认调用
Subjec.getPrincipal()获取，即Primary Principal
&lt;shiro:principal property = &quot;username&quot;/&gt;
 
hasRole标签：如果当前Subject有角色将显示body体内的内容
&lt;shiro:hashRole name = &quot;admin&quot;&gt;
    用户[&lt;shiro:principal/&gt;]拥有角色admin
&lt;/shiro:hashRole&gt;
 
hasAnyRoles标签：如果Subject有任意一个角色(或的关系)将显示body体里的内容
&lt;shiro:hasAnyRoles name = &quot;admin,user&quot;&gt;
    用户[&lt;shiro:pricipal/&gt;]拥有角色admin 或者 user
&lt;/shiro:hasAnyRoles&gt;
 
lacksRole:如果当前 Subjec没有角色将显示body体内的内容
&lt;shiro:lacksRole name = &quot;admin&quot;&gt;
    用户[&lt;shiro:pricipal/&gt;]没有角色admin
&lt;/shiro:lacksRole&gt;
 
hashPermission:如果当前Subject有权限将显示body体内容
&lt;shiro:hashPermission name = &quot;user:create&quot;&gt;
    用户[&lt;shiro:pricipal/&gt;] 拥有权限user:create
&lt;/shiro:hashPermission&gt;
 
lacksPermission:如果当前Subject没有权限将显示body体内容
&lt;shiro:lacksPermission name = &quot;org:create&quot;&gt;
    用户[&lt;shiro:pricipal/&gt;] 没有权限org:create
&lt;/shiro:lacksPermission&gt;
</code></pre><h2 id="七shiro整合springboot之thymeleaf权限控制">七、Shiro整合springboot之thymeleaf权限控制</h2>
<h3 id="1引入扩展依赖">1.引入扩展依赖</h3>
<div class="highlight"><pre class="chroma"><code class="language-xml" data-lang="xml"><span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>com.github.theborakompanioni<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>thymeleaf-extras-shiro<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;version&gt;</span>2.0.0<span class="nt">&lt;/version&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</code></pre></div><h3 id="2页面中引入命名空间">2.页面中引入命名空间</h3>
<p>xmlns:shiro=“http://www.pollix.at/thymeleaf/shiro”</p>
<pre><code>&lt;html xmlns=&quot;http://www.w3.org/1999/xhtml&quot; xmlns:th=&quot;http://www.thymeleaf.org&quot;
      xmlns:shiro=&quot;http://www.pollix.at/thymeleaf/shiro&quot;&gt;
......
</code></pre><h3 id="3常见权限控制标签使用">3.常见权限控制标签使用</h3>
<pre><code class="language-jsp" data-lang="jsp">&lt;!-- 验证当前用户是否为“访客”，即未认证（包含未记住）的用户。 --&gt;
&lt;p shiro:guest=&quot;&quot;&gt;Please &lt;a href=&quot;login.html&quot;&gt;login&lt;/a&gt;&lt;/p&gt;


&lt;!-- 认证通过或已记住的用户。 --&gt;
&lt;p shiro:user=&quot;&quot;&gt;
    Welcome back John! Not John? Click &lt;a href=&quot;login.html&quot;&gt;here&lt;/a&gt; to login.
&lt;/p&gt;

&lt;!-- 已认证通过的用户。不包含已记住的用户，这是与user标签的区别所在。 --&gt;
&lt;p shiro:authenticated=&quot;&quot;&gt;
    Hello, &lt;span shiro:principal=&quot;&quot;&gt;&lt;/span&gt;, how are you today?
&lt;/p&gt;
&lt;a shiro:authenticated=&quot;&quot; href=&quot;updateAccount.html&quot;&gt;Update your contact information&lt;/a&gt;

&lt;!-- 输出当前用户信息，通常为登录帐号信息。 --&gt;
&lt;p&gt;Hello, &lt;shiro:principal/&gt;, how are you today?&lt;/p&gt;


&lt;!-- 未认证通过用户，与authenticated标签相对应。与guest标签的区别是，该标签包含已记住用户。 --&gt;
&lt;p shiro:notAuthenticated=&quot;&quot;&gt;
    Please &lt;a href=&quot;login.html&quot;&gt;login&lt;/a&gt; in order to update your credit card information.
&lt;/p&gt;

&lt;!-- 验证当前用户是否属于该角色。 --&gt;
&lt;a shiro:hasRole=&quot;admin&quot; href=&quot;admin.html&quot;&gt;Administer the system&lt;/a&gt;&lt;!-- 拥有该角色 --&gt;

&lt;!-- 与hasRole标签逻辑相反，当用户不属于该角色时验证通过。 --&gt;
&lt;p shiro:lacksRole=&quot;developer&quot;&gt;&lt;!-- 没有该角色 --&gt;
    Sorry, you are not allowed to developer the system.
&lt;/p&gt;

&lt;!-- 验证当前用户是否属于以下所有角色。 --&gt;
&lt;p shiro:hasAllRoles=&quot;developer, 2&quot;&gt;&lt;!-- 角色与判断 --&gt;
    You are a developer and a admin.
&lt;/p&gt;

&lt;!-- 验证当前用户是否属于以下任意一个角色。  --&gt;
&lt;p shiro:hasAnyRoles=&quot;admin, vip, developer,1&quot;&gt;&lt;!-- 角色或判断 --&gt;
    You are a admin, vip, or developer.
&lt;/p&gt;

&lt;!--验证当前用户是否拥有指定权限。  --&gt;
&lt;a shiro:hasPermission=&quot;userInfo:add&quot; href=&quot;createUser.html&quot;&gt;添加用户&lt;/a&gt;&lt;!-- 拥有权限 --&gt;

&lt;!-- 与hasPermission标签逻辑相反，当前用户没有制定权限时，验证通过。 --&gt;
&lt;p shiro:lacksPermission=&quot;userInfo:del&quot;&gt;&lt;!-- 没有权限 --&gt;
    Sorry, you are not allowed to delete user accounts.
&lt;/p&gt;

&lt;!-- 验证当前用户是否拥有以下所有角色。 --&gt;
&lt;p shiro:hasAllPermissions=&quot;userInfo:view, userInfo:add&quot;&gt;&lt;!-- 权限与判断 --&gt;
    You can see or add users.
&lt;/p&gt;

&lt;!-- 验证当前用户是否拥有以下任意一个权限。  --&gt;
&lt;p shiro:hasAnyPermissions=&quot;userInfo:view, userInfo:del&quot;&gt;&lt;!-- 权限或判断 --&gt;
    You can see or delete users.
&lt;/p&gt;
&lt;a shiro:hasPermission=&quot;pp&quot; href=&quot;createUser.html&quot;&gt;Create a new User&lt;/a&gt;

</code></pre><h3 id="4加入shiro的方言配置">4.加入shiro的方言配置</h3>
<p><strong>页面标签不起作用一定要记住加入方言处理</strong></p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="nd">@Bean</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">&#34;shiroDialect&#34;</span><span class="o">)</span>
<span class="kd">public</span> <span class="n">ShiroDialect</span> <span class="nf">shiroDialect</span><span class="o">(){</span>
  <span class="k">return</span> <span class="k">new</span> <span class="n">ShiroDialect</span><span class="o">();</span>
<span class="o">}</span>
</code></pre></div><p><img src="/shiro.assets/image-20210607161520606.png" alt="image-20210607161520606"></p>
<h2 id="八springboot应用整合shiro案例jdbcrealm">八、SpringBoot应用整合Shiro—案例（JdbcRealm）</h2>
<h3 id="81-jdbcrealm介绍">8.1 JdbcRealm介绍</h3>
<p><img src="/shiro.assets/image-20210607223227710.png" alt="image-20210607223227710"></p>
<p><strong>如果使用JdbcRealm，则必须提供JdbcRealm所需的表结构(权限设计)：</strong></p>
<p><img src="/shiro.assets/image-20210607223250248.png" alt="image-20210607223250248"></p>
<h3 id="82-jdbcrealm规定的表结构">8.2 JdbcRealm规定的表结构</h3>
<ul>
<li>
<p>用户信息表： users</p>
<div class="highlight"><pre class="chroma"><code class="language-sql" data-lang="sql"><span class="k">create</span> <span class="k">table</span> <span class="n">users</span><span class="p">(</span>
    <span class="n">id</span> <span class="nb">int</span> <span class="k">primary</span> <span class="k">key</span> <span class="n">auto_increment</span><span class="p">,</span>
    <span class="n">username</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">60</span><span class="p">)</span> <span class="k">not</span> <span class="k">null</span> <span class="k">unique</span><span class="p">,</span>
    <span class="n">password</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span> <span class="k">not</span> <span class="k">null</span><span class="p">,</span>
    <span class="n">password_salt</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>
<span class="p">);</span>
  
<span class="k">insert</span> <span class="k">into</span> <span class="n">users</span><span class="p">(</span><span class="n">username</span><span class="p">,</span><span class="n">password</span><span class="p">)</span> <span class="k">values</span><span class="p">(</span><span class="s1">&#39;zhangsan&#39;</span><span class="p">,</span><span class="s1">&#39;123456&#39;</span><span class="p">);</span>
<span class="k">insert</span> <span class="k">into</span> <span class="n">users</span><span class="p">(</span><span class="n">username</span><span class="p">,</span><span class="n">password</span><span class="p">)</span> <span class="k">values</span><span class="p">(</span><span class="s1">&#39;lisi&#39;</span><span class="p">,</span><span class="s1">&#39;123456&#39;</span><span class="p">);</span>
<span class="k">insert</span> <span class="k">into</span> <span class="n">users</span><span class="p">(</span><span class="n">username</span><span class="p">,</span><span class="n">password</span><span class="p">)</span> <span class="k">values</span><span class="p">(</span><span class="s1">&#39;wangwu&#39;</span><span class="p">,</span><span class="s1">&#39;123456&#39;</span><span class="p">);</span>
<span class="k">insert</span> <span class="k">into</span> <span class="n">users</span><span class="p">(</span><span class="n">username</span><span class="p">,</span><span class="n">password</span><span class="p">)</span> <span class="k">values</span><span class="p">(</span><span class="s1">&#39;zhaoliu&#39;</span><span class="p">,</span><span class="s1">&#39;123456&#39;</span><span class="p">);</span>
<span class="k">insert</span> <span class="k">into</span> <span class="n">users</span><span class="p">(</span><span class="n">username</span><span class="p">,</span><span class="n">password</span><span class="p">)</span> <span class="k">values</span><span class="p">(</span><span class="s1">&#39;chenqi&#39;</span><span class="p">,</span><span class="s1">&#39;123456&#39;</span><span class="p">);</span>
</code></pre></div></li>
<li>
<p>角色信息表： user_roles</p>
<div class="highlight"><pre class="chroma"><code class="language-sql" data-lang="sql"><span class="k">create</span> <span class="k">table</span> <span class="n">user_roles</span><span class="p">(</span>
  <span class="n">id</span> <span class="nb">int</span> <span class="k">primary</span> <span class="k">key</span> <span class="n">auto_increment</span><span class="p">,</span>
    <span class="n">username</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">60</span><span class="p">)</span> <span class="k">not</span> <span class="k">null</span><span class="p">,</span>
    <span class="n">role_name</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span> <span class="k">not</span> <span class="k">null</span>
<span class="p">);</span>
  
<span class="c1">-- admin系统管理员
</span><span class="c1">-- cmanager 库管人员
</span><span class="c1">-- xmanager 销售人员
</span><span class="c1">-- kmanager 客服人员
</span><span class="c1">-- zmanager 行政人员 
</span><span class="c1"></span><span class="k">insert</span> <span class="k">into</span> <span class="n">user_roles</span><span class="p">(</span><span class="n">username</span><span class="p">,</span><span class="n">role_name</span><span class="p">)</span> <span class="k">values</span><span class="p">(</span><span class="s1">&#39;zhangsan&#39;</span><span class="p">,</span><span class="s1">&#39;admin&#39;</span><span class="p">);</span>
<span class="k">insert</span> <span class="k">into</span> <span class="n">user_roles</span><span class="p">(</span><span class="n">username</span><span class="p">,</span><span class="n">role_name</span><span class="p">)</span> <span class="k">values</span><span class="p">(</span><span class="s1">&#39;lisi&#39;</span><span class="p">,</span><span class="s1">&#39;cmanager&#39;</span><span class="p">);</span>
<span class="k">insert</span> <span class="k">into</span> <span class="n">user_roles</span><span class="p">(</span><span class="n">username</span><span class="p">,</span><span class="n">role_name</span><span class="p">)</span> <span class="k">values</span><span class="p">(</span><span class="s1">&#39;wangwu&#39;</span><span class="p">,</span><span class="s1">&#39;xmanager&#39;</span><span class="p">);</span>
<span class="k">insert</span> <span class="k">into</span> <span class="n">user_roles</span><span class="p">(</span><span class="n">username</span><span class="p">,</span><span class="n">role_name</span><span class="p">)</span> <span class="k">values</span><span class="p">(</span><span class="s1">&#39;zhaoliu&#39;</span><span class="p">,</span><span class="s1">&#39;kmanager&#39;</span><span class="p">);</span>
<span class="k">insert</span> <span class="k">into</span> <span class="n">user_roles</span><span class="p">(</span><span class="n">username</span><span class="p">,</span><span class="n">role_name</span><span class="p">)</span> <span class="k">values</span><span class="p">(</span><span class="s1">&#39;chenqi&#39;</span><span class="p">,</span><span class="s1">&#39;zmanager&#39;</span><span class="p">);</span>
  
</code></pre></div></li>
<li>
<p>权限信息表：roles_permissions</p>
<div class="highlight"><pre class="chroma"><code class="language-sql" data-lang="sql"><span class="k">create</span> <span class="k">table</span> <span class="n">roles_permissions</span><span class="p">(</span>
  <span class="n">id</span> <span class="nb">int</span> <span class="k">primary</span> <span class="k">key</span> <span class="n">auto_increment</span><span class="p">,</span>
    <span class="n">role_name</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span> <span class="k">not</span> <span class="k">null</span><span class="p">,</span>
    <span class="n">permission</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span> <span class="k">not</span> <span class="k">null</span>
<span class="p">);</span>
  
<span class="c1">-- 权限  sys:c:save   sys:c:delete...
</span><span class="c1">-- 管理员具备所有权限
</span><span class="c1"></span><span class="k">insert</span> <span class="k">into</span> <span class="n">roles_permissions</span><span class="p">(</span><span class="n">role_name</span><span class="p">,</span><span class="n">permission</span><span class="p">)</span> <span class="k">values</span><span class="p">(</span><span class="s2">&#34;admin&#34;</span><span class="p">,</span><span class="s2">&#34;*&#34;</span><span class="p">);</span>
<span class="c1">-- 库管人员
</span><span class="c1"></span><span class="k">insert</span> <span class="k">into</span> <span class="n">roles_permissions</span><span class="p">(</span><span class="n">role_name</span><span class="p">,</span><span class="n">permission</span><span class="p">)</span> <span class="k">values</span><span class="p">(</span><span class="s2">&#34;cmanager&#34;</span><span class="p">,</span><span class="s2">&#34;sys:c:save&#34;</span><span class="p">);</span>		
<span class="k">insert</span> <span class="k">into</span> <span class="n">roles_permissions</span><span class="p">(</span><span class="n">role_name</span><span class="p">,</span><span class="n">permission</span><span class="p">)</span> <span class="k">values</span><span class="p">(</span><span class="s2">&#34;cmanager&#34;</span><span class="p">,</span><span class="s2">&#34;sys:c:delete&#34;</span><span class="p">);</span>
<span class="k">insert</span> <span class="k">into</span> <span class="n">roles_permissions</span><span class="p">(</span><span class="n">role_name</span><span class="p">,</span><span class="n">permission</span><span class="p">)</span> <span class="k">values</span><span class="p">(</span><span class="s2">&#34;cmanager&#34;</span><span class="p">,</span><span class="s2">&#34;sys:c:update&#34;</span><span class="p">);</span>
<span class="k">insert</span> <span class="k">into</span> <span class="n">roles_permissions</span><span class="p">(</span><span class="n">role_name</span><span class="p">,</span><span class="n">permission</span><span class="p">)</span> <span class="k">values</span><span class="p">(</span><span class="s2">&#34;cmanager&#34;</span><span class="p">,</span><span class="s2">&#34;sys:c:find&#34;</span><span class="p">);</span>
<span class="c1">-- 销售人员
</span><span class="c1"></span><span class="k">insert</span> <span class="k">into</span> <span class="n">roles_permissions</span><span class="p">(</span><span class="n">role_name</span><span class="p">,</span><span class="n">permission</span><span class="p">)</span> <span class="k">values</span><span class="p">(</span><span class="s2">&#34;xmanager&#34;</span><span class="p">,</span><span class="s2">&#34;sys:c:find&#34;</span><span class="p">);</span>
<span class="k">insert</span> <span class="k">into</span> <span class="n">roles_permissions</span><span class="p">(</span><span class="n">role_name</span><span class="p">,</span><span class="n">permission</span><span class="p">)</span> <span class="k">values</span><span class="p">(</span><span class="s2">&#34;xmanager&#34;</span><span class="p">,</span><span class="s2">&#34;sys:x:save&#34;</span><span class="p">);</span>
<span class="k">insert</span> <span class="k">into</span> <span class="n">roles_permissions</span><span class="p">(</span><span class="n">role_name</span><span class="p">,</span><span class="n">permission</span><span class="p">)</span> <span class="k">values</span><span class="p">(</span><span class="s2">&#34;xmanager&#34;</span><span class="p">,</span><span class="s2">&#34;sys:x:delete&#34;</span><span class="p">);</span>
<span class="k">insert</span> <span class="k">into</span> <span class="n">roles_permissions</span><span class="p">(</span><span class="n">role_name</span><span class="p">,</span><span class="n">permission</span><span class="p">)</span> <span class="k">values</span><span class="p">(</span><span class="s2">&#34;xmanager&#34;</span><span class="p">,</span><span class="s2">&#34;sys:x:update&#34;</span><span class="p">);</span>
<span class="k">insert</span> <span class="k">into</span> <span class="n">roles_permissions</span><span class="p">(</span><span class="n">role_name</span><span class="p">,</span><span class="n">permission</span><span class="p">)</span> <span class="k">values</span><span class="p">(</span><span class="s2">&#34;xmanager&#34;</span><span class="p">,</span><span class="s2">&#34;sys:x:find&#34;</span><span class="p">);</span>
  
<span class="k">insert</span> <span class="k">into</span> <span class="n">roles_permissions</span><span class="p">(</span><span class="n">role_name</span><span class="p">,</span><span class="n">permission</span><span class="p">)</span> <span class="k">values</span><span class="p">(</span><span class="s2">&#34;xmanager&#34;</span><span class="p">,</span><span class="s2">&#34;sys:k:save&#34;</span><span class="p">);</span>
<span class="k">insert</span> <span class="k">into</span> <span class="n">roles_permissions</span><span class="p">(</span><span class="n">role_name</span><span class="p">,</span><span class="n">permission</span><span class="p">)</span> <span class="k">values</span><span class="p">(</span><span class="s2">&#34;xmanager&#34;</span><span class="p">,</span><span class="s2">&#34;sys:k:delete&#34;</span><span class="p">);</span>
<span class="k">insert</span> <span class="k">into</span> <span class="n">roles_permissions</span><span class="p">(</span><span class="n">role_name</span><span class="p">,</span><span class="n">permission</span><span class="p">)</span> <span class="k">values</span><span class="p">(</span><span class="s2">&#34;xmanager&#34;</span><span class="p">,</span><span class="s2">&#34;sys:k:update&#34;</span><span class="p">);</span>
<span class="k">insert</span> <span class="k">into</span> <span class="n">roles_permissions</span><span class="p">(</span><span class="n">role_name</span><span class="p">,</span><span class="n">permission</span><span class="p">)</span> <span class="k">values</span><span class="p">(</span><span class="s2">&#34;xmanager&#34;</span><span class="p">,</span><span class="s2">&#34;sys:k:find&#34;</span><span class="p">);</span>
<span class="c1">-- 客服人员
</span><span class="c1"></span><span class="k">insert</span> <span class="k">into</span> <span class="n">roles_permissions</span><span class="p">(</span><span class="n">role_name</span><span class="p">,</span><span class="n">permission</span><span class="p">)</span> <span class="k">values</span><span class="p">(</span><span class="s2">&#34;kmanager&#34;</span><span class="p">,</span><span class="s2">&#34;sys:k:find&#34;</span><span class="p">);</span>
<span class="k">insert</span> <span class="k">into</span> <span class="n">roles_permissions</span><span class="p">(</span><span class="n">role_name</span><span class="p">,</span><span class="n">permission</span><span class="p">)</span> <span class="k">values</span><span class="p">(</span><span class="s2">&#34;kmanager&#34;</span><span class="p">,</span><span class="s2">&#34;sys:k:update&#34;</span><span class="p">);</span>
<span class="c1">-- 新增人员
</span><span class="c1"></span><span class="k">insert</span> <span class="k">into</span> <span class="n">roles_permissions</span><span class="p">(</span><span class="n">role_name</span><span class="p">,</span><span class="n">permission</span><span class="p">)</span> <span class="k">values</span><span class="p">(</span><span class="s2">&#34;zmanager&#34;</span><span class="p">,</span><span class="s2">&#34;sys:*:find&#34;</span><span class="p">);</span>
</code></pre></div></li>
</ul>
<h3 id="83-springboot整合shiro">8.3 SpringBoot整合Shiro</h3>
<ul>
<li>
<p>创建SpringBoot应用</p>
</li>
<li>
<p>整合Druid和MyBatis</p>
</li>
<li>
<p>整合shiro</p>
<ul>
<li>
<p>添加依赖</p>
<div class="highlight"><pre class="chroma"><code class="language-xml" data-lang="xml"><span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>org.apache.shiro<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>shiro-spring<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;version&gt;</span>1.4.1<span class="nt">&lt;/version&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</code></pre></div></li>
<li>
<p>配置Shiro</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="nd">@Configuration</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ShiroConfig</span> <span class="o">{</span>
    
    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="n">JdbcRealm</span> <span class="nf">getJdbcRealm</span><span class="o">(</span><span class="n">DataSource</span> <span class="n">dataSource</span><span class="o">){</span>
        <span class="n">JdbcRealm</span> <span class="n">jdbcRealm</span> <span class="o">=</span> <span class="k">new</span> <span class="n">JdbcRealm</span><span class="o">();</span>
        <span class="c1">//JdbcRealm会自行从数据库查询用户及权限数据（数据库的表结构要符合JdbcRealm的规范）
</span><span class="c1"></span>        <span class="n">jdbcRealm</span><span class="o">.</span><span class="na">setDataSource</span><span class="o">(</span><span class="n">dataSource</span><span class="o">);</span>
        <span class="c1">//JdbcRealm默认开启认证功能，需要手动开启授权功能
</span><span class="c1"></span>        <span class="n">jdbcRealm</span><span class="o">.</span><span class="na">setPermissionsLookupEnabled</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">jdbcRealm</span><span class="o">;</span>
    <span class="o">}</span>
    
    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="n">DefaultWebSecurityManager</span> <span class="nf">getDefaultWebSecurityManager</span><span class="o">(</span><span class="n">JdbcRealm</span> <span class="n">jdbcRealm</span><span class="o">){</span>
        <span class="n">DefaultWebSecurityManager</span> <span class="n">securityManager</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DefaultWebSecurityManager</span><span class="o">();</span>
        <span class="n">securityManager</span><span class="o">.</span><span class="na">setRealm</span><span class="o">(</span><span class="n">jdbcRealm</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">securityManager</span><span class="o">;</span>
    <span class="o">}</span>
    
    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="n">ShiroFilterFactoryBean</span> <span class="nf">shiroFilter</span><span class="o">(</span><span class="n">DefaultWebSecurityManager</span> <span class="n">securityManager</span><span class="o">){</span>
        <span class="n">ShiroFilterFactoryBean</span> <span class="n">filter</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ShiroFilterFactoryBean</span><span class="o">();</span>
        <span class="c1">//过滤器就是shiro就行权限校验的核心，进行认证和授权是需要SecurityManager的
</span><span class="c1"></span>        <span class="n">filter</span><span class="o">.</span><span class="na">setSecurityManager</span><span class="o">(</span><span class="n">securityManager</span><span class="o">);</span>
    
        <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">filterMap</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;&gt;();</span>
        <span class="n">filterMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&#34;/&#34;</span><span class="o">,</span><span class="s">&#34;anon&#34;</span><span class="o">);</span>
        <span class="n">filterMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&#34;/login.html&#34;</span><span class="o">,</span><span class="s">&#34;anon&#34;</span><span class="o">);</span>
        <span class="n">filterMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&#34;/regist.html&#34;</span><span class="o">,</span><span class="s">&#34;anon&#34;</span><span class="o">);</span>
        <span class="n">filterMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&#34;/user/login&#34;</span><span class="o">,</span><span class="s">&#34;anon&#34;</span><span class="o">);</span>
        <span class="n">filterMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&#34;/user/regist&#34;</span><span class="o">,</span><span class="s">&#34;anon&#34;</span><span class="o">);</span>
        <span class="n">filterMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&#34;/static/**&#34;</span><span class="o">,</span><span class="s">&#34;anon&#34;</span><span class="o">);</span>
        <span class="n">filterMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&#34;/**&#34;</span><span class="o">,</span><span class="s">&#34;authc&#34;</span><span class="o">);</span>
    
        <span class="n">filter</span><span class="o">.</span><span class="na">setFilterChainDefinitionMap</span><span class="o">(</span><span class="n">filterMap</span><span class="o">);</span>
        <span class="n">filter</span><span class="o">.</span><span class="na">setLoginUrl</span><span class="o">(</span><span class="s">&#34;/login.html&#34;</span><span class="o">);</span>
        <span class="c1">//设置未授权访问的页面路径
</span><span class="c1"></span>        <span class="n">filter</span><span class="o">.</span><span class="na">setUnauthorizedUrl</span><span class="o">(</span><span class="s">&#34;/login.html&#34;</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">filter</span><span class="o">;</span>
    <span class="o">}</span>
    
<span class="o">}</span>
</code></pre></div></li>
</ul>
</li>
</ul>
<h2 id="九session管理">九、session管理</h2>
<blockquote>
<p>Shiro进行认证和授权是基于session实现的，Shiro包含了对session的管理</p>
</blockquote>
<ul>
<li>
<p>如果我们需要对session进行管理</p>
<ul>
<li>自定义session管理器</li>
<li>将自定义的session管理器设置给SecurityManager</li>
</ul>
</li>
<li>
<p>配置自定义SessionManager：ShiroConfig.java</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="nd">@Bean</span>
<span class="kd">public</span> <span class="n">DefaultWebSessionManager</span> <span class="nf">getDefaultWebSessionManager</span><span class="o">(){</span>
    <span class="n">DefaultWebSessionManager</span> <span class="n">sessionManager</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DefaultWebSessionManager</span><span class="o">();</span>
    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;----------&#34;</span><span class="o">+</span><span class="n">sessionManager</span><span class="o">.</span><span class="na">getGlobalSessionTimeout</span><span class="o">());</span> <span class="c1">// 1800000
</span><span class="c1"></span>    <span class="c1">//配置sessionManager
</span><span class="c1"></span>    <span class="n">sessionManager</span><span class="o">.</span><span class="na">setGlobalSessionTimeout</span><span class="o">(</span><span class="n">5</span><span class="o">*</span><span class="n">60</span><span class="o">*</span><span class="n">1000</span><span class="o">);</span>
    <span class="k">return</span> <span class="n">sessionManager</span><span class="o">;</span>
<span class="o">}</span>
  
<span class="nd">@Bean</span>
<span class="kd">public</span> <span class="n">DefaultWebSecurityManager</span> <span class="nf">getDefaultWebSecurityManager</span><span class="o">(</span><span class="n">MyRealm</span> <span class="n">myRealm</span><span class="o">){</span>
    <span class="n">DefaultWebSecurityManager</span> <span class="n">securityManager</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DefaultWebSecurityManager</span><span class="o">();</span>
    <span class="n">securityManager</span><span class="o">.</span><span class="na">setRealm</span><span class="o">(</span><span class="n">myRealm</span><span class="o">);</span>
    <span class="n">securityManager</span><span class="o">.</span><span class="na">setCacheManager</span><span class="o">(</span><span class="n">getEhCacheManager</span><span class="o">());</span>
    <span class="n">securityManager</span><span class="o">.</span><span class="na">setSessionManager</span><span class="o">(</span><span class="n">getDefaultWebSessionManager</span><span class="o">());</span>
    <span class="k">return</span> <span class="n">securityManager</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></li>
</ul>
<h2 id="十rememberme">十、RememberMe</h2>
<blockquote>
<p>将用户对页面访问的权限分为三个级别：</p>
<ul>
<li>未认证—可访问的页面—(陌生人)—问候</li>
<li>login.html、regist.html</li>
<li>记住我—可访问的页面—(前女友)—朋友间的拥抱</li>
<li>info.html</li>
<li>已认证—可访问的页面—(现女友)—牵手</li>
<li>转账.html</li>
</ul>
</blockquote>
<h4 id="21-在过滤器中设置记住我可访问的url">2.1 在过滤器中设置“记住我”可访问的url</h4>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="c1">// anon     表示未认证可访问的url
</span><span class="c1">// user     表示记住我可访问的url（已认证也可以访问）
</span><span class="c1">//authc     表示已认证可访问的url
</span><span class="c1">//perms		表示必须具备指定的权限才可访问
</span><span class="c1">//logout	表示指定退出的url
</span><span class="c1"></span><span class="n">filterMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&#34;/&#34;</span><span class="o">,</span><span class="s">&#34;anon&#34;</span><span class="o">);</span>
<span class="n">filterMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&#34;/index.html&#34;</span><span class="o">,</span><span class="s">&#34;user&#34;</span><span class="o">);</span>
<span class="n">filterMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&#34;/login.html&#34;</span><span class="o">,</span><span class="s">&#34;anon&#34;</span><span class="o">);</span>
<span class="n">filterMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&#34;/regist.html&#34;</span><span class="o">,</span><span class="s">&#34;anon&#34;</span><span class="o">);</span>
<span class="n">filterMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&#34;/user/login&#34;</span><span class="o">,</span><span class="s">&#34;anon&#34;</span><span class="o">);</span>
<span class="n">filterMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&#34;/user/regist&#34;</span><span class="o">,</span><span class="s">&#34;anon&#34;</span><span class="o">);</span>
<span class="n">filterMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&#34;/layui/**&#34;</span><span class="o">,</span><span class="s">&#34;anon&#34;</span><span class="o">);</span>
<span class="n">filterMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&#34;/**&#34;</span><span class="o">,</span><span class="s">&#34;authc&#34;</span><span class="o">);</span>
<span class="n">filterMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&#34;/c_add.html&#34;</span><span class="o">,</span><span class="s">&#34;perms[sys:c:save]&#34;</span><span class="o">);</span>
<span class="n">filterMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&#34;/exit&#34;</span><span class="o">,</span><span class="s">&#34;logout&#34;</span><span class="o">);</span>
</code></pre></div><h4 id="22--在shiroconfigjava中配置基于cookie的rememberme管理器">2.2  在ShiroConfig.java中配置基于cookie的rememberMe管理器</h4>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="nd">@Bean</span>
<span class="kd">public</span> <span class="n">CookieRememberMeManager</span> <span class="nf">cookieRememberMeManager</span><span class="o">(){</span>
    <span class="n">CookieRememberMeManager</span> <span class="n">rememberMeManager</span> <span class="o">=</span> <span class="k">new</span> <span class="n">CookieRememberMeManager</span><span class="o">();</span>
   
    <span class="c1">//cookie必须设置name
</span><span class="c1"></span>    <span class="n">SimpleCookie</span> <span class="n">cookie</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SimpleCookie</span><span class="o">(</span><span class="s">&#34;rememberMe&#34;</span><span class="o">);</span>
    <span class="n">cookie</span><span class="o">.</span><span class="na">setMaxAge</span><span class="o">(</span><span class="n">30</span><span class="o">*</span><span class="n">24</span><span class="o">*</span><span class="n">60</span><span class="o">*</span><span class="n">60</span><span class="o">);</span>
    
    <span class="n">rememberMeManager</span><span class="o">.</span><span class="na">setCookie</span><span class="o">(</span><span class="n">cookie</span><span class="o">);</span>
    <span class="k">return</span>  <span class="n">rememberMeManager</span><span class="o">;</span>
<span class="o">}</span>
<span class="nd">@Bean</span>
<span class="kd">public</span> <span class="n">DefaultWebSecurityManager</span> <span class="nf">getDefaultWebSecurityManager</span><span class="o">(</span><span class="n">MyRealm</span> <span class="n">myRealm</span><span class="o">){</span>
    <span class="n">DefaultWebSecurityManager</span> <span class="n">securityManager</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DefaultWebSecurityManager</span><span class="o">();</span>
    <span class="n">securityManager</span><span class="o">.</span><span class="na">setRealm</span><span class="o">(</span><span class="n">myRealm</span><span class="o">);</span>
    <span class="n">securityManager</span><span class="o">.</span><span class="na">setCacheManager</span><span class="o">(</span><span class="n">getEhCacheManager</span><span class="o">());</span>
    <span class="n">securityManager</span><span class="o">.</span><span class="na">setSessionManager</span><span class="o">(</span><span class="n">getDefaultWebSessionManager</span><span class="o">());</span>
    <span class="c1">//设置remember管理器
</span><span class="c1"></span>    <span class="n">securityManager</span><span class="o">.</span><span class="na">setRememberMeManager</span><span class="o">(</span><span class="n">cookieRememberMeManager</span><span class="o">());</span>
    <span class="k">return</span> <span class="n">securityManager</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div><h4 id="23-登录认证时设置token记住我">2.3 登录认证时设置token“记住我”</h4>
<ul>
<li>登录页面</li>
</ul>
<div class="highlight"><pre class="chroma"><code class="language-html" data-lang="html"><span class="p">&lt;</span><span class="nt">form</span> <span class="na">action</span><span class="o">=</span><span class="s">&#34;/user/login&#34;</span> <span class="na">method</span><span class="o">=</span><span class="s">&#34;post&#34;</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;</span>帐号:<span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">&#34;text&#34;</span> <span class="na">name</span><span class="o">=</span><span class="s">&#34;userName&#34;</span><span class="p">/&gt;&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;</span>密码:<span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">&#34;text&#34;</span> <span class="na">name</span><span class="o">=</span><span class="s">&#34;userPwd&#34;</span><span class="p">/&gt;&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;</span>记住我:<span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">&#34;checkbox&#34;</span> <span class="na">name</span><span class="o">=</span><span class="s">&#34;rememberMe&#34;</span><span class="p">/&gt;&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">&#34;submit&#34;</span> <span class="na">value</span><span class="o">=</span><span class="s">&#34;登录&#34;</span><span class="p">/&gt;&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">form</span><span class="p">&gt;</span>
</code></pre></div><ul>
<li>控制器</li>
</ul>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="nd">@Controller</span>
<span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">&#34;user&#34;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">UserController</span> <span class="o">{</span>

    <span class="nd">@Resource</span>
    <span class="kd">private</span> <span class="n">UserServiceImpl</span> <span class="n">userService</span><span class="o">;</span>

    <span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">&#34;login&#34;</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">login</span><span class="o">(</span><span class="n">String</span> <span class="n">userName</span><span class="o">,</span><span class="n">String</span> <span class="n">userPwd</span><span class="o">,</span><span class="kt">boolean</span> <span class="n">rememberMe</span><span class="o">){</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">userService</span><span class="o">.</span><span class="na">checkLogin</span><span class="o">(</span><span class="n">userName</span><span class="o">,</span><span class="n">userPwd</span><span class="o">,</span><span class="n">rememberMe</span><span class="o">);</span>
            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;------登录成功！&#34;</span><span class="o">);</span>
            <span class="k">return</span> <span class="s">&#34;index&#34;</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;------登录失败！&#34;</span><span class="o">);</span>
            <span class="k">return</span> <span class="s">&#34;login&#34;</span><span class="o">;</span>
        <span class="o">}</span>

    <span class="o">}</span>
    
    <span class="c1">//...
</span><span class="c1"></span><span class="o">}</span>
</code></pre></div><ul>
<li>service</li>
</ul>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="nd">@Service</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">UserServiceImpl</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">checkLogin</span><span class="o">(</span><span class="n">String</span> <span class="n">userName</span><span class="o">,</span> <span class="n">String</span> <span class="n">userPwd</span><span class="o">,</span><span class="kt">boolean</span> <span class="n">rememberMe</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="c1">//Shiro进行认证 ——入口
</span><span class="c1"></span>        <span class="n">Subject</span> <span class="n">subject</span> <span class="o">=</span> <span class="n">SecurityUtils</span><span class="o">.</span><span class="na">getSubject</span><span class="o">();</span>
        <span class="n">UsernamePasswordToken</span> <span class="n">token</span> <span class="o">=</span> <span class="k">new</span> <span class="n">UsernamePasswordToken</span><span class="o">(</span><span class="n">userName</span><span class="o">,</span><span class="n">userPwd</span><span class="o">);</span>
        <span class="n">token</span><span class="o">.</span><span class="na">setRememberMe</span><span class="o">(</span><span class="n">rememberMe</span><span class="o">);</span>
        <span class="n">subject</span><span class="o">.</span><span class="na">login</span><span class="o">(</span><span class="n">token</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div><h2 id="十一shiro多realm配置">十一、Shiro多Realm配置</h2>
<h3 id="111-使用场景">11.1 使用场景</h3>
<p>当shiro进行权限管理，数据来自于不同的数据源时，我们可以给SecurityManager配置多个Realm</p>
<p><img src="/shiro.assets/image-20210607225907320.png" alt="image-20210607225907320"></p>
<h3 id="112-多个realm的处理方式">11.2 多个Realm的处理方式</h3>
<h4 id="1121-链式处理">11.2.1 链式处理</h4>
<ul>
<li>多个Realm依次进行认证</li>
</ul>
<h4 id="1122-分支处理">11.2.2 分支处理</h4>
<ul>
<li>根据不同的条件从多个Realm中选择一个进行认证处理</li>
</ul>
<h3 id="113-多realm配置链式处理">11.3 多Realm配置（链式处理）</h3>
<ul>
<li>
<p>定义多个Realm</p>
<ul>
<li>
<p>UserRealm</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">UserRealm</span> <span class="kd">extends</span> <span class="n">AuthorizingRealm</span> <span class="o">{</span>
    
    <span class="n">Logger</span> <span class="n">logger</span> <span class="o">=</span> <span class="n">LoggerFactory</span><span class="o">.</span><span class="na">getLogger</span><span class="o">(</span><span class="n">UserRealm</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getName</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="s">&#34;UserRealm&#34;</span><span class="o">;</span>
    <span class="o">}</span>
    
    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="n">AuthorizationInfo</span> <span class="nf">doGetAuthorizationInfo</span><span class="o">(</span><span class="n">PrincipalCollection</span> <span class="n">principalCollection</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>
    
    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="n">AuthenticationInfo</span> <span class="nf">doGetAuthenticationInfo</span><span class="o">(</span><span class="n">AuthenticationToken</span> <span class="n">authenticationToken</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">AuthenticationException</span> <span class="o">{</span>
        <span class="n">logger</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">&#34;--------------------------------UserRealm&#34;</span><span class="o">);</span>
        <span class="c1">//从token中获取username
</span><span class="c1"></span>        <span class="n">UsernamePasswordToken</span> <span class="n">token</span> <span class="o">=</span> <span class="o">(</span><span class="n">UsernamePasswordToken</span><span class="o">)</span> <span class="n">authenticationToken</span><span class="o">;</span>
        <span class="n">String</span> <span class="n">username</span> <span class="o">=</span> <span class="n">token</span><span class="o">.</span><span class="na">getUsername</span><span class="o">();</span>
        <span class="c1">//根据username从users表中查询用户信息
</span><span class="c1"></span>    
        <span class="n">SimpleAuthenticationInfo</span> <span class="n">info</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SimpleAuthenticationInfo</span><span class="o">(</span><span class="n">username</span><span class="o">,</span><span class="s">&#34;123456&#34;</span><span class="o">,</span><span class="n">getName</span><span class="o">());</span>
        <span class="k">return</span> <span class="n">info</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></li>
<li>
<p>ManagerRealm</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ManagerRealm</span> <span class="kd">extends</span> <span class="n">AuthorizingRealm</span> <span class="o">{</span>
    
    <span class="n">Logger</span> <span class="n">logger</span> <span class="o">=</span> <span class="n">LoggerFactory</span><span class="o">.</span><span class="na">getLogger</span><span class="o">(</span><span class="n">ManagerRealm</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getName</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="s">&#34;ManagerRealm&#34;</span><span class="o">;</span>
    <span class="o">}</span>
    
    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="n">AuthorizationInfo</span> <span class="nf">doGetAuthorizationInfo</span><span class="o">(</span><span class="n">PrincipalCollection</span> <span class="n">principalCollection</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>
    
    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="n">AuthenticationInfo</span> <span class="nf">doGetAuthenticationInfo</span><span class="o">(</span><span class="n">AuthenticationToken</span> <span class="n">authenticationToken</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">AuthenticationException</span> <span class="o">{</span>
        <span class="n">logger</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">&#34;--------------------------------ManagerRealm&#34;</span><span class="o">);</span>
        <span class="c1">//从token中获取username
</span><span class="c1"></span>        <span class="n">UsernamePasswordToken</span> <span class="n">token</span> <span class="o">=</span> <span class="o">(</span><span class="n">UsernamePasswordToken</span><span class="o">)</span> <span class="n">authenticationToken</span><span class="o">;</span>
        <span class="n">String</span> <span class="n">username</span> <span class="o">=</span> <span class="n">token</span><span class="o">.</span><span class="na">getUsername</span><span class="o">();</span>
        <span class="c1">//根据username从吗managers表中查询用户信息
</span><span class="c1"></span>    
        <span class="n">SimpleAuthenticationInfo</span> <span class="n">info</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SimpleAuthenticationInfo</span><span class="o">(</span><span class="n">username</span><span class="o">,</span><span class="s">&#34;222222&#34;</span><span class="o">,</span><span class="n">getName</span><span class="o">());</span>
        <span class="k">return</span> <span class="n">info</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></li>
</ul>
</li>
<li>
<p>在ShiroConfig.java中为SecurityManager配置多个Realm</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="nd">@Configuration</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ShiroConfig</span> <span class="o">{</span>
  
    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="n">UserRealm</span> <span class="nf">userRealm</span><span class="o">(){</span>
        <span class="n">UserRealm</span> <span class="n">userRealm</span> <span class="o">=</span> <span class="k">new</span> <span class="n">UserRealm</span><span class="o">();</span>
        <span class="k">return</span>  <span class="n">userRealm</span><span class="o">;</span>
    <span class="o">}</span>
  
    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="n">ManagerRealm</span> <span class="nf">managerRealm</span><span class="o">(){</span>
        <span class="n">ManagerRealm</span> <span class="n">managerRealm</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ManagerRealm</span><span class="o">();</span>
        <span class="k">return</span> <span class="n">managerRealm</span><span class="o">;</span>
    <span class="o">}</span>
  
    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="n">DefaultWebSecurityManager</span> <span class="nf">getDefaultWebSecurityManager</span><span class="o">(){</span>
        <span class="n">DefaultWebSecurityManager</span> <span class="n">securityManager</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DefaultWebSecurityManager</span><span class="o">();</span>
          
        <span class="c1">//securityManager中配置多个realm
</span><span class="c1"></span>        <span class="n">Collection</span><span class="o">&lt;</span><span class="n">Realm</span><span class="o">&gt;</span> <span class="n">realms</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;();</span>
        <span class="n">realms</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">userRealm</span><span class="o">());</span>
        <span class="n">realms</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">managerRealm</span><span class="o">());</span>
  
        <span class="n">securityManager</span><span class="o">.</span><span class="na">setRealms</span><span class="o">(</span><span class="n">realms</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">securityManager</span><span class="o">;</span>
    <span class="o">}</span>
   <span class="c1">//...
</span><span class="c1"></span><span class="o">}</span>
</code></pre></div></li>
<li>
<p>测试代码：</p>
<ul>
<li>
<p>login.html</p>
<div class="highlight"><pre class="chroma"><code class="language-html" data-lang="html"><span class="p">&lt;</span><span class="nt">form</span> <span class="na">action</span><span class="o">=</span><span class="s">&#34;user/login&#34;</span> <span class="na">method</span><span class="o">=</span><span class="s">&#34;post&#34;</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;</span>帐号：<span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">&#34;text&#34;</span> <span class="na">name</span><span class="o">=</span><span class="s">&#34;userName&#34;</span><span class="p">/&gt;&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;</span>密码：<span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">&#34;text&#34;</span> <span class="na">name</span><span class="o">=</span><span class="s">&#34;userPwd&#34;</span><span class="p">/&gt;&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">&#34;radio&#34;</span> <span class="na">name</span><span class="o">=</span><span class="s">&#34;loginType&#34;</span> <span class="na">value</span><span class="o">=</span><span class="s">&#34;User&#34;</span><span class="p">/&gt;</span>普通用户
        <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">&#34;radio&#34;</span> <span class="na">name</span><span class="o">=</span><span class="s">&#34;loginType&#34;</span> <span class="na">value</span><span class="o">=</span><span class="s">&#34;Manager&#34;</span><span class="p">/&gt;</span>管理员<span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
    
    <span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">&#34;submit&#34;</span> <span class="na">value</span><span class="o">=</span><span class="s">&#34;登录&#34;</span><span class="p">/&gt;&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">form</span><span class="p">&gt;</span>
</code></pre></div></li>
<li>
<p>UserController.java</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="nd">@Controller</span>
<span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">&#34;user&#34;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">UserController</span> <span class="o">{</span>
    <span class="n">Logger</span> <span class="n">logger</span> <span class="o">=</span> <span class="n">LoggerFactory</span><span class="o">.</span><span class="na">getLogger</span><span class="o">(</span><span class="n">UserController</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    
    <span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">&#34;login&#34;</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">login</span><span class="o">(</span><span class="n">String</span> <span class="n">userName</span><span class="o">,</span><span class="n">String</span> <span class="n">userPwd</span><span class="o">,</span> <span class="n">String</span> <span class="n">loginType</span><span class="o">){</span>
        <span class="n">logger</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">&#34;~~~~~~~~~~~~~UserController-login&#34;</span><span class="o">);</span>
        <span class="k">try</span><span class="o">{</span>
            <span class="n">UsernamePasswordToken</span> <span class="n">token</span> <span class="o">=</span> <span class="k">new</span> <span class="n">UsernamePasswordToken</span><span class="o">(</span><span class="n">userName</span><span class="o">,</span><span class="n">userPwd</span><span class="o">);</span>
            <span class="n">Subject</span> <span class="n">subject</span> <span class="o">=</span> <span class="n">SecurityUtils</span><span class="o">.</span><span class="na">getSubject</span><span class="o">();</span>
            <span class="n">subject</span><span class="o">.</span><span class="na">login</span><span class="o">(</span><span class="n">token</span><span class="o">);</span>
            <span class="k">return</span> <span class="s">&#34;index&#34;</span><span class="o">;</span>
        <span class="o">}</span><span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">){</span>
            <span class="k">return</span> <span class="s">&#34;login&#34;</span><span class="o">;</span>
        <span class="o">}</span>
    
    <span class="o">}</span>
    
<span class="o">}</span>
</code></pre></div></li>
</ul>
</li>
</ul>
<h3 id="114-shiro认证处理源码分析">11.4 Shiro认证处理源码分析</h3>
<p><img src="/shiro.assets/image-20210607230233631.png" alt="image-20210607230233631"></p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">protected</span> <span class="n">AuthenticationInfo</span> <span class="nf">doAuthenticate</span><span class="o">(</span><span class="n">AuthenticationToken</span> <span class="n">authenticationToken</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">AuthenticationException</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">assertRealmsConfigured</span><span class="o">();</span>
    <span class="n">Collection</span><span class="o">&lt;</span><span class="n">Realm</span><span class="o">&gt;</span> <span class="n">realms</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">getRealms</span><span class="o">();</span>

    <span class="c1">// this.doMultiRealmAuthentication(realms, authenticationToken);中的realms参数就是认证会执行的Realm
</span><span class="c1"></span>    <span class="k">return</span> <span class="n">realms</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">==</span> <span class="n">1</span> <span class="o">?</span> <span class="k">this</span><span class="o">.</span><span class="na">doSingleRealmAuthentication</span><span class="o">((</span><span class="n">Realm</span><span class="o">)</span><span class="n">realms</span><span class="o">.</span><span class="na">iterator</span><span class="o">().</span><span class="na">next</span><span class="o">(),</span> <span class="n">authenticationToken</span><span class="o">)</span> <span class="o">:</span> <span class="k">this</span><span class="o">.</span><span class="na">doMultiRealmAuthentication</span><span class="o">(</span><span class="n">realms</span><span class="o">,</span> <span class="n">authenticationToken</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div><h3 id="115-多realm配置分支处理">11.5 多Realm配置（分支处理）</h3>
<blockquote>
<p>根据不同的条件执行不同的Realm</p>
</blockquote>
<ul>
<li>
<p>流程分析</p>
<p><img src="/shiro.assets/image-20210607230307002.png" alt="image-20210607230307002"></p>
</li>
<li>
<p>实现案例：用户不同身份登录执行不同的Realm</p>
<ul>
<li>
<p>自定义Realm(UserRealm\ManagerRealm)</p>
<ul>
<li>当在登录页面选择“普通用户”登录，则执行UserRealm的认证</li>
<li>当在登录页面选择“管理员”登录，则执行ManagerRealm的认证</li>
</ul>
</li>
<li>
<p>Realm的声明及配置</p>
</li>
<li>
<p>自定义Token</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MyToken</span> <span class="kd">extends</span> <span class="n">UsernamePasswordToken</span> <span class="o">{</span>
    
    <span class="kd">private</span> <span class="n">String</span> <span class="n">loginType</span><span class="o">;</span>
    
    <span class="kd">public</span> <span class="nf">MyToken</span><span class="o">(</span><span class="n">String</span> <span class="n">userName</span><span class="o">,</span><span class="n">String</span> <span class="n">userPwd</span><span class="o">,</span> <span class="n">String</span> <span class="n">loginType</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">(</span><span class="n">userName</span><span class="o">,</span><span class="n">userPwd</span><span class="o">);</span>
        <span class="k">this</span><span class="o">.</span><span class="na">loginType</span> <span class="o">=</span> <span class="n">loginType</span><span class="o">;</span>
    <span class="o">}</span>
    
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getLoginType</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">loginType</span><span class="o">;</span>
    <span class="o">}</span>
    
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setLoginType</span><span class="o">(</span><span class="n">String</span> <span class="n">loginType</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">loginType</span> <span class="o">=</span> <span class="n">loginType</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></li>
<li>
<p>自定义认证器</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MyModularRealmAuthenticator</span> <span class="kd">extends</span> <span class="n">ModularRealmAuthenticator</span> <span class="o">{</span>
    
    <span class="n">Logger</span> <span class="n">logger</span> <span class="o">=</span> <span class="n">LoggerFactory</span><span class="o">.</span><span class="na">getLogger</span><span class="o">(</span><span class="n">MyModularRealmAuthenticator</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    
    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="n">AuthenticationInfo</span> <span class="nf">doAuthenticate</span><span class="o">(</span><span class="n">AuthenticationToken</span> <span class="n">authenticationToken</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">AuthenticationException</span> <span class="o">{</span>
        <span class="n">logger</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">&#34;------------------------------MyModularRealmAuthenticator&#34;</span><span class="o">);</span>
    
        <span class="k">this</span><span class="o">.</span><span class="na">assertRealmsConfigured</span><span class="o">();</span>
        <span class="n">Collection</span><span class="o">&lt;</span><span class="n">Realm</span><span class="o">&gt;</span> <span class="n">realms</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">getRealms</span><span class="o">();</span>
    
        <span class="n">MyToken</span> <span class="n">token</span> <span class="o">=</span> <span class="o">(</span><span class="n">MyToken</span><span class="o">)</span> <span class="n">authenticationToken</span><span class="o">;</span>
        <span class="n">String</span> <span class="n">loginType</span> <span class="o">=</span> <span class="n">token</span><span class="o">.</span><span class="na">getLoginType</span><span class="o">();</span> <span class="c1">// User
</span><span class="c1"></span>        <span class="n">logger</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">&#34;------------------------------loginType:&#34;</span><span class="o">+</span><span class="n">loginType</span><span class="o">);</span>
    
        <span class="n">Collection</span><span class="o">&lt;</span><span class="n">Realm</span><span class="o">&gt;</span> <span class="n">typeRealms</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;();</span>
        <span class="k">for</span><span class="o">(</span><span class="n">Realm</span> <span class="n">realm</span><span class="o">:</span><span class="n">realms</span><span class="o">){</span>
            <span class="k">if</span><span class="o">(</span><span class="n">realm</span><span class="o">.</span><span class="na">getName</span><span class="o">().</span><span class="na">startsWith</span><span class="o">(</span><span class="n">loginType</span><span class="o">)){</span>  <span class="c1">//UserRealm
</span><span class="c1"></span>                <span class="n">typeRealms</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">realm</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
    
       <span class="k">if</span><span class="o">(</span><span class="n">typeRealms</span><span class="o">.</span><span class="na">size</span><span class="o">()==</span><span class="n">1</span><span class="o">){</span>
           <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">doSingleRealmAuthentication</span><span class="o">((</span><span class="n">Realm</span><span class="o">)</span><span class="n">typeRealms</span><span class="o">.</span><span class="na">iterator</span><span class="o">().</span><span class="na">next</span><span class="o">(),</span> <span class="n">authenticationToken</span><span class="o">);</span>
       <span class="o">}</span><span class="k">else</span><span class="o">{</span>
           <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">doMultiRealmAuthentication</span><span class="o">(</span><span class="n">typeRealms</span><span class="o">,</span> <span class="n">authenticationToken</span><span class="o">);</span>
       <span class="o">}</span>
    
    <span class="o">}</span>
    
<span class="o">}</span>
</code></pre></div></li>
<li>
<p>配置自定义认证器</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="nd">@Configuration</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ShiroConfig</span> <span class="o">{</span>
    
    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="n">UserRealm</span> <span class="nf">userRealm</span><span class="o">(){</span>
        <span class="n">UserRealm</span> <span class="n">userRealm</span> <span class="o">=</span> <span class="k">new</span> <span class="n">UserRealm</span><span class="o">();</span>
        <span class="k">return</span>  <span class="n">userRealm</span><span class="o">;</span>
    <span class="o">}</span>
    
    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="n">ManagerRealm</span> <span class="nf">managerRealm</span><span class="o">(){</span>
        <span class="n">ManagerRealm</span> <span class="n">managerRealm</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ManagerRealm</span><span class="o">();</span>
        <span class="k">return</span> <span class="n">managerRealm</span><span class="o">;</span>
    <span class="o">}</span>
    
    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="n">MyModularRealmAuthenticator</span> <span class="nf">myModularRealmAuthenticator</span><span class="o">(){</span>
        <span class="n">MyModularRealmAuthenticator</span> <span class="n">myModularRealmAuthenticator</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MyModularRealmAuthenticator</span><span class="o">();</span>
        <span class="k">return</span> <span class="n">myModularRealmAuthenticator</span><span class="o">;</span>
    <span class="o">}</span>
    
    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="n">DefaultWebSecurityManager</span> <span class="nf">getDefaultWebSecurityManager</span><span class="o">(){</span>
        <span class="n">DefaultWebSecurityManager</span> <span class="n">securityManager</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DefaultWebSecurityManager</span><span class="o">();</span>
        <span class="c1">//配置自定义认证器(放在realms设置之前)
</span><span class="c1"></span>        <span class="n">securityManager</span><span class="o">.</span><span class="na">setAuthenticator</span><span class="o">(</span><span class="n">myModularRealmAuthenticator</span><span class="o">());</span>
    
        <span class="c1">//securityManager中配置多个realm
</span><span class="c1"></span>        <span class="n">Collection</span><span class="o">&lt;</span><span class="n">Realm</span><span class="o">&gt;</span> <span class="n">realms</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;();</span>
        <span class="n">realms</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">userRealm</span><span class="o">());</span>
        <span class="n">realms</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">managerRealm</span><span class="o">());</span>
    
        <span class="n">securityManager</span><span class="o">.</span><span class="na">setRealms</span><span class="o">(</span><span class="n">realms</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">securityManager</span><span class="o">;</span>
    <span class="o">}</span>
    
    <span class="c1">//...
</span><span class="c1"></span>    
<span class="o">}</span>
</code></pre></div></li>
<li>
<p>测试：控制器接受数据进行认证</p>
<ul>
<li>login.html</li>
</ul>
<div class="highlight"><pre class="chroma"><code class="language-html" data-lang="html"><span class="p">&lt;</span><span class="nt">form</span> <span class="na">action</span><span class="o">=</span><span class="s">&#34;user/login&#34;</span> <span class="na">method</span><span class="o">=</span><span class="s">&#34;post&#34;</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;</span>帐号：<span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">&#34;text&#34;</span> <span class="na">name</span><span class="o">=</span><span class="s">&#34;userName&#34;</span><span class="p">/&gt;&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;</span>密码：<span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">&#34;text&#34;</span> <span class="na">name</span><span class="o">=</span><span class="s">&#34;userPwd&#34;</span><span class="p">/&gt;&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">&#34;radio&#34;</span> <span class="na">name</span><span class="o">=</span><span class="s">&#34;loginType&#34;</span> <span class="na">value</span><span class="o">=</span><span class="s">&#34;User&#34;</span> <span class="na">checked</span><span class="p">/&gt;</span>普通用户
    <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">&#34;radio&#34;</span> <span class="na">name</span><span class="o">=</span><span class="s">&#34;loginType&#34;</span> <span class="na">value</span><span class="o">=</span><span class="s">&#34;Manager&#34;</span><span class="p">/&gt;</span>管理员<span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
    
    <span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">&#34;submit&#34;</span> <span class="na">value</span><span class="o">=</span><span class="s">&#34;登录&#34;</span><span class="p">/&gt;&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">form</span><span class="p">&gt;</span>
</code></pre></div><ul>
<li>UserController.java</li>
</ul>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="nd">@Controller</span>
<span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">&#34;user&#34;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">UserController</span> <span class="o">{</span>
    <span class="n">Logger</span> <span class="n">logger</span> <span class="o">=</span> <span class="n">LoggerFactory</span><span class="o">.</span><span class="na">getLogger</span><span class="o">(</span><span class="n">UserController</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    
    <span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">&#34;login&#34;</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">login</span><span class="o">(</span><span class="n">String</span> <span class="n">userName</span><span class="o">,</span><span class="n">String</span> <span class="n">userPwd</span><span class="o">,</span> <span class="n">String</span> <span class="n">loginType</span><span class="o">){</span>
        <span class="n">logger</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">&#34;~~~~~~~~~~~~~UserController-login&#34;</span><span class="o">);</span>
        <span class="k">try</span><span class="o">{</span>
            <span class="c1">//UsernamePasswordToken token = new UsernamePasswordToken(userName,userPwd);
</span><span class="c1"></span>            <span class="n">MyToken</span> <span class="n">token</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MyToken</span><span class="o">(</span><span class="n">userName</span><span class="o">,</span><span class="n">userPwd</span><span class="o">,</span><span class="n">loginType</span><span class="o">);</span>
            <span class="n">Subject</span> <span class="n">subject</span> <span class="o">=</span> <span class="n">SecurityUtils</span><span class="o">.</span><span class="na">getSubject</span><span class="o">();</span>
            <span class="n">subject</span><span class="o">.</span><span class="na">login</span><span class="o">(</span><span class="n">token</span><span class="o">);</span>
            <span class="k">return</span> <span class="s">&#34;index&#34;</span><span class="o">;</span>
        <span class="o">}</span><span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">){</span>
            <span class="k">return</span> <span class="s">&#34;login&#34;</span><span class="o">;</span>
        <span class="o">}</span>
    
    <span class="o">}</span>
    
<span class="o">}</span>
</code></pre></div></li>
</ul>
</li>
</ul>
  </section>

  <section>
    
      
    
  </section>
</article>

      </div>

      <div id="side" class="pr-1 bg-white">
        <aside class="pr-3">
          
  
    <div id="toc" class="Box Box--blue mb-3">
      <b>Shiro</b><nav id="TableOfContents">
  <ul>
    <li><a href="#一权限的管理">一、权限的管理</a>
      <ul>
        <li><a href="#11-什么是权限管理">1.1 什么是权限管理</a></li>
        <li><a href="#12-什么是身份认证">1.2 什么是身份认证</a></li>
        <li><a href="#13-什么是授权">1.3 什么是授权</a></li>
      </ul>
    </li>
    <li><a href="#二什么是shiro">二、什么是shiro</a></li>
    <li><a href="#三shiro的核心架构">三、shiro的核心架构</a>
      <ul>
        <li><a href="#31-subject">3.1 Subject</a></li>
        <li><a href="#32-securitymanager">3.2 SecurityManager</a></li>
        <li><a href="#33-authenticator">3.3 Authenticator</a></li>
        <li><a href="#34-authorizer">3.4 Authorizer</a></li>
        <li><a href="#35-realm">3.5 Realm</a></li>
        <li><a href="#36-sessionmanager">3.6 SessionManager</a></li>
        <li><a href="#37-sessiondao">3.7 SessionDAO</a></li>
        <li><a href="#38-cachemanager">3.8 CacheManager</a></li>
        <li><a href="#39-cryptography">3.9 Cryptography</a></li>
      </ul>
    </li>
    <li><a href="#四shiro中的认证">四、shiro中的认证</a>
      <ul>
        <li><a href="#41-认证">4.1 认证</a></li>
        <li><a href="#42-shiro中认证的关键对象">4.2 shiro中认证的关键对象</a></li>
        <li><a href="#43-认证流程">4.3 认证流程</a></li>
        <li><a href="#44-认证的开发">4.4 认证的开发</a></li>
        <li><a href="#45-自定义realm">4.5 自定义Realm</a></li>
        <li><a href="#46-使用md5salthash">4.6 使用MD5+Salt+Hash</a></li>
      </ul>
    </li>
    <li><a href="#五shiro中的授权">五、shiro中的授权</a>
      <ul>
        <li><a href="#51-授权">5.1 授权</a></li>
        <li><a href="#52-关键对象">5.2 关键对象</a></li>
        <li><a href="#53-授权流程">5.3 授权流程</a></li>
        <li><a href="#54-授权方式">5.4 授权方式</a></li>
        <li><a href="#55-权限字符串">5.5 权限字符串</a></li>
        <li><a href="#56-shiro中授权编程实现方式">5.6 shiro中授权编程实现方式</a></li>
        <li><a href="#57-开发授权">5.7 开发授权</a></li>
      </ul>
    </li>
    <li><a href="#六整合springboot项目实战">六、整合SpringBoot项目实战</a>
      <ul>
        <li><a href="#61-整合思路">6.1 整合思路</a></li>
        <li><a href="#62-配置环境">6.2 配置环境</a></li>
        <li><a href="#63-简单使用">6.3 简单使用</a></li>
        <li><a href="#64-常见过滤器">6.4 常见过滤器</a></li>
        <li><a href="#65-认证和退出实现">6.5 认证和退出实现</a></li>
        <li><a href="#67-md5salt的认证实现">6.7 MD5、Salt的认证实现</a></li>
        <li><a href="#68-授权实现">6.8 授权实现</a></li>
        <li><a href="#69-使用cachemanager">6.9 使用CacheManager</a></li>
      </ul>
    </li>
    <li><a href="#七shiro整合springboot之thymeleaf权限控制">七、Shiro整合springboot之thymeleaf权限控制</a>
      <ul>
        <li><a href="#1引入扩展依赖">1.引入扩展依赖</a></li>
        <li><a href="#2页面中引入命名空间">2.页面中引入命名空间</a></li>
        <li><a href="#3常见权限控制标签使用">3.常见权限控制标签使用</a></li>
        <li><a href="#4加入shiro的方言配置">4.加入shiro的方言配置</a></li>
      </ul>
    </li>
    <li><a href="#八springboot应用整合shiro案例jdbcrealm">八、SpringBoot应用整合Shiro—案例（JdbcRealm）</a>
      <ul>
        <li><a href="#81-jdbcrealm介绍">8.1 JdbcRealm介绍</a></li>
        <li><a href="#82-jdbcrealm规定的表结构">8.2 JdbcRealm规定的表结构</a></li>
        <li><a href="#83-springboot整合shiro">8.3 SpringBoot整合Shiro</a></li>
      </ul>
    </li>
    <li><a href="#九session管理">九、session管理</a></li>
    <li><a href="#十rememberme">十、RememberMe</a>
      <ul>
        <li></li>
      </ul>
    </li>
    <li><a href="#十一shiro多realm配置">十一、Shiro多Realm配置</a>
      <ul>
        <li><a href="#111-使用场景">11.1 使用场景</a></li>
        <li><a href="#112-多个realm的处理方式">11.2 多个Realm的处理方式</a></li>
        <li><a href="#113-多realm配置链式处理">11.3 多Realm配置（链式处理）</a></li>
        <li><a href="#114-shiro认证处理源码分析">11.4 Shiro认证处理源码分析</a></li>
        <li><a href="#115-多realm配置分支处理">11.5 多Realm配置（分支处理）</a></li>
      </ul>
    </li>
  </ul>
</nav></div>
  

  
    <div>
      
    </div>
  

        </aside>
      </div>

      <div id="footer" class="pt-2 pb-3 bg-white text-center">
        

  <span class="text-small text-gray">
    ©QYF Just for record 2018-2021 &middot; 

    Powered by the
    <a href="https://github.com/qqhann/hugo-primer" class="link-gray-dark">Hugo-Primer</a> theme for
    <a href="https://gohugo.io" class="link-gray-dark">Hugo</a>.
  </span>


      </div>
    </div>

    
    
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/x-mathjax-config">MathJax.Hub.Config({ tex2jax: { inlineMath: [['$','$'], ['\\(','\\)']] } });</script>
    
  </body>
</html>
